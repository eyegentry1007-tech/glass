<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì•„ì´ì  íŠ¸ë¦¬ ì¶©ë‚¨ë„ì²­ì  V1.1 MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; --sale: #d63031; }
        body { font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; overflow-x: hidden; }
        
        .app-container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); overflow: hidden; min-height: 95vh; }
        
        header { background: #2c3e50; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid var(--accent); }
        .logo-area h2 { margin: 0; font-size: 1.6em; letter-spacing: -1px; }
        .top-controls { display: flex; gap: 12px; align-items: center; }
        
        .btn-ui { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 0.95em; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 6px; }
        .btn-ui:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); filter: brightness(1.1); }
        
        .btn-admin-gear { background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1.4em; transition: 0.3s; }
        .btn-admin-gear:hover { transform: rotate(90deg); background: var(--accent); }

        .filter-off .disabled-row { opacity: 1 !important; filter: none !important; pointer-events: auto !important; }
        .disabled-row { opacity: 0.15; filter: grayscale(1); pointer-events: none; transition: 0.3s; }
        
        .power-box-btn { background: white; color: #2c3e50; padding: 8px 15px; border-radius: 8px; font-weight: 900; font-size: 1.1em; cursor: pointer; min-width: 80px; text-align: center; border: 2px solid #ddd; }
        .label-text { font-size: 0.75em; color: rgba(255,255,255,0.8); margin-bottom: 3px; text-align: center; font-weight: bold; }
        .control-group { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 12px; }

        #picker-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9000; justify-content:center; align-items:center; }
        .picker-container { background:white; padding:35px; border-radius:30px; width:92%; max-width:1100px; max-height:85vh; overflow-y:auto; }
        .picker-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap:12px; }
        .pick-btn { padding:22px 10px; border:1px solid #eee; border-radius:15px; font-weight:900; font-size:1.1em; cursor:pointer; background:#f8f9fa; transition:0.2s; text-align:center; color:#333; }
        .pick-btn:hover { background: #eef2f7; }
        .pick-btn.selected { background:var(--accent) !important; color:white !important; border-color:var(--accent); }
        .pick-btn.plus { color: #d63031; background: #fff5f5; }
        .pick-btn.minus { color: #0984e3; background: #f0f7ff; }

        .tabs-bar { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; overflow-x: auto; padding: 0 10px; }
        .tab { padding: 22px 30px; cursor: pointer; font-weight: 800; color: #888; white-space: nowrap; transition: 0.3s; position: relative; font-size: 1.05em; }
        .tab.active { color: var(--accent); }
        .tab.active::after { content:''; position:absolute; bottom:0; left:20%; right:20%; height:5px; background:var(--accent); border-radius:10px 10px 0 0; }
        .content-body { padding: 30px; min-height: 700px; }

        /* ë§¤íŠ¸ë¦­ìŠ¤ & ì¹´ë“œ */
        .matrix-container {
        grid-column: 1 / -1;   /* ì´ ì¤„ì„ ì¶”ê°€í•˜ë©´ ì¢Œìš°ë¡œ ê½‰ ì°¨ê²Œ ë©ë‹ˆë‹¤ */
        margin-bottom: 40px;   /* 40ì—ì„œ 10ìœ¼ë¡œ ì¤„ì—¬ì„œ ì•„ë˜ ê°„ê²©ì„ ì¢í™ë‹ˆë‹¤ */
        border-radius: 15px; 
        border: 1px solid #e0e0e0; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .matrix-title { padding: 10px 25px; font-size: 1.2em; font-weight: bold; color: white; }
        .matrix-table { width: 100%; border-collapse: collapse; text-align: center; }
        .matrix-table th { padding: 10px 15px; background: #fdfdfd; border-bottom: 2px solid #eee; }
        .idx-col { background: #f8f9fa; font-weight: bold; width: 85px; color: #666; font-size: 1.05em; border-right: 1px solid #eee; }
        .card-grid {
            display: grid !important; 
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); 
            row-gap: 5px !important;    /* â˜… ìœ„ì•„ë˜ ê°„ê²© (ì›í•˜ëŠ” ë§Œí¼ ìˆ«ìë¥¼ ë°”ê¾¸ì„¸ìš”) */
            column-gap: 25px !important; /* ì¢Œìš° ê°„ê²© */
            align-items: start;          /* ì¹´ë“œ ë†’ì´ê°€ ë‹¬ë¼ë„ ìœ„ìª½ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ */
        }
        .lens-card, .matrix-container {
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        
        .content-body {
            padding-top: 10px !important;    /* 30pxì—ì„œ 5pxë¡œ ê°•ì œ ì¶•ì†Œ */
            padding-bottom: 30px !important; /* í•˜ë‹¨ ì—¬ë°±ë„ í•¨ê»˜ ì¡°ì ˆ */
        }

        /* 2. ì¹´ë“œ ê·¸ë¦¬ë“œ ìì²´ì˜ ìƒë‹¨ ë§ˆì§„ ì œê±° */
        .card-grid {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* 3. (ê¸°ì¡´ ì½”ë“œ í™•ì¸) ì¹´ë“œë“¤ì˜ ìƒí•˜ ë§ˆì§„ ì™„ì „ ì œê±° */
        .lens-card, .matrix-container {
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }

        .lens-card { border-radius: 15px; background: white; border: 1px solid #eee; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .card-head { padding: 12px 18px; color: white; font-weight: 900; font-size: 1.15em; display: flex; justify-content: space-between; align-items: center; }
        .sale-badge { background: #fff; color: var(--sale); font-size: 0.75em; padding: 3px 8px; border-radius: 5px; font-weight: 900; }
        .lens-one-liner { padding: 8px 15px; background: #f0f7ff; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; color: #2c3e50; border-left: 5px solid var(--accent); margin: 5px 10px 8px 10px; border-radius: 4px; font-weight: 700; }

        /* --- ë‹¨ì´ˆì  ê°€ê²©í‘œ ì •ë ¬ ë° í­ ì¡°ì ˆ --- */
        .card-table { width: 100%; border-collapse: collapse; }

        /* êµ´ì ˆë¥ ê³¼ ì„¤ê³„ ì¹¸ì€ ì¤‘ì•™ ì •ë ¬ */
        .card-table th, .card-table td { 
            padding: 10px 5px !important; 
            text-align: center !important; 
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }

        /* ì œëª©(í—¤ë”) ë¶€ë¶„ë§Œ ë”°ë¡œ ê¸€ì í¬ê¸°ì™€ ë°°ê²½ìƒ‰ ìœ ì§€ */
        .card-table th { background: #f8f9fa; font-size: 0.75em; color: #888; }

        /* ë§ˆì§€ë§‰ 'ê°€ê²©' ì¹¸ë§Œ ì˜¤ë¥¸ìª½ ì •ë ¬ */
        .card-table th:last-child, .card-table td:last-child { 
            text-align: right !important; 
            padding-right: 15px !important; 
        }

        /* ì²« ë²ˆì§¸ 'êµ´ì ˆë¥ ' ì¹¸ í­ì„ ì¢ê²Œ ì¡°ì ˆ */
        .card-table th:nth-child(1), .card-table td:nth-child(1) { 
            width: 85px !important; 
        }
        /* ê´€ë¦¬ì íŒ¨ë„ */
        .admin-panel { display: none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:98%; height:94%; background:#f1f3f5; z-index:2000; padding:30px; border-radius:15px; overflow-y:auto; box-sizing:border-box; }
        .admin-section { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #dee2e6; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tag-row { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        .btn-small { padding: 6px 12px; font-size: 0.8em; cursor: pointer; border-radius: 6px; border: none; background: #95a5a6; color: white; font-weight: bold; }
        
        /* ë§¤íŠ¸ë¦­ìŠ¤ ì—ë””í„° */
        .matrix-editor-table { width:100%; border-collapse: collapse; background:white; }
        .matrix-editor-table th, .matrix-editor-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .me-input-group { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .me-input { width: 90%; padding: 6px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; text-align: center; }
        /* ë§¤íŠ¸ë¦­ìŠ¤ ì•„ì½”ë””ì–¸ ì „ìš© ìŠ¤íƒ€ì¼ */
        .matrix-list-item { background: #f8f9fa; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; overflow: hidden; transition: 0.2s; }
        .matrix-list-item:hover { border-color: var(--accent); }
        .matrix-item-header { padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: white; }
        .matrix-item-header:hover { background: #f0f7ff; }
        .matrix-item-body { padding: 20px; background: #fff; border-top: 1px solid #eee; display: none; }
        .matrix-item-header b { font-size: 1.1em; color: var(--primary); }
        .matrix-badge { font-size: 0.75em; padding: 2px 8px; border-radius: 4px; background: #eee; color: #666; font-weight: bold; }
        @keyframes badge-blink {
            0% { background-color: #d63031; transform: scale(1); }
            50% { background-color: #ff0000; transform: scale(1.1); }
            100% { background-color: #d63031; transform: scale(1); }
        }
        @keyframes card-vibrate {
        0% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-5px) scale(1.01); box-shadow: 0 15px 45px rgba(214, 48, 49, 0.2); }
        100% { transform: translateY(0) scale(1); }
        }
        /* ì„¸ì¼ ìƒíƒœì¸ ì¹´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .lens-card.sale-active {
            border: 1px solid #eee !important;
            animation: none !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05) !important;
        }
        .sale-badge.animate {
            color: #ffff00 !important;        /* â˜… ê¸€ììƒ‰: ë…¸ë€ìƒ‰ */
            background-color: #ff0000 !important; /* â˜… ë°°ê²½ìƒ‰: ë¹¨ê°„ìƒ‰ */
            animation: badge-blink 0.5s infinite; /* ë” ë¹ ë¥´ê²Œ ë²ˆì©ì„ */
            padding: 4px 10px !important;
            border-radius: 5px;
            font-weight: 900;
            display: inline-block;
        }
        /* ê°€ê²© ìƒ‰ìƒ ê¸°ë³¸ê°’: ê²€ì •ìƒ‰ */
        .price-text {
            color: #333; /* ê¸°ë³¸ ê²€ì • */
        }
        /* ì„¸ì¼ ì¤‘ì¼ ë•Œë§Œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        .sale-active .price-text {
            color: var(--sale) !important; /* ì„¸ì¼ ì‹œ ë¹¨ê°„ìƒ‰ */
        }
    </style>
</head>
<body class="filter-off">

<div class="app-container">
    <header>
        <div class="logo-area"><h2>ì•„ì´ì  íŠ¸ë¦¬ ì¶©ë‚¨ë„ì²­ì </h2><span style="font-size:0.8em; opacity:0.7; margin-left:10px;">V1.1 MASTER</span></div>
        <div class="top-controls">
            <button id="fullscreen-btn" class="btn-ui" style="background:#2ecc71;" onclick="toggleFullScreen()">ğŸ“º ì „ì²´í™”ë©´</button>
            <button id="filter-toggle-btn" class="btn-ui" style="background:#95a5a6;" onclick="togglePowerFilter()">ğŸ” ë„ìˆ˜ ì ìš© ì•ˆí•¨</button>
            <div class="control-group">
                <div onclick="openGeneralPicker('age')"><div class="label-text">ëŒ€ìƒ ì„ íƒ</div><div id="disp-age" class="power-box-btn">ì„±ì¸</div></div>
                <div onclick="openGeneralPicker('issue')"><div class="label-text">ë¶ˆí¸í•¨ ì„ íƒ</div><div id="disp-issue" class="power-box-btn">ì—†ìŒ</div></div>
            </div>
            <div class="control-group">
                <div onclick="openPowerPicker('rs')"><div class="label-text">ìš° S</div><div id="disp-rs" class="power-box-btn">0.00</div></div>
                <div onclick="openPowerPicker('rc')"><div class="label-text">ìš° C</div><div id="disp-rc" class="power-box-btn">0.00</div></div>
                <div onclick="openPowerPicker('ls')"><div class="label-text">ì¢Œ S</div><div id="disp-ls" class="power-box-btn">0.00</div></div>
                <div onclick="openPowerPicker('lc')"><div class="label-text">ì¢Œ C</div><div id="disp-lc" class="power-box-btn">0.00</div></div>
            </div>
            <button class="btn-admin-gear" onclick="secureAdminOpen()">âš™ï¸</button>
        </div>
    </header>

    <div id="ui-overlay" onclick="closeAllModals()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1998;"></div>
    
    <div id="picker-overlay" onclick="this.style.display='none'">
        <div class="picker-container" onclick="event.stopPropagation()">
            <div id="picker-title" style="font-size:1.7em; font-weight:900; margin-bottom:25px; text-align:center; color:var(--primary); border-bottom:4px solid var(--accent); padding-bottom:15px;">ì„ íƒ</div>
            <div class="picker-grid" id="picker-grid-content"></div>
            <div style="margin-top:35px; text-align:center;"><button class="btn-ui" style="background:var(--primary); padding:20px 100px; font-size:1.2em;" onclick="document.getElementById('picker-overlay').style.display='none'">ë‹«ê¸°</button></div>
        </div>
    </div>

    <div class="tabs-bar" id="tab-nav"></div>
    <div id="main-display" class="content-body"></div>
</div>

<div id="admin-panel" class="admin-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:30px; align-items:center;">
        <div style="display:flex; gap:15px;">
            <button class="btn-ui" style="background:var(--accent); font-size:1.1em; padding:15px 30px;" onclick="openMatrix()">ğŸ”³ ë§¤íŠ¸ë¦­ìŠ¤ ê°€ê²©í‘œ ê´€ë¦¬</button>
            <button class="btn-ui" style="background:var(--success);" onclick="document.getElementById('excel-modal').style.display='block';">ğŸ“Š ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ</button>
            <button class="btn-ui" style="background:#9b59b6;" onclick="exportData()">ğŸ“¤ ë°±ì—…ì €ì¥</button>
            <button class="btn-ui" style="background:#8e44ad;" onclick="importData()">ğŸ“¥ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div style="display:flex; gap:12px;">
            <button class="btn-ui" style="background:var(--success); border: 2px solid white;" onclick="saveData()">ğŸ’¾ ì„œë²„ì— ìµœì¢…ì €ì¥</button>
            <button class="btn-ui" style="background:#666;" onclick="toggleAdmin()">âŒ ë‹«ê¸°</button>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:30px;">
        <div>
            <div class="admin-section" style="background:#fff9f0;">
                <h4>ğŸ”¢ íƒ­ ë…¸ì¶œ ìˆœì„œ ê´€ë¦¬</h4>
                <div id="admin-tab-order-list" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
            </div>

            <div class="admin-section">
                <h4>ğŸ“‚ íƒ­ ëª…ì¹­ ë° í•˜ë‹¨ ì´ë¯¸ì§€ ê´€ë¦¬</h4>
                <div id="admin-tab-list" style="max-height: 300px; overflow-y: auto; margin-bottom:15px;"></div>
                <div style="display:flex; gap:5px;"><input type="text" id="new-cat-name" placeholder="ìƒˆ íƒ­ ì´ë¦„" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;"><button class="btn-ui" style="background:var(--success);" onclick="addCategory()">íƒ­ ì¶”ê°€</button></div>
            </div>

            <div class="admin-section">
                <h4>â“ ë¶ˆí¸ ì¦ìƒ í•­ëª© ê´€ë¦¬</h4>
                <div id="admin-issue-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
                <div style="margin-top:15px; display:flex; gap:5px;"><input type="text" id="new-issue-name" placeholder="ìƒˆ ì¦ìƒ" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;"><button class="btn-ui" style="background:var(--success);" onclick="addIssue()">ì¦ìƒ ì¶”ê°€</button></div>
            </div>
        </div>

        <div>
            <div class="admin-section" style="border: 2px solid var(--accent);">
                <h4>ğŸ”¢ [í†µí•©] í•´ë‹¹ íƒ­ ë‚´ ì œí’ˆ ë…¸ì¶œ ìˆœì„œ ê´€ë¦¬ 
                    <select id="admin-order-tab-select" onchange="adminSelectedTabId = this.value; renderAdmin();" style="padding:10px; border-radius:8px; width:200px;"></select>
                </h4>
                <div id="admin-unified-order-list" style="max-height: 600px; overflow-y: auto;"></div>
            </div>
        
            <div class="admin-section" style="background:#f0f7ff; border: 2px solid var(--accent);">
                <h4>ğŸ–¼ï¸ í™ë³´ ì´ë¯¸ì§€ ì¹´ë“œ ê´€ë¦¬ (ì´ë¦„/ì£¼ì†Œ ìˆ˜ì •)</h4>
                <div id="admin-image-list" style="max-height: 400px; overflow-y: auto; margin-bottom:15px;"></div>
                
                <button class="btn-ui" style="background:var(--accent); width:100%; padding:15px;" onclick="addNewImageCard()">+ ìƒˆ í™ë³´ ì´ë¯¸ì§€ ì¹´ë“œ ì¶”ê°€</button>
            </div>

            <div class="admin-section">
                <h4>ğŸ“¦ ì¼ë°˜ ë¸Œëœë“œë³„ ì œí’ˆ ìƒì„¸ ì„¤ì • (SALE ë°°ì§€, ë„ìˆ˜ë²”ìœ„ ë“±)</h4>
                <div id="admin-brands-list"></div>
                <button class="btn-ui" style="background:var(--accent); margin-top:20px; width:100%; padding:15px;" onclick="addNewBrand()">+ ìƒˆ ë¸Œëœë“œ ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>

<div id="matrix-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:96%; height:92%; background:white; z-index:5000; padding:25px; border-radius:20px; box-shadow:0 0 100px rgba(0,0,0,0.5); overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3>ğŸ”³ ë§¤íŠ¸ë¦­ìŠ¤ ê´€ë¦¬ì</h3><button class="btn-ui" style="background:#666;" onclick="closeMatrix()">ì°½ ë‹«ê¸°</button></div>
    
    <div id="matrix-editor" style="display:none; background:#f8f9fa; padding:25px; border-radius:20px; border:3px solid var(--accent); margin-bottom:30px;">
        <div style="display:flex; gap:15px; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
            ë¸Œëœë“œ: <input type="text" id="m-brand" style="width:130px; padding:8px;"> 
            íƒ€ì´í‹€ìƒ‰: <input type="color" id="m-brand-color"> 
            ì‹œë¦¬ì¦ˆëª…: <input type="text" id="m-name" style="width:200px; padding:8px;"> 
            ì†Œì† íƒ­: <select id="m-tab" style="padding:8px; border-radius:5px;"></select>
        </div>
        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:20px; font-size:0.95em; border:1px solid #ddd;">
            AI íƒ€ê²Ÿ ì—°ë ¹: <span id="m-ages-wrap"></span> | ì¦ìƒ: <span id="m-issues-wrap"></span>
        </div>
        <div style="overflow-x:auto;">
            <table class="matrix-editor-table">
                <thead id="m-header"></thead>
                <tbody id="m-body"></tbody>
            </table>
        </div>
        <div style="text-align:right; margin-top:25px;"><button class="btn-ui" style="background:var(--success); padding:15px 50px;" onclick="saveMatrixToMemory()">âœ… ë§¤íŠ¸ë¦­ìŠ¤ ì €ì¥í•˜ê¸°</button></div>
    </div>

    <h4>ì €ì¥ëœ ë§¤íŠ¸ë¦­ìŠ¤ ëª©ë¡</h4>
    <div id="saved-matrices-list" style="margin-top:10px;"></div>
    <button class="btn-ui" style="background:var(--accent); margin-top:20px; padding:15px 40px;" onclick="showMatrixEditor()">+ ìƒˆ ë¸Œëœë“œ ë§¤íŠ¸ë¦­ìŠ¤ ì¶”ê°€</button>
</div>

<div id="excel-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:600px; height:500px; background:white; z-index:6000; padding:30px; border-radius:20px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
    <h3>ğŸ“Š ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ</h3>
    <textarea id="excel-input" style="width:100%; height:320px; margin-top:10px; padding:10px; border:1px solid #ddd; border-radius:10px; font-family:monospace;"></textarea>
    <div style="text-align:right; margin-top:20px;"><button class="btn-ui" style="background:var(--danger);" onclick="processExcel()">ğŸš€ ì¦‰ì‹œ ì ìš©</button><button class="btn-ui" style="background:#666; margin-left:10px;" onclick="document.getElementById('excel-modal').style.display='none'">ë‹«ê¸°</button></div>
</div>

<script>
    // [Firebase]
    const firebaseConfig = { apiKey: "AIzaSyBV128h-2uzJUjGsazgK0XXn6f0uVnMyV8", authDomain: "eyegentry-5c7de.firebaseapp.com", databaseURL: "https://eyegentry-5c7de-default-rtdb.firebaseio.com", projectId: "eyegentry-5c7de", storageBucket: "eyegentry-5c7de.firebasestorage.app", messagingSenderId: "772851251300", appId: "1:772851251300:web:330b44914302a6b0048771" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ë°°ê²½ìƒ‰ì˜ ë°ê¸°ë¥¼ ê³„ì‚°í•˜ì—¬ ê²€ì •ìƒ‰(#333) ë˜ëŠ” í°ìƒ‰(#fff)ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
    function getContrastColor(hexColor) {
        if (!hexColor || hexColor.indexOf('#') !== 0) return '#333';
        const r = parseInt(hexColor.slice(1, 3), 16);
        const g = parseInt(hexColor.slice(3, 5), 16);
        const b = parseInt(hexColor.slice(5, 7), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness > 128 ? '#333' : '#fff'; // 128ë³´ë‹¤ í¬ë©´ ë°ì€ìƒ‰ì´ë¯€ë¡œ ê²€ì •ê¸€ì”¨ ë°˜í™˜
    }
    
    // ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ë‹¤ìŒ êµ´ì ˆë¥ ì„ ê²°ì •í•˜ëŠ” í•¨ìˆ˜
    function getNextIndexValue(items) {
        const sequence = ['1.56', '1.60', '1.67', '1.74']; // ìˆœì„œ ì •ì˜
        if (!items || items.length === 0) return sequence[0]; // ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ 1.56 ì‹œì‘

        const lastIdx = items[items.length - 1].idx; // ë§ˆì§€ë§‰ìœ¼ë¡œ ì¶”ê°€ëœ êµ´ì ˆë¥  í™•ì¸
        const currentIndex = sequence.indexOf(lastIdx);
        
        // ë§ˆì§€ë§‰ì´ 1.74ì´ê±°ë‚˜ ëª©ë¡ì— ì—†ìœ¼ë©´ ë‹¤ì‹œ 1.56ìœ¼ë¡œ, ì•„ë‹ˆë©´ ë‹¤ìŒ ìˆœì„œë¡œ
        if (currentIndex === -1 || currentIndex === sequence.length - 1) {
            return sequence[0];
        }
        return sequence[currentIndex + 1];
    }

    // [ì „ì—­ ë³€ìˆ˜]
    let categories = [{id:'ai', name:'âœ¨ AI ì¶”ì²œ'}], 
        brands = [], 
        issues = [{id:'none', name:'ì—†ìŒ'}], 
        matrices = [], 
        images = []; // ì´ë¯¸ì§€ ë³´ê´€í•¨ ì¶”ê°€

    let openMatrixIndex = null; 
    let currentTabId = 'ai';
    let adminSelectedTabId = ''; // ì—ëŸ¬ì˜ ì›ì¸ì´ì—ˆë˜ ë³€ìˆ˜ë¥¼ ìœ„ë¡œ ì˜¬ë ¸ìŠµë‹ˆë‹¤.
    let userPower = {rs:0, rc:0, ls:0, lc:0};
    let selectedAge = 'adult', selectedIssue = 'none', isFilterActive = false, openBrandIndex = null, editingMatrix = null;
    const fixedIndices = ['1.56', '1.60', '1.67', '1.74'];

    // 2. ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function loadDataFromServer() {
        db.ref('lensData').on('value', (snap) => {
            const data = snap.val();
            if(data) {
            categories = data.categories || categories;
            brands = data.brands || [];
            issues = data.issues || issues;
            matrices = data.matrices || [];
            
            // [ì¤‘ìš”] imagesê°€ nullì´ê±°ë‚˜ ê°ì²´ë©´ ë¹ˆ ë°°ì—´([])ë¡œ ì´ˆê¸°í™”
            images = Array.isArray(data.images) ? data.images : [];
            window.images = images; // ì „ì—­ ì°¸ì¡° ì—°ê²°
                
                // [ìˆ˜ì •] ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•Œ ê´€ë¦¬ììš© ì„ íƒ íƒ­ì„ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì²« ë²ˆì§¸ íƒ­ IDë¡œ ìë™ ì„¤ì •
                const firstRealTab = categories.find(c => c.id !== 'ai');
                if (firstRealTab && (!adminSelectedTabId || !categories.find(c => c.id === adminSelectedTabId))) {
                    adminSelectedTabId = firstRealTab.id;
                }

                renderApp(); 
                if(document.getElementById('admin-panel').style.display === 'block') renderAdmin();
            }
        });
    }

    // [ìˆœì„œ ì œì–´ í•µì‹¬ í•¨ìˆ˜]
    function moveItem(arr, idx, dir) {
        if (idx + dir < 0 || idx + dir >= arr.length) return;
        const temp = arr[idx];
        arr[idx] = arr[idx + dir];
        arr[idx + dir] = temp;
        // order ê°’ì„ ë¬¼ë¦¬ì  ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì¬ì„¤ì • (ê¼¬ì„ ë°©ì§€)
        arr.forEach((item, i) => item.order = (i + 1) * 10);
        renderAdmin(); renderApp();
    }

    function moveUnified(idx, dir) {
        let pool = [];
        brands.forEach(b => b.lenses.forEach(l => { if(l.tabId === adminSelectedTabId) pool.push(l); }));
        matrices.forEach(m => { if(m.tabId === adminSelectedTabId) pool.push(m); });
        pool.sort((a,b) => (a.order || 0) - (b.order || 0));
        
        if (idx + dir < 0 || idx + dir >= pool.length) return;
        
        const temp = pool[idx];
        pool[idx] = pool[idx + dir];
        pool[idx + dir] = temp;

        pool.forEach((item, i) => item.order = (i + 1) * 10);
        renderAdmin(); renderApp();
    }

    // [ë©”ì¸ í™”ë©´ ë Œë”ë§]
    function renderApp() {
        const sortedCats = [...categories];
        // ìƒë‹¨ íƒ­ ë©”ë‰´ ê·¸ë¦¬ê¸°
        document.getElementById('tab-nav').innerHTML = sortedCats.map(c => `<div class="tab ${currentTabId===c.id?'active':''}" onclick="currentTabId='${c.id}'; renderApp();">${c.name}</div>`).join('');
        
        let pool = [];
        // 1. ì¼ë°˜ ë Œì¦ˆ ë°ì´í„°ë¥¼ ëª¨ìŒ
        brands.forEach(b => b.lenses.forEach(l => {
            if(currentTabId === l.tabId || (currentTabId === 'ai' && l.targetIssues?.includes(selectedIssue) && l.targetAges?.includes(selectedAge))) {
                pool.push({...l, type:'normal', brandName: b.name});
            }
        }));

        // 2. ë§¤íŠ¸ë¦­ìŠ¤ ë°ì´í„°ë¥¼ ëª¨ìŒ
        matrices.forEach(m => {
            if(currentTabId === m.tabId || (currentTabId === 'ai' && m.targetIssues?.includes(selectedIssue) && m.targetAges?.includes(selectedAge))) {
                pool.push({...m, type:'matrix'});
            }
        });

        if (Array.isArray(images)) {
            images.forEach(img => {
                // í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ê³¼ ì´ë¯¸ì§€ì— ì„¤ì •ëœ íƒ­ì´ ê°™ì„ ë•Œë§Œ poolì— ë„£ìŒ
                if(currentTabId === img.tabId) {
                    pool.push({...img, type:'imageCard'}); // typeì„ imageCardë¡œ ëª…ì‹œ
                }
            });
        }

        // 3. í™ë³´ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ëª¨ìŒ
        images.forEach(img => { 
            // ì´ë¯¸ì§€ì˜ tabIdì™€ í˜„ì¬ ê´€ë¦¬ì ì°½ì—ì„œ ì„ íƒí•œ íƒ­Idê°€ ê°™ì„ ë•Œë§Œ ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.
            if(img && img.tabId === adminSelectedTabId) {
                pool.push({
                    id: img, 
                    name: img.name || 'ìƒˆ í™ë³´ ì´ë¯¸ì§€', 
                    b: '[ì´ë¯¸ì§€]', 
                    type: 'ê´‘ê³ '
                }); 
            }
        });
        
        // ì •í•´ì§„ ìˆœì„œ(order)ëŒ€ë¡œ ì •ë ¬
        pool.sort((a,b) => (a.order || 999) - (b.order || 999));

        // í™”ë©´ì— ì¹´ë“œë“¤ì„ ê·¸ë¦¼
        let html = '<div class="card-grid">';
        pool.forEach(item => {
            if(item.type === 'matrix') html += renderMatrixHtml(item);
            else if(item.type === 'imageCard') html += renderImageCardHtml(item); // ì´ë¯¸ì§€ ì „ìš©
            else html += renderNormalHtml(item);
        });
        
        // íƒ­ í•˜ë‹¨ ë°°ë„ˆ ì²˜ë¦¬
        const curCat = categories.find(c => c.id === currentTabId);
        let banner = (curCat && curCat.img) ? `<img src="${curCat.img}" style="width:100%; max-width:100%; display:block; margin:5px 0; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">` : '';
        document.getElementById('main-display').innerHTML = html + '</div>' + banner;
    }

    function renderImageCardHtml(img) {
        return `
        <div class="image-card" style="grid-column: span 1; border-radius:15px; overflow:hidden; box-shadow:0 5px 20px rgba(0,0,0,0.05); background:white;">
            <img src="${img.url}" style="width:100%; display:block; object-fit:contain;">
        </div>`;
    }

    /* --- 2ë²ˆ ë‹¨ê³„ ìµœì¢… êµì²´ ì½”ë“œ --- */
    function renderNormalHtml(l) {
        if (!l.items || !Array.isArray(l.items)) return '';

        let rows = ''; 
        let match = false;
        
        // 1. ì„¸ì¼ ìƒíƒœ(l.isSale)ì— ë”°ë¼ ì¹´ë“œì— 'sale-active'ë¼ëŠ” ì´ë¦„ì„ ë¶™ì—¬ì¤ë‹ˆë‹¤.
        const saleClass = l.isSale ? 'sale-active' : ''; 

        /* --- 1. ë„ìˆ˜ ë° í•©ë„ìˆ˜ í•„í„°ë§ í•µì‹¬ ë¡œì§ --- */
                l.items.forEach(it => {
                    // í•©ë„ìˆ˜(ì›ì‹œ) ê³„ì‚°: Sì™€ S+C ì¤‘ ë” í° ê°’ì´ ë Œì¦ˆ ë‘ê»˜ì˜ ê¸°ì¤€ì´ ë©ë‹ˆë‹¤.
                    const rMaxP = Math.max(userPower.rs, userPower.rs + userPower.rc);
                    const lMaxP = Math.max(userPower.ls, userPower.ls + userPower.lc);

                    // ê°œë³„ ë„ìˆ˜ ì²´í¬ (Sêµ¬ë©´ ë²”ìœ„, Cë‚œì‹œ ë²”ìœ„ í™•ì¸)
                    const isOutIndividual = (userPower.rs > it.sMax || userPower.rs < it.sMin || userPower.rc < it.cMin || userPower.ls > it.sMax || userPower.ls < it.sMin || userPower.lc < it.cMin);
                    
                    // í•©ë„ìˆ˜ ì²´í¬ (âˆ‘í•© ì¹¸ì— ê°’ì´ ì…ë ¥ë˜ì–´ ìˆì„ ë•Œë§Œ ì‘ë™)
                    const isOutSum = (it.sumMax > 0 && (rMaxP > it.sumMax || lMaxP > it.sumMax));

                    // ê°œë³„ ë²”ìœ„ë‚˜ í•©ë„ìˆ˜ ì¤‘ í•˜ë‚˜ë¼ë„ ë²—ì–´ë‚˜ë©´ 'out' ì²˜ë¦¬í•˜ì—¬ ê°€ë¦½ë‹ˆë‹¤.
                    const out = isOutIndividual || isOutSum;
                    
                    if(!out) match = true;
            
            // ê°€ê²© ì¶œë ¥ (NaN ë°©ì§€ ì²˜ë¦¬ í¬í•¨)
            const cleanOff = Number(String(it.pOff || 0).replace(/[^0-9]/g, ''));
            const cleanSale = Number(String(it.pSale || 0).replace(/[^0-9]/g, ''));

            rows += `<tr class="${out?'disabled-row':''}">
                <td>${it.idx}</td>
                <td>${it.spec}</td>
                <td style="text-align:right;">
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <span style="text-decoration:line-through; font-size:0.75em; color:#bbb;">
                            ${cleanOff > 0 ? cleanOff.toLocaleString() + 'ì›' : ''}
                        </span>
                        <span class="price-text" style="font-weight:900; font-size:1.1em;">
                            ${cleanSale.toLocaleString()}ì›
                        </span>
                    </div>
                </td>
            </tr>`;
        });

        if(isFilterActive && !match && (userPower.rs !== 0 || userPower.ls !== 0)) return '';

        const bgColor = l.bgColor || '#2c3e50';
        const textColor = getContrastColor(bgColor);

        // 2. ì¹´ë“œ ì „ì²´ ìƒì(lens-card)ì— ìœ„ì—ì„œ ë§Œë“  saleClassë¥¼ ì ìš©í•©ë‹ˆë‹¤.
        return `<div class="lens-card ${saleClass}">
            <div class="card-head" style="background:${bgColor}; color:${textColor}">
                <span>${l.brandName} ${l.name}</span>
                ${l.isSale ? `<span class="sale-badge animate" style="background:${textColor}; color:${bgColor};">SALE</span>` : ''}
            </div>
            ${l.desc ? `<div class="lens-one-liner">ğŸ’¡ ${l.desc}</div>` : ''}
            <table class="card-table">
                <thead><tr><th>êµ´ì ˆë¥ </th><th>ì„¤ê³„</th><th style="text-align:right;">ê°€ê²©</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>`;
    }

    function renderMatrixHtml(m) {
        // 1. ì „ì²´ ì œëª© ë°°ê²½ìƒ‰ì— ë§ëŠ” ê¸€ì”¨ìƒ‰ ê³„ì‚°
        const titleBg = m.brandColor || '#2c3e50';
        const titleTextColor = getContrastColor(titleBg);

        let h = `<div class="matrix-container">
                    <div class="matrix-title" style="background:${titleBg}; color:${titleTextColor}">
                        ${m.brand} - ${m.name}
                    </div>
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="idx-col">êµ´ì ˆë¥ </th>`;

        m.cols.forEach(c => {
                const colBg = c.bgColor || '#fdfdfd';
                const colTextColor = getContrastColor(colBg);
                
                // í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ ì„¤ì • (ê¸€ì”¨ê°€ í°ìƒ‰ì´ë©´ ì—°í•œ í°ìƒ‰ íˆ¬ëª…, ê²€ì •ì´ë©´ ì—°í•œ ê²€ì • íˆ¬ëª… ë°•ìŠ¤)
                const highlightBg = colTextColor === '#fff' ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.08)';
                
                h += `<th style="background:${colBg}; color:${colTextColor}; vertical-align: middle; padding: 15px 5px;">
                        <div style="font-size:1.15em; font-weight:900; margin-bottom: 4px;">${c.name}</div>
                        
                        ${c.desc ? `<div style="font-size:0.82em; font-weight:700; background:${highlightBg}; display:inline-block; padding:3px 12px; border-radius:15px; margin-bottom: 6px;">${c.desc}</div>` : ''}
                        
                        ${(c.addInfo || c.corridor) ? `<div style="font-size:0.75em; opacity:0.85; letter-spacing: -0.5px;">ADD:${c.addInfo||'-'} / ëˆ„ì§„:${c.corridor||'-'}</div>` : ''}
                        
                        ${c.isSale ? `<div class="sale-badge" style="margin-top:8px; display:inline-block; background:${colTextColor}; color:${colBg};">SALE</div>` : ''}
                    </th>`;
            });

        h += `</tr></thead><tbody>`;
        fixedIndices.forEach(idx => {
            const sk = 'idx_'+idx.replace('.','');
            const out = (userPower.rs > (idx==='1.56'?4:6) || userPower.rs < (idx==='1.56'?-6:-10));
            h += `<tr class="${out?'disabled-row':''}"><td class="idx-col">${idx}</td>`;
            m.cols.forEach(c => {
                const p = (c.prices && c.prices[sk]) || {off:'', sale:''};
                const cleanOff = Number(String(p.off || 0).replace(/[^0-9]/g, ''));
                const cleanSale = Number(String(p.sale || 0).replace(/[^0-9]/g, ''));

                h += `<td>
                        <div style="font-size:0.8em; color:#bbb; text-decoration:line-through;">
                            ${cleanOff > 0 ? cleanOff.toLocaleString() + 'ì›' : ''}
                        </div>
                        <div style="font-weight:900; font-size:1.2em;">
                            ${cleanSale > 0 ? cleanSale.toLocaleString() + 'ì›' : '-'}
                        </div>
                    </td>`;
            });
            h += `</tr>`;
        });
        return h + `</tbody></table></div>`;
    }

    // [ê´€ë¦¬ì ì„¤ì • ë Œë”ë§]
    function renderAdmin() {
            if (!Array.isArray(images)) {
            images = [];
            }

            // 1. ğŸ“‚ íƒ­ ëª…ì¹­ ë° í•˜ë‹¨ ì´ë¯¸ì§€ ê´€ë¦¬
            document.getElementById('admin-tab-list').innerHTML = categories.map((c, idx) => `
                <div class="tag-row" style="flex-direction:column; align-items:stretch;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="text" value="${c.name}" onchange="categories[${idx}].name=this.value; renderApp();" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; font-weight:bold;">
                        <button class="btn-small" style="background:var(--danger); padding:10px 15px;" onclick="if(confirm('ì´ íƒ­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){categories.splice(${idx},1); renderAdmin(); renderApp();}">ì‚­ì œ</button>
                    </div>
                    <input type="text" placeholder="í•˜ë‹¨ ì´ë¯¸ì§€ URL" value="${c.img||''}" onchange="categories[${idx}].img=this.value; renderApp();" style="margin-top:8px; padding:10px; border-radius:8px; border:1px solid #ddd;">
                </div>`).join('');

            // 2. ğŸ”¢ íƒ­ ë…¸ì¶œ ìˆœì„œ ê´€ë¦¬
            document.getElementById('admin-tab-order-list').innerHTML = categories.map((c, idx) => `
                <div class="tag-row" style="background:white; border:1px solid #ddd;">
                    <button class="btn-small" onclick="moveItem(categories, ${idx}, -1)">â—€</button>
                    <b style="font-size:0.9em;">${c.name}</b>
                    <button class="btn-small" onclick="moveItem(categories, ${idx}, 1)">â–¶</button>
                </div>`).join('');

            // 3. â“ ë¶ˆí¸ ì¦ìƒ í•­ëª© ê´€ë¦¬
            document.getElementById('admin-issue-list').innerHTML = issues.map((is, idx) => `
                <div class="tag-row"><span>${is.name}</span><button class="btn-small" onclick="issues.splice(${idx},1); renderAdmin();">Ã—</button></div>`).join('');

            // 4. ğŸ”¢ [í†µí•©] í•´ë‹¹ íƒ­ ë‚´ ì œí’ˆ ë…¸ì¶œ ìˆœì„œ ê´€ë¦¬ (ë²„ê·¸ ìˆ˜ì •: ì¤‘ë³µ ì œê±° ë° ì´ë¦„ ì—°ë™)
            let pool = [];
            brands.forEach(b => b.lenses.forEach(l => { if(l.tabId === adminSelectedTabId) pool.push({id:l, name:l.name, b:b.name, type:'ì¼ë°˜'}); }));
            matrices.forEach(m => { if(m.tabId === adminSelectedTabId) pool.push({id:m, name:m.name, b:m.brand, type:'ë§¤íŠ¸ë¦­ìŠ¤'}); });
            // ì‚¬ì¥ë‹˜ì´ ì§€ìœ¼ì‹  ì´ë¦„(img.name)ì´ ëª©ë¡ì— ë°”ë¡œ ë‚˜ì˜¤ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
            
            if (Array.isArray(images)) {
                images.forEach(img => {
                    if(img.tabId === adminSelectedTabId) pool.push({id:img, name:img.name, b:'[ì´ë¯¸ì§€]', type:'í™ë³´ê´‘ê³ '});
                });
            }

            pool.sort((a,b) => (a.id.order || 999) - (b.id.order || 999));
            document.getElementById('admin-unified-order-list').innerHTML = pool.map((item, idx) => `
                <div class="tag-row">
                    <button class="btn-small" onclick="moveUnified(${idx}, -1)">â–²</button>
                    <button class="btn-small" onclick="moveUnified(${idx}, 1)">â–¼</button>
                    <span style="font-size:0.85em;">[${item.type}] <b>${item.b}</b> ${item.name}</span>
                </div>`).join('');

            // 6. ğŸ–¼ï¸ í™ë³´ ì´ë¯¸ì§€ ì¹´ë“œ ê´€ë¦¬ (window ì°¸ì¡° ë°©ì‹ìœ¼ë¡œ ì—ëŸ¬ ì™„ë²½ ì°¨ë‹¨)
            document.getElementById('admin-image-list').innerHTML = (window.images && window.images.length) ? window.images.map((img) => {
                if (!img.id) img.id = 'img_' + Date.now() + Math.random();
                
                return `
                <div class="tag-row" style="flex-direction:column; align-items:stretch; background:white; border:1px solid #d1e3f8; margin-bottom:15px; padding:15px; border-radius:12px;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <span style="font-size:1.2em;">ğŸ–¼ï¸</span>
                        <input type="text" value="${img.name || ''}" 
                            oninput="const target = window.images.find(x => x.id === '${img.id}'); if(target) target.name = this.value;" 
                            style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; font-weight:bold;" placeholder="ì´ë¯¸ì§€ ì´ë¦„">
                        
                        <button class="btn-small" style="background:var(--danger); padding:10px 15px;" 
                                onclick="if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ const dIdx = window.images.findIndex(x => x.id === '${img.id}'); if(dIdx > -1) window.images.splice(dIdx, 1); renderAdmin(); renderApp(); }">ì‚­ì œ</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <div style="font-size:0.75em; color:#888; margin-bottom:3px;">ì¶œë ¥ë  íƒ­ ì„ íƒ</div>
                            <select onchange="const target = window.images.find(x => x.id === '${img.id}'); if(target) target.tabId = this.value; renderAdmin(); renderApp();" 
                                    style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; background:#f9f9f9;">
                                <option value="">íƒ­ ë¯¸ì§€ì •</option>
                                ${categories.map(c => `<option value="${c.id}" ${img.tabId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div style="font-size:0.75em; color:#888; margin-bottom:3px;">ì´ë¯¸ì§€ ì£¼ì†Œ(URL)</div>
                            <input type="text" value="${img.url || ''}" 
                                oninput="const target = window.images.find(x => x.id === '${img.id}'); if(target) target.url = this.value;" 
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="https://...">
                        </div>
                    </div>
                </div>`;
            }).join('') : '<p style="text-align:center; color:#999; padding:20px;">ë“±ë¡ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

            // 5. ğŸ“¦ ì¼ë°˜ ë¸Œëœë“œë³„ ì œí’ˆ ìƒì„¸ ì„¤ì •
            let bHtml = '';
            brands.forEach((b, bi) => {
                const active = openBrandIndex === bi;
                // ì•ˆì „í•œ ë°°ê²½ìƒ‰ ì²˜ë¦¬
                const safeBrandColor = (b.bgColor && String(b.bgColor).startsWith('#')) ? b.bgColor : '#2c3e50';

                bHtml += `<div class="admin-section" style="padding:15px; background:${active?'#fff':'#f8f9fa'}">
                    <div style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;" onclick="openBrandIndex=${active?null:bi}; renderAdmin();">
                        <b style="font-size:1.1em;">${b.name} (${b.lenses ? b.lenses.length : 0})</b>
                        <span>${active?'â–¼':'â–¶'}</span>
                    </div>
                    <div style="display:${active?'block':'none'}; margin-top:15px; border-top:1px solid #ddd; padding-top:15px;">
                        ë¸Œëœë“œëª…: <input type="text" value="${b.name}" onchange="brands[${bi}].name=this.value;" style="padding:8px;">
                        <button class="btn-small" style="background:var(--danger); float:right;" onclick="if(confirm('ë¸Œëœë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){brands.splice(${bi},1); renderAdmin();}">ë¸Œëœë“œ ì‚­ì œ</button>
                        
            ${b.lenses ? b.lenses.map((l, li) => {
                // 1. ì—¬ê¸°ì„œ ìƒ‰ìƒ ì—ëŸ¬ë¥¼ ë¯¸ë¦¬ ë°©ì§€í•©ë‹ˆë‹¤.
                const safeLensColor = (l.bgColor && String(l.bgColor).startsWith('#')) ? l.bgColor : '#2c3e50';
                
                return `
                <div style="background:white; padding:15px; border-radius:12px; margin-top:15px; border:1px solid #eee;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                        <button class="btn-small" onclick="moveItem(brands[${bi}].lenses, ${li}, -1);">â–²</button>
                        <button class="btn-small" onclick="moveItem(brands[${bi}].lenses, ${li}, 1);">â–¼</button>
                        
                        ğŸ›¡ï¸ <input type="text" value="${l.name}" oninput="brands[${bi}].lenses[${li}].name=this.value;" style="flex:1; padding:8px;">
                        
                        <input type="color" value="${safeLensColor}" onchange="brands[${bi}].lenses[${li}].bgColor=this.value; renderApp();">
                        
                        <label style="font-size:0.8em; color:var(--danger); font-weight:bold;">
                            <input type="checkbox" ${l.isSale?'checked':''} onchange="brands[${bi}].lenses[${li}].isSale=this.checked; renderApp();"> SALE
                        </label>
                        
                        <select onchange="brands[${bi}].lenses[${li}].tabId=this.value; renderAdmin();">
                            <option value="">íƒ­ ë¯¸ì§€ì •</option>
                            ${categories.filter(c=>c.id!=='ai').map(c => `<option value="${c.id}" ${l.tabId===c.id?'selected':''}>${c.name}</option>`).join('')}
                        </select>
                        <button onclick="if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){brands[${bi}].lenses.splice(${li},1); renderAdmin();}">Ã—</button>
                    </div>
                    
                    <input type="text" value="${l.desc||''}" oninput="brands[${bi}].lenses[${li}].desc=this.value;" placeholder="í•œì¤„ ì„¤ëª…" style="width:100%; margin-bottom:10px; padding:8px;">
                    
                    ${l.items ? l.items.map((it, ii) => `
                        <div style="display:grid; grid-template-columns: 60px 150px 80px 80px 245px 40px; gap:8px; margin-bottom:8px; align-items:center;">
                            <input type="text" value="${it.idx}" oninput="brands[${bi}].lenses[${li}].items[${ii}].idx=this.value;" style="width:100%; padding:5px;">
                            <input type="text" value="${it.spec}" oninput="brands[${bi}].lenses[${li}].items[${ii}].spec=this.value;" style="width:100%; padding:5px;" placeholder="ì„¤ê³„">
                            <input type="text" value="${Number(it.pOff||0).toLocaleString()}" oninput="inputPriceFormat(this, (v) => brands[${bi}].lenses[${li}].items[${ii}].pOff = v)" style="width:100%; padding:5px;">
                            <input type="text" value="${Number(it.pSale||0).toLocaleString()}" oninput="inputPriceFormat(this, (v) => brands[${bi}].lenses[${li}].items[${ii}].pSale = v)" style="width:100%; padding:5px;">
                            
                            <div style="font-size:0.72em; background:#f0f7ff; padding:5px; border-radius:8px; display:flex; align-items:center; gap:4px; border:1px solid #d1e3f8;">
                                <b style="color:#d63031;">S+</b><input type="number" step="0.25" value="${it.sMax}" style="width:38px; font-weight:bold;" oninput="brands[${bi}].lenses[${li}].items[${ii}].sMax=parseFloat(this.value)">
                                ~<input type="number" step="0.25" value="${it.sMin}" style="width:38px;" oninput="brands[${bi}].lenses[${li}].items[${ii}].sMin=parseFloat(this.value)">
                                <b style="color:#0984e3;">C</b><input type="number" step="0.25" value="${it.cMin||0}" style="width:38px;" oninput="brands[${bi}].lenses[${li}].items[${ii}].cMin=parseFloat(this.value)">
                                <span style="color:#ccc;">|</span>
                                <b style="color:#f39c12;">âˆ‘</b><input type="number" step="0.25" value="${it.sumMax||0}" style="width:38px; background:#fffbe6; border:1px solid #ffe066;" oninput="brands[${bi}].lenses[${li}].items[${ii}].sumMax=parseFloat(this.value)">
                            </div>
                            <button class="btn-small" style="background:#95a5a6;" onclick="brands[${bi}].lenses[${li}].items.splice(${ii},1); renderAdmin();">Ã—</button>
                        </div>`).join('') : ''}
                    <button class="btn-small" style="background:var(--accent); padding:10px 20px;" onclick="const nextIdx = getNextIndexValue(brands[${bi}].lenses[${li}].items); brands[${bi}].lenses[${li}].items.push({idx: nextIdx, spec:'', pOff:'0', pSale:'0', sMin:-10, sMax:6, cMin:-4, sumMax:0}); renderAdmin();">+ ì‚¬ì–‘ ì¶”ê°€</button>
                </div>`;
            }).join('') : ''}

                        <button class="btn-ui" style="background:var(--success); width:100%; margin-top:15px; padding:15px;" onclick="addNewLens(${bi})">+ ìƒˆ ì œí’ˆ ì¹´ë“œ ì¶”ê°€</button>
                    </div>
                </div>`;
            });
            document.getElementById('admin-brands-list').innerHTML = bHtml;
            const validTabs = categories.filter(c => c.id !== 'ai');
            document.getElementById('admin-order-tab-select').innerHTML = validTabs.map(c => `<option value="${c.id}" ${adminSelectedTabId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
        } // renderAdmin í•¨ìˆ˜ ë

    // [í”¼ì»¤ ë° ë„ìˆ˜ ì œì–´]
    function openPowerPicker(type) {
        const overlay = document.getElementById('picker-overlay');
        const grid = document.getElementById('picker-grid-content');
        const title = document.getElementById('picker-title');
        overlay.style.display = 'flex'; grid.innerHTML = '';
        let min, max;
        if(type.includes('s')) { title.innerText = "êµ¬ë©´ ë„ìˆ˜(SPH) ì„ íƒ (+8.00 ~ -15.00)"; min = -15; max = 8; }
        else { title.innerText = "ë‚œì‹œ ë„ìˆ˜(CYL) ì„ íƒ (0.00 ~ -7.00)"; min = -7; max = 0; }
        for(let i = max; i >= min; i -= 0.25) {
            const val = i.toFixed(2);
            const btn = document.createElement('div');
            btn.className = `pick-btn ${i > 0 ? 'plus' : (i < 0 ? 'minus' : '')} ${userPower[type].toFixed(2) === val ? 'selected' : ''}`;
            btn.innerText = (i > 0 ? "+" : "") + val;
            btn.onclick = () => { userPower[type] = parseFloat(val); document.getElementById('disp-'+type).innerText = (i>0?"+":"")+val; overlay.style.display='none'; renderApp(); };
            grid.appendChild(btn);
        }
    }

    function openGeneralPicker(mode) {
        const overlay = document.getElementById('picker-overlay');
        const grid = document.getElementById('picker-grid-content');
        const title = document.getElementById('picker-title');
        overlay.style.display = 'flex'; grid.innerHTML = '';
        const opts = (mode === 'age') ? [{id:'adult', n:'ì„±ì¸'}, {id:'student', n:'í•™ìƒ'}, {id:'senior', n:'ì‹œë‹ˆì–´'}] : issues;
        title.innerText = (mode === 'age') ? "ìƒë‹´ ëŒ€ìƒ ì—°ë ¹ ì„ íƒ" : "ë¶ˆí¸ ì¦ìƒ ì„ íƒ";
        opts.forEach(o => {
            const btn = document.createElement('div'); btn.className = `pick-btn ${ (mode==='age' ? selectedAge===o.id : selectedIssue===o.id) ? 'selected' : '' }`; 
            btn.innerText = o.name || o.n;
            btn.onclick = () => {
                if(mode==='age') { selectedAge = o.id; document.getElementById('disp-age').innerText = o.n; }
                else { selectedIssue = o.id; document.getElementById('disp-issue').innerText = o.name; }
                overlay.style.display='none'; renderApp();
            };
            grid.appendChild(btn);
        });
    }

    // [ë§¤íŠ¸ë¦­ìŠ¤ ë¡œì§]
    function openMatrix() { 
            document.getElementById('ui-overlay').style.display='block'; 
            document.getElementById('matrix-modal').style.display='block'; 
            openMatrixIndex = null; // ì¼¤ ë•Œ ëª¨ë‘ ë‹«íŒ ìƒíƒœë¡œ ì‹œì‘
            renderSavedMatrices(); 
        }
    function closeMatrix() { document.getElementById('matrix-modal').style.display='none'; document.getElementById('ui-overlay').style.display='none'; }
    function renderSavedMatrices() { 
        const container = document.getElementById('saved-matrices-list');
        container.style.display = 'block'; // í•œ ì¤„ë¡œ ë‚˜ì˜¤ê²Œ ë³€ê²½
        
        container.innerHTML = matrices.map((m, i) => {
            const active = (openMatrixIndex === i);
            const tabName = categories.find(c => c.id === m.tabId)?.name || 'ë¯¸ì§€ì •';
            
            return `
            <div class="matrix-list-item">
                <div class="matrix-item-header" onclick="openMatrixIndex = ${active ? 'null' : i}; renderSavedMatrices();">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="matrix-badge">${tabName}</span>
                        <b style="font-size:1.1em;">${m.brand} - ${m.name}</b>
                    </div>
                    <span style="color:#999;">${active ? 'â–² ì ‘ê¸°' : 'â–¼ í´ë¦­í•˜ì—¬ ê´€ë¦¬'}</span>
                </div>
                
                <div class="matrix-item-body" style="display:${active ? 'block' : 'none'}">
                    <div style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:10px; border-radius:8px;">
                        <div style="display:flex; gap:8px;">
                            <button class="btn-small" onclick="moveItem(matrices, ${i}, -1); renderSavedMatrices();">â–² ìœ„ë¡œ</button>
                            <button class="btn-small" onclick="moveItem(matrices, ${i}, 1); renderSavedMatrices();">â–¼ ì•„ë˜ë¡œ</button>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-ui" style="background:var(--accent); font-size:0.85em; padding:8px 15px;" onclick="editMatrix(${i})">âš™ï¸ ë°ì´í„° ìˆ˜ì •</button>
                            <button class="btn-ui" style="background:var(--danger); font-size:0.85em; padding:8px 15px;" onclick="if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){matrices.splice(${i},1); renderSavedMatrices();}">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                    <div style="margin-top:15px; font-size:0.9em; color:#666;">
                        â€¢ íƒ€ê²Ÿ: ${m.targetAges?.join(', ') || 'ì „ì²´'} / ${m.targetIssues?.map(id => issues.find(is=>is.id===id)?.name).join(', ') || 'ì¦ìƒì—†ìŒ'}
                    </div>
                </div>
            </div>`;
        }).join(''); 
    }
    function showMatrixEditor() { editingMatrix = {brand:'', name:'', brandColor:'#2c3e50', tabId:'', targetAges:['adult'], targetIssues:['none'], cols:[{name:'', desc:'', addInfo:'', corridor:'', bgColor:'#fdfdfd', prices:{}}]}; updateMEUI(); }
    function editMatrix(i) { editingMatrix = JSON.parse(JSON.stringify(matrices[i])); editingMatrix.originalIndex = i; updateMEUI(); }

    function updateMEUI() {
        document.getElementById('matrix-editor').style.display = 'block';
        document.getElementById('m-tab').innerHTML = categories.filter(c=>c.id!=='ai').map(c => `<option value="${c.id}" ${editingMatrix.tabId===c.id?'selected':''}>${c.name}</option>`).join('');
        document.getElementById('m-brand').value = editingMatrix.brand; document.getElementById('m-brand-color').value = (editingMatrix.brandColor && editingMatrix.brandColor !== 'undefined') ? editingMatrix.brandColor : '#2c3e50';
        document.getElementById('m-ages-wrap').innerHTML = ['student','adult','senior'].map(a => `<label style="margin-right:12px;"><input type="checkbox" class="m-age-chk" value="${a}" ${editingMatrix.targetAges?.includes(a)?'checked':''}> ${a}</label>`).join('');
        document.getElementById('m-issues-wrap').innerHTML = issues.map(is => `<label style="margin-right:12px;"><input type="checkbox" class="m-issue-chk" value="${is.id}" ${editingMatrix.targetIssues?.includes(is.id)?'checked':''}> ${is.name}</label>`).join('');
        
        let h = `<tr><th>êµ´ì ˆë¥ </th>`;
        editingMatrix.cols.forEach((c, i) => {
            h += `<th>
                <div style="background:#eee; padding:5px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:center; gap:5px;">
                    <button class="btn-small" onclick="moveMECol(${i}, -1)">â—€</button>
                    <button class="btn-small" onclick="moveMECol(${i}, 1)">â–¶</button>
                    <button class="btn-small" style="background:var(--danger)" onclick="editingMatrix.cols.splice(${i},1); updateMEUI();">Ã—</button>
                </div>
                <input class="me-input" id="col-n-${i}" value="${c.name}" placeholder="ë“±ê¸‰ëª…">
                <input class="me-input" id="col-d-${i}" value="${c.desc||''}" placeholder="í•œì¤„ì„¤ëª…">
                <div style="display:flex; gap:3px;"><input class="me-input" id="col-add-${i}" value="${c.addInfo||''}" placeholder="ADD"><input class="me-input" id="col-cor-${i}" value="${c.corridor||''}" placeholder="ëˆ„ì§„ëŒ€"></div>
                <input type="color" id="col-c-${i}" value="${(c.bgColor && String(c.bgColor).startsWith('#')) ? c.bgColor : '#fdfdfd'}">
                <label style="font-size:0.8em; font-weight:bold;"><input type="checkbox" id="col-s-${i}" ${c.isSale?'checked':''}> SALE</label>
            </th>`;
        });
        document.getElementById('m-header').innerHTML = h + `<th onclick="saveMEState(); editingMatrix.cols.push({name:'', desc:'', addInfo:'', corridor:'', bgColor:'#fdfdfd', prices:{}}); updateMEUI();" style="cursor:pointer; background:var(--accent); color:white;">+ ì¶”ê°€</th></tr>`;
        
        let b = '';

        fixedIndices.forEach(idx => {
            b += `<tr><td class="idx-col">${idx}</td>`;
            editingMatrix.cols.forEach((c, i) => {
                const sk = 'idx_' + idx.replace('.', '');
                const p = (c.prices && c.prices[sk]) || { off: '', sale: '' };
                
                // ë°ì´í„°ì— í˜¹ì‹œ ì‰¼í‘œê°€ ì„ì—¬ìˆì–´ë„ ìˆ«ìë¡œë§Œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•©ë‹ˆë‹¤.
                const displayOff = String(p.off || "").replace(/[^0-9]/g, "");
                const displaySale = String(p.sale || "").replace(/[^0-9]/g, "");

                b += `<td>
                    <input id="p-o-${idx}-${i}" 
                        value="${displayOff ? Number(displayOff).toLocaleString() : ''}" 
                        placeholder="ì •ê°€" 
                        oninput="inputPriceFormat(this, (v) => { if(!editingMatrix.cols[${i}].prices) editingMatrix.cols[${i}].prices={}; if(!editingMatrix.cols[${i}].prices['${sk}']) editingMatrix.cols[${i}].prices['${sk}']={}; editingMatrix.cols[${i}].prices['${sk}'].off = v; })" 
                        style="width:85%; margin-bottom:4px; padding:6px; border-radius:4px; border:1px solid #eee; text-align:right;">
                    <br>
                    <input id="p-s-${idx}-${i}" 
                        value="${displaySale ? Number(displaySale).toLocaleString() : ''}" 
                        placeholder="íŒë§¤ê°€" 
                        oninput="inputPriceFormat(this, (v) => { if(!editingMatrix.cols[${i}].prices) editingMatrix.cols[${i}].prices={}; if(!editingMatrix.cols[${i}].prices['${sk}']) editingMatrix.cols[${i}].prices['${sk}']={}; editingMatrix.cols[${i}].prices['${sk}'].sale = v; })" 
                        style="width:85%; padding:6px; border-radius:4px; border:1px solid #eee; text-align:right; font-weight:bold; color:var(--sale);">
                </td>`;
            });
            b += `<td></td></tr>`;
        });
        document.getElementById('m-body').innerHTML = b;
    }

    function saveMEState() {
        editingMatrix.brand = document.getElementById('m-brand').value;
        editingMatrix.brandColor = document.getElementById('m-brand-color').value;
        editingMatrix.name = document.getElementById('m-name').value;
        editingMatrix.tabId = document.getElementById('m-tab').value;
        editingMatrix.targetAges = Array.from(document.querySelectorAll('.m-age-chk:checked')).map(x=>x.value);
        editingMatrix.targetIssues = Array.from(document.querySelectorAll('.m-issue-chk:checked')).map(x=>x.value);
        editingMatrix.cols.forEach((c, i) => {
            c.name = document.getElementById(`col-n-${i}`).value;
            c.desc = document.getElementById(`col-d-${i}`).value;
            c.addInfo = document.getElementById(`col-add-${i}`).value;
            c.corridor = document.getElementById(`col-cor-${i}`).value;
            c.bgColor = document.getElementById(`col-c-${i}`).value;
            c.isSale = document.getElementById(`col-s-${i}`).checked;
            fixedIndices.forEach(idx => {
                const sk = 'idx_'+idx.replace('.','');
                const rawOff = document.getElementById(`p-o-${idx}-${i}`).value.replace(/,/g, "");
                const rawSale = document.getElementById(`p-s-${idx}-${i}`).value.replace(/,/g, "");
            if(!c.prices) c.prices = {};
            c.prices[sk] = { off: rawOff, sale: rawSale };
            });
        });
    }

    function moveMECol(idx, dir) { saveMEState(); if (idx + dir < 0 || idx + dir >= editingMatrix.cols.length) return; const temp = editingMatrix.cols[idx]; editingMatrix.cols[idx] = editingMatrix.cols[idx + dir]; editingMatrix.cols[idx + dir] = temp; updateMEUI(); }
    function saveMatrixToMemory() {
        saveMEState();
        if(editingMatrix.originalIndex !== undefined) matrices[editingMatrix.originalIndex] = editingMatrix;
        else matrices.push(editingMatrix);
        document.getElementById('matrix-editor').style.display = 'none'; 
        renderSavedMatrices();
        renderApp();
    }

    // ìˆ«ìë¥¼ ì…ë ¥í•˜ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‰¼í‘œë¥¼ ì°ì–´ì£¼ëŠ” í•¨ìˆ˜
    function inputPriceFormat(input, callback) {
        let val = input.value.replace(/,/g, ""); // ê¸°ì¡´ ì‰¼í‘œ ì œê±°
        if (isNaN(val)) val = ""; // ìˆ«ìê°€ ì•„ë‹ˆë©´ ì‚­ì œ
        
        // ë°ì´í„° ì €ì¥ìš© (ìˆ«ìë§Œ)
        callback(val); 
        
        // í™”ë©´ í‘œì‹œìš© (ì‰¼í‘œ ì¶”ê°€)
        input.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ","); 
    }

    // [ê¸°íƒ€ ê¸°ëŠ¥ë“¤]
    function togglePowerFilter() { isFilterActive = !isFilterActive; const btn = document.getElementById('filter-toggle-btn'); if(isFilterActive) { document.body.classList.remove('filter-off'); btn.innerText = "âš¡ í•„í„° ì‘ë™ì¤‘"; btn.style.background = "var(--danger)"; } else { document.body.classList.add('filter-off'); btn.innerText = "ğŸ” ë„ìˆ˜ ì ìš© ì•ˆí•¨"; btn.style.background = "#95a5a6"; } }
    function secureAdminOpen() { const pw = prompt("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"); if(pw === "1111") toggleAdmin(); }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = (p.style.display==='block'?'none':'block'); if(p.style.display==='block') renderAdmin(); }
    function closeAllModals() { document.querySelectorAll('.admin-panel, #matrix-modal, #picker-overlay, #excel-modal').forEach(el=>el.style.display='none'); document.getElementById('ui-overlay').style.display='none'; }
    function saveData() {
        if(confirm("ì„œë²„ì— ìµœì¢… ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            // ì €ì¥ ì‹œ images ë°°ì—´ì„ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
            db.ref('lensData').set({
                categories, 
                brands, 
                issues, 
                matrices,
                images  // ì´ë¯¸ì§€ ë°ì´í„° ì¶”ê°€
            })
            .then(() => alert("âœ… ì €ì¥ ì™„ë£Œ!"))
            .catch((error) => alert("ì €ì¥ ì‹¤íŒ¨: " + error.message));
        }
    }
    function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({categories, brands, issues, matrices})], {type:'application/json'})); a.download='eyegentry_backup.json'; a.click(); }
    function importData() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = event => { const imported = JSON.parse(event.target.result); if(confirm("ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { categories = imported.categories || categories; brands = imported.brands || []; issues = imported.issues || issues; matrices = imported.matrices || []; renderAdmin(); renderApp(); alert("ë³µêµ¬ ì™„ë£Œ!"); } }; reader.readAsText(file); }; input.click(); }

    function addCategory() { const n = document.getElementById('new-cat-name').value; if(n) { categories.push({id:'t'+Date.now(), name:n, img:'', order: categories.length * 10}); renderAdmin(); }}
    function addIssue() { const n = document.getElementById('new-issue-name').value; if(n) { issues.push({id:'is'+Date.now(), name:n}); renderAdmin(); }}
    function addNewBrand() { brands.push({name: 'ìƒˆ ë¸Œëœë“œ', lenses: []}); openBrandIndex = brands.length - 1; renderAdmin(); }
    function addNewLens(bi) {
        if (!brands[bi].lenses) brands[bi].lenses = [];
        brands[bi].lenses.push({
            name: 'ìƒˆ ì œí’ˆ', 
            tabId: '', 
            bgColor: '#2c3e50', // ëª…ì‹œì  ê¸°ë³¸ìƒ‰ ì§€ì •
            items: [], 
            targetAges:['adult'], 
            targetIssues:['none'], 
            isSale:false, 
            order: (brands[bi].lenses.length + 1) * 10
        });
        renderAdmin();
    }
    function toggleT(bi, li, type, val) { let l = brands[bi].lenses[li]; let arr = (type === 'age') ? (l.targetAges = l.targetAges || []) : (l.targetIssues = l.targetIssues || []); let idx = arr.indexOf(val); if(idx > -1) arr.splice(idx, 1); else arr.push(val); renderApp(); }
    function processExcel() { const input = document.getElementById('excel-input').value.trim(); if(!input) return; input.split('\n').forEach(line => { const cols = line.split('\t'); if(cols.length < 6) return; const [bN, lN, idx, spec, pOff, pSale, sMin, sMax, cMin] = cols.map(c => c.trim()); let b = brands.find(x => x.name === bN); if(!b) { b = {name: bN, lenses: []}; brands.push(b); } let l = b.lenses.find(x => x.name === lN); if(!l) { l = {name: lN, tabId: '', items: [], targetAges:['adult'], targetIssues:['none'], order: b.lenses.length * 10}; b.lenses.push(l); } l.items.push({idx, spec, pOff, pSale, sMin: parseFloat(sMin)||-10, sMax: parseFloat(sMax)||6, cMin: parseFloat(cMin)||-4}); }); renderAdmin(); renderApp(); alert("ì—…ë¡œë“œ ì™„ë£Œ"); }
    // [ì´ˆê¸°í™” í•¨ìˆ˜] - ì•±ì„ ì²˜ìŒ ì‹¤í–‰í•  ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤.
    function init() {
        console.log("ì•„ì´ì  íŠ¸ë¦¬ ì¶©ë‚¨ë„ì²­ì  ì‹œìŠ¤í…œ ì‹œì‘...");
        
        // 1. ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. (ê¸°ì¡´ì— ì •ì˜ëœ í•¨ìˆ˜ í˜¸ì¶œ)
        if (typeof loadDataFromServer === "function") {
            loadDataFromServer();
        } else {
            // ì„œë²„ ì—°ê²° í•¨ìˆ˜ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ ë Œë”ë§
            renderApp();
        }
    }
    init();
    
    // ì „ì²´í™”ë©´ í† ê¸€ í•¨ìˆ˜
    function toggleFullScreen() {
        const btn = document.getElementById('fullscreen-btn');
        
        if (!document.fullscreenElement) {
            // ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜
            document.documentElement.requestFullscreen().then(() => {
                btn.innerHTML = "ğŸ“º í™”ë©´ ì¶•ì†Œ";
                btn.style.background = "#e67e22"; // ì£¼í™©ìƒ‰ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ìƒíƒœ í‘œì‹œ
            }).catch(err => {
                alert(`ì „ì²´í™”ë©´ ì „í™˜ ì‹¤íŒ¨: ${err.message}`);
            });
        } else {
            // ì „ì²´í™”ë©´ í•´ì œ
            if (document.exitFullscreen) {
                document.exitFullscreen();
                btn.innerHTML = "ğŸ“º ì „ì²´í™”ë©´";
                btn.style.background = "#2ecc71"; // ì›ë˜ ë…¹ìƒ‰ìœ¼ë¡œ ë³µêµ¬
            }
        }
    }

    // (ì„ íƒì‚¬í•­) ESC í‚¤ë¡œ ì „ì²´í™”ë©´ì„ ë‚˜ê°”ì„ ë•Œ ë²„íŠ¼ ê¸€ìë¥¼ ì›ë˜ëŒ€ë¡œ ëŒë ¤ì£¼ëŠ” ë¡œì§
    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('fullscreen-btn');
        if (!document.fullscreenElement) {
            btn.innerHTML = "ğŸ“º ì „ì²´í™”ë©´";
            btn.style.background = "#2ecc71";
        }
    });

// [ì´ë¯¸ì§€ ì¹´ë“œ ì¶”ê°€ ê¸°ëŠ¥ - í•˜ë‚˜ë¡œ í†µí•© ë° ê°œì„ ]
    function addNewImageCard() {
        images.push({
            id: 'img_' + Date.now(),
            name: 'ìƒˆ í™ë³´ ì´ë¯¸ì§€ ì¹´ë“œ',
            url: '', 
            tabId: adminSelectedTabId || (categories[1] ? categories[1].id : ''), 
            order: (images.length + 1) * 10,
            targetAges: ['adult', 'student', 'senior'],
            targetIssues: ['none']
        });
        
        renderAdmin(); 
        renderApp();
        alert("ì´ë¯¸ì§€ ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ 'ì¶œë ¥ë  íƒ­'ì„ ì •í•˜ê³  ì´ë¦„ê³¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    }

    // [ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë° ê´€ë¦¬ìì°½ ì—´ê¸°]
    function secureAdminOpen() { 
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); 
        if(pw === "1111") {
            toggleAdmin(); 
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }
    }

    // [ì‹œìŠ¤í…œ ì‹œì‘]
    init();
</script>
</body>
</html>
