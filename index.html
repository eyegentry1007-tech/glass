<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•„ì´ì  íŠ¸ë¦¬ ì¶©ë‚¨ë„ì²­ì  V19.9</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; --sale: #ff4757; }
        body { font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .app-container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: #2c3e50; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid var(--accent); }
        .logo-area h2 { margin: 0; font-size: 1.6em; letter-spacing: -1px; }
        .top-controls { display: flex; gap: 12px; align-items: center; }
        .control-group { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 10px; font-size: 0.9em; }
        select { padding: 8px 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; outline: none; background: white; }
        .tabs-bar { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; overflow-x: auto; padding: 0 10px; }
        .tab { padding: 20px 30px; cursor: pointer; font-weight: 800; color: #888; white-space: nowrap; transition: 0.3s; position: relative; }
        .tab.active { color: var(--accent); }
        .tab.active::after { content:''; position:absolute; bottom:0; left:20%; right:20%; height:4px; background:var(--accent); border-radius:10px 10px 0 0; }
        .content-body { padding: 30px; min-height: 700px; }
        .btn-ui { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 0.95em; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 6px; }
        .btn-ui:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); filter: brightness(1.1); }
        .btn-small { padding: 5px 10px; font-size: 0.8em; background: #95a5a6; color: white; border-radius: 6px; border: none; cursor: pointer; transition: 0.2s; }
        .matrix-container { width: 100%; overflow-x: auto; background: white; border-radius: 15px; border: 1px solid #e0e0e0; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .matrix-title { padding: 15px 25px; font-size: 1.2em; font-weight: bold; color: white; display: flex; justify-content: space-between; align-items: center; }
        .matrix-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        .matrix-table th { padding: 20px 15px; border-bottom: 2px solid #eee; border-right: 1px solid #f0f0f0; }
        .col-header-info { display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .m-grade-name { font-size: 1.1em; font-weight: 900; margin-bottom: 5px; }
        .m-grade-desc { font-size: 0.8em; font-weight: normal; color: rgba(255,255,255,0.9); line-height: 1.4; max-width: 180px; }
        .m-grade-specs { font-size: 0.75em; background: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 5px; margin-top: 5px; color: white; }
        .matrix-table td { padding: 18px 10px; border-bottom: 1px solid #f0f0f0; border-right: 1px solid #f0f0f0; text-align: center; }
        .idx-col { background: #f8f9fa; font-weight: bold; width: 80px; color: #666; }
        .price-sale-m { font-size: 1.15em; font-weight: 900; }
        .sale-text { color: var(--sale); }
        .off-text { font-size: 0.75em; color: #bbb; text-decoration: line-through; display: block; }
        .disabled-row { opacity: 0.15; filter: grayscale(1); pointer-events: none; }
        .card-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; }
        @media (max-width: 1400px) { .card-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
        .lens-card { border-radius: 15px; background: white; border: 1px solid #eee; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .card-head { padding: 15px; color: white; font-weight: 900; text-align: center; font-size: 1.1em; }
        .lens-one-liner { padding: 10px 15px; background: #f0f7ff; border-bottom: 1px solid #e0e0e0; font-size: 0.88em; color: #2c3e50; border-left: 5px solid var(--accent); margin: 8px; border-radius: 4px; line-height: 1.5; font-weight: 600; }
        .card-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .card-table th { background: #f8f9fa; font-size: 0.75em; color: #888; padding: 8px; border-bottom: 1px solid #eee; }
        .card-table td { padding: 12px 8px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; text-align: center; font-size: 0.9em; }
        .price-box { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 2px; padding-right: 10px; }
        .p-off { font-size: 0.78em; color: #bbb; text-decoration: line-through; }
        .p-sale { color: #d63031; font-weight: 900; font-size: 1.05em; }
        .tab-banner-img { width: 100%; max-width: 1200px; display: block; margin: 40px auto 0; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        #ui-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1999; }
        #matrix-modal, #excel-modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:95%; height:90%; background:white; z-index:2000; padding:30px; border-radius:15px; box-shadow: 0 0 100px rgba(0,0,0,0.5); overflow-y:auto; }
        .admin-panel { display: none; background: #f1f3f5; padding: 30px; border-bottom: 2px solid #ddd; max-height: 85vh; overflow-y: auto; }
        .admin-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dee2e6; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tag-row { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; }
        .matrix-editor-table { width:100%; border-collapse: collapse; margin-top: 15px; }
        .matrix-editor-table th, .matrix-editor-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .matrix-editor-table input[type="text"] { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; }
        .m-header-actions { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 10px; }
        input[type="color"] { width: 32px; height: 32px; border: none; background: none; cursor: pointer; border-radius: 50%; overflow: hidden; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="logo-area"><h2>ì•„ì´ì  íŠ¸ë¦¬ ì¶©ë‚¨ë„ì²­ì </h2><span style="font-size:0.8em; opacity:0.7; margin-left:10px;">V19.9 MASTER</span></div>
        <div class="top-controls">
            <div class="control-group"><label>ëŒ€ìƒ:</label><select id="ageSel" onchange="renderApp()"><option value="adult" selected>ì„±ì¸</option><option value="student">í•™ìƒ</option><option value="senior">ì‹œë‹ˆì–´</option></select></div>
            <div class="control-group"><label>ë¶ˆí¸í•¨:</label><select id="issueSel" onchange="renderApp()"></select></div>
            <div class="control-group">R <select id="rs" onchange="renderApp()"></select><select id="rc" onchange="renderApp()"></select> L <select id="ls" onchange="renderApp()"></select><select id="lc" onchange="renderApp()"></select></div>
            <button class="btn-ui" style="background:var(--accent);" onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬ì</button>
        </div>
    </header>

    <div id="ui-overlay" onclick="closeAllModals()"></div>

    <div id="matrix-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3>ğŸ”³ ë§¤íŠ¸ë¦­ìŠ¤ ê°€ê²©í‘œ ê´€ë¦¬ì (ë¸Œëœë“œë³„)</h3>
            <button class="btn-ui" style="background:#666;" onclick="closeMatrix()">ì°½ ë‹«ê¸°</button>
        </div>
        <div id="matrix-editor" style="display:none; border: 3px solid var(--accent); padding: 25px; border-radius: 15px; background: #fff; margin-bottom:20px;">
            <div style="display:flex; gap:15px; margin-bottom:15px; flex-wrap:wrap; align-items:center; background:#f8f9fa; padding:15px; border-radius:10px;">
                ë¸Œëœë“œ: <input type="text" id="m-brand" style="width:120px;" placeholder="ë¸Œëœë“œ">
                ì»¬ëŸ¬: <input type="color" id="m-brand-color" value="#2c3e50">
                ì‹œë¦¬ì¦ˆëª…: <input type="text" id="m-name" style="width:180px;" placeholder="ì‹œë¦¬ì¦ˆëª…">
                ì¶œë ¥ íƒ­: <select id="m-tab"></select>
            </div>
            <div style="background: #f0f7ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #d0e7ff; font-size: 0.9em;">
                <b>âœ¨ AI ì¶”ì²œ ì„¤ì •:</b>&nbsp;&nbsp;
                ëŒ€ìƒ ì—°ë ¹: <span id="m-ages-wrap"></span>&nbsp;&nbsp;|&nbsp;&nbsp;
                í•´ë‹¹ ì¦ìƒ: <span id="m-issues-wrap"></span>
            </div>
            <div style="overflow-x:auto;">
                <table class="matrix-editor-table"><thead><tr id="m-header"></tr></thead><tbody id="m-body"></tbody></table>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-ui" style="background:var(--success);" onclick="saveMatrixToMemory()">âœ… ë§¤íŠ¸ë¦­ìŠ¤ ì €ì¥</button>
                <button class="btn-ui" style="background:#666;" onclick="hideMatrixEditor()">ì·¨ì†Œ</button>
            </div>
        </div>
        <div id="matrix-list-area">
            <h4>ë“±ë¡ëœ ë§¤íŠ¸ë¦­ìŠ¤ ëª©ë¡</h4>
            <div id="saved-matrices-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
            <button class="btn-ui" style="background:var(--accent); margin-top:20px;" onclick="showMatrixEditor()">+ ìƒˆ ë¸Œëœë“œ ë§¤íŠ¸ë¦­ìŠ¤ ì¶”ê°€</button>
        </div>
    </div>

    <div id="excel-modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>ğŸ“Š ì—‘ì…€ ë°ì´í„° ì¼ê´„ ì—…ë¡œë“œ</h3>
            <button class="btn-ui" style="background:#666;" onclick="closeExcelModal()">ë‹«ê¸°</button>
        </div>
        <p style="font-size:0.85em; color:#d63031; font-weight:bold; margin:10px 0;">ìˆœì„œ: ë¸Œëœë“œ | ì œí’ˆëª… | êµ´ì ˆë¥  | ì„¤ê³„ | ê¶Œì¥ê°€ | í• ì¸ê°€ | S_Min | S_Max | C_Min</p>
        <textarea id="excel-input" style="width:100%; height:60%; font-family:monospace; padding:15px; border:1px solid #ccc; border-radius:10px;" placeholder="ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <div style="margin-top:20px; text-align:right;">
            <button class="btn-ui" style="background:var(--danger);" onclick="processExcel()">ğŸš€ ì¦‰ì‹œ ì ìš© (ë®ì–´ì“°ê¸°)</button>
        </div>
    </div>

    <div id="admin-panel" class="admin-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
            <div style="display:flex; gap:10px;">
                <button class="btn-ui" style="background:var(--accent); padding:15px 25px;" onclick="openMatrix()">ğŸ”³ ë§¤íŠ¸ë¦­ìŠ¤ ê°€ê²©í‘œ ê´€ë¦¬</button>
                <button class="btn-ui" style="background:var(--success);" onclick="openExcelModal()">ğŸ“Š ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ</button>
            </div>
            <div style="display:flex; gap:12px;">
                <button class="btn-ui" style="background:#9b59b6;" onclick="exportData()">ğŸ“¤ ë°±ì—…ì €ì¥</button>
                <button id="saveBtn" class="btn-ui" style="background:var(--success); border: 2px solid #fff;" onclick="saveData()">ğŸ’¾ ì„œë²„ì— ìµœì¢…ì €ì¥</button>
                <button class="btn-ui" style="background:#666;" onclick="toggleAdmin()">âŒ ë‹«ê¸°</button>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1.3fr 1fr 1.5fr; gap:25px;">
            <div class="admin-section">
                <h4>ğŸ“‚ íƒ­ ê´€ë¦¬ ë° ì´ë¯¸ì§€ ì„¤ì •</h4>
                <div id="admin-tags-cats" style="max-height: 500px; overflow-y: auto; padding-right:5px;"></div>
                <div style="margin-top:15px; display:flex; gap:5px;"><input type="text" id="new-cat-name" placeholder="ìƒˆ íƒ­ ì´ë¦„" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ddd;"><button class="btn-ui" style="background:var(--success);" onclick="addCategory()">+</button></div>
            </div>
            <div class="admin-section"><h4>â“ ì¦ìƒ ê´€ë¦¬</h4><div id="admin-tags-issues"></div><div style="margin-top:15px; display:flex; gap:5px;"><input type="text" id="new-issue-name" placeholder="ìƒˆ ì¦ìƒ ì´ë¦„" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ddd;"><button class="btn-ui" style="background:var(--success);" onclick="addIssue()">+</button></div></div>
            <div class="admin-section" style="background: #eef2f7; border: 2px solid var(--accent);"><h4>ğŸ”¢ ì¶œë ¥ ìˆœì„œ ê´€ë¦¬ <select id="admin-order-tab-select" onchange="adminSelectedTabId = this.value; renderAdmin();"></select></h4><div id="admin-lens-order-list" style="max-height: 400px; overflow-y: auto; padding-right:5px;"></div></div>
        </div>

        <div class="admin-section"><h4>ğŸ“¦ ì¼ë°˜ ì¹´ë“œí˜• ê°€ê²©í‘œ ì„¤ì •</h4><div id="admin-brands-list"></div><button class="btn-ui" style="background:var(--accent); margin-top:20px;" onclick="addNewBrand()">+ ìƒˆ ë¸Œëœë“œ ì¶”ê°€</button></div>
    </div>

    <div class="tabs-bar" id="tab-nav"></div>
    <div id="main-display" class="content-body"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBV128h-2uzJUjGsazgK0XXn6f0uVnMyV8",
        authDomain: "eyegentry-5c7de.firebaseapp.com",
        databaseURL: "https://eyegentry-5c7de-default-rtdb.firebaseio.com",
        projectId: "eyegentry-5c7de",
        storageBucket: "eyegentry-5c7de.firebasestorage.app",
        messagingSenderId: "772851251300",
        appId: "1:772851251300:web:330b44914302a6b0048771"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let categories = [{ id: 'ai', name: 'âœ¨ AI ì¶”ì²œ', order: 0, img:'' }, { id: 't1', name: 'ë‹¨ì´ˆì ', order: 1, img:'' }, { id: 't2', name: 'ë‹¤ì´ˆì ', order: 2, img:'' }];
    let brands = [], issues = [{id:'none', name:'ì—†ìŒ'}, {id:'fatigue', name:'í”¼ë¡œ'}], matrices = [];
    let currentTabId = 'ai', adminSelectedTabId = 't1', openBrandIndex = null, editingMatrix = null;
    const fixedIndices = ['1.56', '1.60', '1.67', '1.74'];

    function loadDataFromServer() {
        db.ref('lensData').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                categories = data.categories || categories;
                brands = data.brands || [];
                issues = data.issues || issues;
                matrices = data.matrices || [];
                renderApp(); renderIssueSelect();
                if(document.getElementById('admin-panel').style.display === 'block') renderAdmin();
            } else { renderApp(); renderIssueSelect(); }
        });
    }

    function init() {
        const sOpts = getPowerOptions(false, 0); const cOpts = getPowerOptions(true, 0);
        document.getElementById('rs').innerHTML = sOpts; document.getElementById('ls').innerHTML = sOpts;
        document.getElementById('rc').innerHTML = cOpts; document.getElementById('lc').innerHTML = cOpts;
        loadDataFromServer();
    }

    function getPowerOptions(isCyl, val) {
        let h = '';
        if(isCyl) { for(let i=0; i>=-6; i-=0.25) h += `<option value="${i}" ${i==0?'selected':''}>${i.toFixed(2)}</option>`; }
        else { for(let i=10; i>=-20; i-=0.25) h += `<option value="${i}" ${i==0?'selected':''}>${i.toFixed(2)}</option>`; }
        return h;
    }

    function renderIssueSelect() { document.getElementById('issueSel').innerHTML = issues.map(is => `<option value="${is.id}">${is.name}</option>`).join(''); }

    function renderApp() {
        const sortedCats = [...categories].sort((a,b) => a.order - b.order);
        document.getElementById('tab-nav').innerHTML = sortedCats.map(c => `<div class="tab ${currentTabId===c.id?'active':''}" onclick="currentTabId='${c.id}'; renderApp();">${c.name}</div>`).join('');
        const rs = parseFloat(document.getElementById('rs').value), rc = parseFloat(document.getElementById('rc').value);
        const ls = parseFloat(document.getElementById('ls').value), lc = parseFloat(document.getElementById('lc').value);
        const age = document.getElementById('ageSel').value, issue = document.getElementById('issueSel').value;
        const mainDisplay = document.getElementById('main-display');
        let finalHtml = '';

        // 1. ë§¤íŠ¸ë¦­ìŠ¤ ë Œì¦ˆ ì¶œë ¥
        matrices.filter(m => {
            const matchTab = (currentTabId === m.tabId);
            const matchAI = (currentTabId === 'ai' && m.targetIssues && m.targetIssues.includes(issue) && issue !== 'none' && m.targetAges && m.targetAges.includes(age));
            return matchTab || matchAI;
        }).forEach(m => {
            let mHtml = `<div class="matrix-container">
                <div class="matrix-title" style="background:${m.brandColor || '#2c3e50'}"><span>${m.brand} - ${m.name}</span></div>
                <table class="matrix-table"><thead><tr><th class="idx-col">êµ´ì ˆë¥ </th>`;
            m.cols.forEach(col => {
                mHtml += `<th style="background:${col.bgColor || '#f8f9fa'}; color:${col.bgColor?'white':'#333'}">
                    <div class="col-header-info">
                        <span class="m-grade-name">${col.name}</span>
                        ${col.desc ? `<span class="m-grade-desc">${col.desc}</span>` : ''}
                        ${(col.addInfo || col.corridor) ? `<span class="m-grade-specs">${col.addInfo ? `ADD: ${col.addInfo}` : ''} ${col.addInfo && col.corridor ? '/' : ''} ${col.corridor ? `ëˆ„ì§„: ${col.corridor}` : ''}</span>` : ''}
                        ${col.isSale ? '<span class="sale-badge" style="position:static; margin-top:5px; padding:2px 8px;">SALE</span>' : ''}
                    </div>
                </th>`;
            });
            mHtml += `</tr></thead><tbody>`;
            fixedIndices.forEach(idx => {
                const safeKey = 'idx_' + idx.replace('.', '');
                const isOutOfRange = (rs > (idx==='1.56'?4:6) || rs < (idx==='1.56'?-6:-10) || rc < -4);
                mHtml += `<tr class="${isOutOfRange?'disabled-row':''}">
                    <td class="idx-col">${idx}</td>`;
                m.cols.forEach(col => {
                    const p = col.prices[safeKey] || {off:'', sale:''};
                    mHtml += `<td style="background:${col.isSale?'#fff5f5':'none'}">
                        ${p.off ? `<span class="off-text">${Number(p.off).toLocaleString()}ì›</span>` : ''}
                        <span class="price-sale-m ${col.isSale?'sale-text':''}">${p.sale ? Number(p.sale).toLocaleString()+'ì›' : '-'}</span>
                    </td>`;
                });
                mHtml += `</tr>`;
            });
            mHtml += `</tbody></table></div>`;
            finalHtml += mHtml;
        });

        // 2. ì¼ë°˜ ë Œì¦ˆ ì¹´ë“œ ì¶œë ¥
        let cardHtml = '<div class="card-grid">';
        brands.forEach(b => b.lenses.forEach(l => {
            const matchTab = (currentTabId === l.tabId);
            const matchAI = (currentTabId === 'ai' && l.targetIssues && l.targetIssues.includes(issue) && issue !== 'none' && l.targetAges && l.targetAges.includes(age));
            if(matchTab || matchAI) {
                let rows = ''; let hasMatch = false;
                l.items.forEach(it => {
                    const out = (rs > it.sMax || rs < it.sMin || rc < it.cMin || ls > it.sMax || ls < it.sMin || lc < it.cMin);
                    if(!out) hasMatch = true;
                    rows += `<tr class="${out?'disabled-row':''}">
                        <td>${it.idx}</td><td>${it.spec}</td>
                        <td style="text-align:right;">
                            <div class="price-box">
                                <span class="p-off">${it.pOff ? Number(it.pOff).toLocaleString()+'ì›' : ''}</span>
                                <span class="p-sale">${it.pSale ? Number(it.pSale).toLocaleString()+'ì›' : '0ì›'}</span>
                            </div>
                        </td>
                    </tr>`;
                });
                if(hasMatch || (rs===0 && ls===0)) {
                    cardHtml += `<div class="lens-card">
                        <div class="card-head" style="background:${l.bgColor || '#2c3e50'}">${b.name} ${l.name}</div>
                        ${l.desc ? `<div class="lens-one-liner">ğŸ’¡ ${l.desc}</div>` : ''}
                        <table class="card-table">
                            <thead><tr><th>êµ´ì ˆë¥ </th><th>ì„¤ê³„</th><th style="text-align:right;">ê°€ê²©</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
                }
            }
        }));
        cardHtml += '</div>';
        finalHtml += cardHtml;

        const currentTabObj = categories.find(c => c.id === currentTabId);
        if(currentTabObj && currentTabObj.img) {
            finalHtml += `<img src="${currentTabObj.img}" class="tab-banner-img" alt="ë°°ë„ˆ">`;
        }
        mainDisplay.innerHTML = finalHtml || `<p style="text-align:center; padding:100px; color:#bbb; font-size:1.2em;">ğŸ” ì¡°ê±´ì— ë§ëŠ” ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    }

    function renderAdmin() {
        document.getElementById('admin-order-tab-select').innerHTML = categories.filter(c=>c.id!=='ai').sort((a,b)=>a.order-b.order).map(c => `<option value="${c.id}" ${adminSelectedTabId===c.id?'selected':''}>${c.name} íƒ­ ì„¤ì •</option>`).join('');
        
        document.getElementById('admin-tags-cats').innerHTML = categories.map((c, idx) => `
            <div class="tag-row" style="flex-direction:column; align-items:stretch; gap:8px; padding:15px; background:#fff; border:1px solid #ddd; margin-bottom:15px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:0.8em; color:#999;">ìˆœì„œ</span>
                        <input type="number" value="${c.order}" style="width:45px; padding:5px; border-radius:4px; border:1px solid #ccc;" onchange="categories[${idx}].order=parseInt(this.value); renderApp();">
                        <input type="text" value="${c.name}" style="padding:5px; font-weight:bold; border-radius:4px; border:1px solid #ccc;" onchange="categories[${idx}].name=this.value; renderApp();">
                    </div>
                    <button class="btn-small" style="background:var(--danger)" onclick="delCategory('${c.id}')">ì‚­ì œ</button>
                </div>
                <div style="background:#f1f3f5; padding:10px; border-radius:8px;">
                    <div style="font-size:0.75em; color:var(--primary); font-weight:bold; margin-bottom:5px;">ğŸ–¼ï¸ í•˜ë‹¨ í™ë³´ ì´ë¯¸ì§€ URL</div>
                    <input type="text" value="${c.img||''}" placeholder="http://... ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”" style="width:100%; padding:10px; border:1px solid #ccc; font-size:0.85em; border-radius:4px;" onchange="categories[${idx}].img=this.value; renderApp();">
                </div>
            </div>`).join('');

        document.getElementById('admin-tags-issues').innerHTML = issues.map((is, idx) => `<div class="tag-row"><input type="text" value="${is.name}" style="flex:1; padding:5px;" onchange="issues[${idx}].name=this.value; renderIssueSelect();"><button class="btn-small" style="background:var(--danger)" onclick="delIssue('${is.id}')">Ã—</button></div>`).join('');
        
        let orderList = [];
        brands.forEach((b, bi) => b.lenses.forEach((l, li) => { if(l.tabId === adminSelectedTabId) orderList.push({ type: 'normal', bi, li, name: l.name, bName: b.name, order: l.order || 99 }); }));
        matrices.forEach((m, mi) => { if(m.tabId === adminSelectedTabId) orderList.push({ type: 'matrix', mi, name: `[ë§¤íŠ¸ë¦­ìŠ¤] ${m.brand} - ${m.name}`, bName: m.brand, order: m.order || 99 }); });
        orderList.sort((a, b) => a.order - b.order);
        document.getElementById('admin-lens-order-list').innerHTML = orderList.map(item => `<div class="tag-row" style="background:#fff;"><button class="btn-small" onclick="moveOrderItem('${item.type}', ${item.bi??item.mi}, ${item.li??0}, -1)">â–²</button><button class="btn-small" onclick="moveOrderItem('${item.type}', ${item.bi??item.mi}, ${item.li??0}, 1)">â–¼</button><b>${item.name}</b></div>`).join('');

        let bHtml = '';
        brands.forEach((b, bi) => {
            const active = openBrandIndex === bi;
            bHtml += `<div style="border:1px solid #ddd; border-radius:12px; margin-bottom:12px; overflow:hidden;"><div style="cursor:pointer; background:#e9ecef; padding:15px; display:flex; justify-content:space-between; align-items:center;" onclick="openBrandIndex=${active?null:bi}; renderAdmin();"><span><b>${b.name}</b> (${b.lenses.length})</span><div><button class="btn-small" onclick="event.stopPropagation(); moveItem(brands, ${bi}, -1); renderAdmin();">â–²</button><button class="btn-small" onclick="event.stopPropagation(); moveItem(brands, ${bi}, 1); renderAdmin();">â–¼</button></div></div><div style="padding:20px; display:${active?'block':'none'}">
                ë¸Œëœë“œëª…: <input type="text" value="${b.name}" style="padding:8px; border-radius:6px; border:1px solid #ccc;" onchange="brands[${bi}].name=this.value; renderApp();"> <button class="btn-small" style="background:var(--danger); float:right;" onclick="if(confirm('ì‚­ì œ?')){brands.splice(${bi},1); renderAdmin();}">ë¸Œëœë“œ ì‚­ì œ</button>${b.lenses.map((l, li) => `
                <div class="admin-lens-item" style="border:1px solid #eee; padding:15px; margin-top:15px; border-radius:10px; background:#fdfdfd;">
                    <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center;">ğŸ›¡ï¸ <input type="text" value="${l.name}" onchange="brands[${bi}].lenses[${li}].name=this.value; renderApp();" style="flex:1; padding:8px;" placeholder="ì œí’ˆëª…"> <input type="color" value="${l.bgColor || '#2c3e50'}" onchange="brands[${bi}].lenses[${li}].bgColor=this.value; renderApp();" title="ì¹´ë“œ ìƒ‰ìƒ"> <label><input type="checkbox" ${l.isSale?'checked':''} onchange="brands[${bi}].lenses[${li}].isSale=this.checked; renderApp();"> ğŸ”¥í–‰ì‚¬</label> <select onchange="brands[${bi}].lenses[${li}].tabId=this.value; renderAdmin(); renderApp();">${categories.filter(c=>c.id!=='ai').map(c=>`<option value="${c.id}" ${l.tabId===c.id?'selected':''}>${c.name}</option>`).join('')}</select>
                    <button class="btn-small" onclick="moveItem(brands[${bi}].lenses, ${li}, -1); renderAdmin();">â–²</button><button class="btn-small" onclick="moveItem(brands[${bi}].lenses, ${li}, 1); renderAdmin();">â–¼</button><button onclick="brands[${bi}].lenses.splice(${li},1); renderAdmin();">Ã—</button></div>
                    <div style="margin-bottom:10px;"><input type="text" value="${l.desc||''}" style="width:95%; padding:8px; border:1px solid #eee; border-radius:4px;" onchange="brands[${bi}].lenses[${li}].desc=this.value; renderApp();" placeholder="ğŸ’¡ í•œì¤„ ì„¤ëª…"></div>
                    <div style="font-size:0.85em; margin-bottom:12px; background:#f8f9fa; padding:10px; border-radius:8px;">ëŒ€ìƒ: ${['student','adult','senior'].map(a=>`<label style="margin-right:12px;"><input type="checkbox" ${l.targetAges && l.targetAges.includes(a)?'checked':''} onchange="toggleF(${bi},${li},'age','${a}')">${a}</label>`).join('')} | ë¶ˆí¸í•¨: ${issues.map(is=>`<label style="margin-right:12px;"><input type="checkbox" ${l.targetIssues && l.targetIssues.includes(is.id)?'checked':''} onchange="toggleF(${bi},${li},'issue','${is.id}')">${is.name}</label>`).join('')}</div>
                    ${l.items.map((it, ii) => `<div style="display:grid; grid-template-columns: 60px 1fr 100px 100px 180px 30px; gap:8px; margin-top:8px;"><input type="text" value="${it.idx}" onchange="brands[${bi}].lenses[${li}].items[${ii}].idx=this.value; renderApp();"><input type="text" value="${it.spec}" onchange="brands[${bi}].lenses[${li}].items[${ii}].spec=this.value; renderApp();"><input type="text" value="${it.pOff}" onchange="brands[${bi}].lenses[${li}].items[${ii}].pOff=this.value; renderApp();" placeholder="ê¶Œì¥ê°€"><input type="text" value="${it.pSale}" onchange="brands[${bi}].lenses[${li}].items[${ii}].pSale=this.value; renderApp();" placeholder="í• ì¸ê°€"><div style="font-size:0.75em; display:flex; gap:4px; align-items:center; background:#eee; padding:5px; border-radius:6px;">S<input type="number" step="0.25" value="${it.sMin}" style="width:45px" onchange="brands[${bi}].lenses[${li}].items[${ii}].sMin=parseFloat(this.value)">~<input type="number" step="0.25" value="${it.sMax}" style="width:45px" onchange="brands[${bi}].lenses[${li}].items[${ii}].sMax=parseFloat(this.value)"> C<input type="number" step="0.25" value="${it.cMin||0}" style="width:45px" onchange="brands[${bi}].lenses[${li}].items[${ii}].cMin=parseFloat(this.value)"></div><button onclick="brands[${bi}].lenses[${li}].items.splice(${ii},1); renderAdmin();">Ã—</button></div>`).join('')}<button class="btn-ui" style="background:#3498db; font-size:0.8em; margin-top:10px; padding:6px 12px;" onclick="brands[${bi}].lenses[${li}].items.push({idx:'1.60', spec:'', pOff:'', pSale:'', sMin:-10, sMax:6, cMin:-4}); renderAdmin();">+ ì‚¬ì–‘ ì¶”ê°€</button></div>`).join('')}<button class="btn-ui" style="background:var(--success); margin-top:15px; width:100%;" onclick="addNewLens(${bi})">+ ìƒˆ ì œí’ˆ ì¹´ë“œ ì¶”ê°€</button></div></div>`;
        });
        document.getElementById('admin-brands-list').innerHTML = bHtml;
    }

    function openMatrix() { document.getElementById('ui-overlay').style.display='block'; document.getElementById('matrix-modal').style.display='block'; renderSavedMatrices(); }
    function closeMatrix() { document.getElementById('ui-overlay').style.display='none'; document.getElementById('matrix-modal').style.display='none'; hideMatrixEditor(); }
    function openExcelModal() { document.getElementById('ui-overlay').style.display='block'; document.getElementById('excel-modal').style.display='block'; }
    function closeExcelModal() { document.getElementById('ui-overlay').style.display='none'; document.getElementById('excel-modal').style.display='none'; }
    function closeAllModals() { closeMatrix(); closeExcelModal(); }

    function renderSavedMatrices() { document.getElementById('saved-matrices-list').innerHTML = matrices.map((m, i) => `<div class="matrix-list-item" style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;"><span><b>${m.brand}</b> - ${m.name}</span><div><button class="btn-small" style="background:var(--accent);" onclick="editMatrix(${i})">ìˆ˜ì •</button><button class="btn-small" style="background:var(--danger); margin-left:5px;" onclick="if(confirm('ì‚­ì œ?')){matrices.splice(${i},1); renderSavedMatrices(); renderApp();}">ì‚­ì œ</button></div></div>`).join(''); }
    function showMatrixEditor() { editingMatrix = { brand:'', brandColor:'#2c3e50', name:'', tabId:'t2', targetAges:['adult'], targetIssues:['none'], cols:[{name:'', desc:'', addInfo:'', corridor:'', bgColor:'#2c3e50', prices:{}, isSale: false}], order: matrices.length+1 }; updateMatrixEditorUI(); }
    function editMatrix(i) { editingMatrix = JSON.parse(JSON.stringify(matrices[i])); if(!editingMatrix.targetAges) editingMatrix.targetAges = ['adult']; if(!editingMatrix.targetIssues) editingMatrix.targetIssues = ['none']; editingMatrix.originalIndex = i; updateMatrixEditorUI(); }
    function hideMatrixEditor() { document.getElementById('matrix-editor').style.display = 'none'; }
    function updateMatrixEditorUI() {
        document.getElementById('matrix-editor').style.display = 'block';
        document.getElementById('m-brand').value = editingMatrix.brand; document.getElementById('m-brand-color').value = editingMatrix.brandColor || '#2c3e50';
        document.getElementById('m-name').value = editingMatrix.name; document.getElementById('m-tab').innerHTML = categories.filter(c=>c.id!=='ai').map(c=>`<option value="${c.id}" ${c.id===editingMatrix.tabId?'selected':''}>${c.name}</option>`).join('');
        document.getElementById('m-ages-wrap').innerHTML = ['student','adult','senior'].map(a => `<label style="margin-right:10px;"><input type="checkbox" class="m-age-check" value="${a}" ${editingMatrix.targetAges.includes(a)?'checked':''}> ${a}</label>`).join('');
        document.getElementById('m-issues-wrap').innerHTML = issues.map(is => `<label style="margin-right:10px;"><input type="checkbox" class="m-issue-check" value="${is.id}" ${editingMatrix.targetIssues.includes(is.id)?'checked':''}> ${is.name}</label>`).join('');
        let hHtml = `<th>êµ´ì ˆë¥ </th>`; editingMatrix.cols.forEach((col, i) => { hHtml += `<th><input type="text" class="m-col-name" data-col="${i}" value="${col.name}" placeholder="ë“±ê¸‰ëª…" onchange="syncME()"><br><input type="text" class="m-col-desc" data-col="${i}" value="${col.desc||''}" placeholder="ì„¤ëª…" style="font-size:0.8em; margin-top:5px;" onchange="syncME()"><div style="display:flex; gap:2px; margin-top:5px;"><input type="text" class="m-col-add" data-col="${i}" value="${col.addInfo||''}" placeholder="ADD" style="font-size:0.75em;" onchange="syncME()"><input type="text" class="m-col-cor" data-col="${i}" value="${col.corridor||''}" placeholder="ëˆ„ì§„" style="font-size:0.75em;" onchange="syncME()"></div><div class="m-header-actions"><button class="btn-small" onclick="moveMECol(${i},-1)">â—€</button><button class="btn-small" onclick="moveMECol(${i},1)">â–¶</button><input type="color" class="m-col-color" data-col="${i}" value="${col.bgColor||'#2c3e50'}" onchange="syncME()"><label style="font-size:0.75em; cursor:pointer;"><input type="checkbox" class="m-col-sale" data-col="${i}" ${col.isSale?'checked':''} onchange="syncME()"> ğŸ”¥</label><button class="btn-small" style="background:var(--danger)" onclick="editingMatrix.cols.splice(${i},1); updateMatrixEditorUI();">Ã—</button></div></th>`; });
        hHtml += `<th style="cursor:pointer; background:var(--accent); color:white;" onclick="editingMatrix.cols.push({name:'', desc:'', addInfo:'', corridor:'', bgColor:'#2c3e50', prices:{}, isSale:false}); updateMatrixEditorUI();">+ ë“±ê¸‰ì¶”ê°€</th>`;
        document.getElementById('m-header').innerHTML = hHtml;
        let bHtml = ''; fixedIndices.forEach(idx => { const safeKey = 'idx_' + idx.replace('.',''); bHtml += `<tr><td style="background:#f8f9fa; font-weight:bold;">${idx}</td>`; editingMatrix.cols.forEach((col, i) => { const p = col.prices[safeKey] || {off:'', sale:''}; bHtml += `<td><div style="display:flex; flex-direction:column; gap:4px;"><input type="text" class="m-price-off" data-idx="${idx}" data-col="${i}" value="${p.off}" placeholder="ê¶Œì¥ê°€" onchange="syncME()"><input type="text" class="m-price-sale" data-idx="${idx}" data-col="${i}" value="${p.sale}" placeholder="í• ì¸ê°€" onchange="syncME()"></div></td>`; }); bHtml += `<td></td></tr>`; });
        document.getElementById('m-body').innerHTML = bHtml;
    }
    function syncME() {
        editingMatrix.brand = document.getElementById('m-brand').value; editingMatrix.brandColor = document.getElementById('m-brand-color').value;
        editingMatrix.name = document.getElementById('m-name').value; editingMatrix.tabId = document.getElementById('m-tab').value; 
        editingMatrix.targetAges = Array.from(document.querySelectorAll('.m-age-check:checked')).map(el => el.value);
        editingMatrix.targetIssues = Array.from(document.querySelectorAll('.m-issue-check:checked')).map(el => el.value);
        editingMatrix.cols.forEach((col, i) => { 
            col.name = document.querySelector(`.m-col-name[data-col="${i}"]`).value; col.desc = document.querySelector(`.m-col-desc[data-col="${i}"]`).value;
            col.addInfo = document.querySelector(`.m-col-add[data-col="${i}"]`).value; col.corridor = document.querySelector(`.m-col-cor[data-col="${i}"]`).value;
            col.bgColor = document.querySelector(`.m-col-color[data-col="${i}"]`).value; col.isSale = document.querySelector(`.m-col-sale[data-col="${i}"]`).checked;
            fixedIndices.forEach(idx => { const safeKey = 'idx_' + idx.replace('.',''); const off = document.querySelector(`.m-price-off[data-idx="${idx}"][data-col="${i}"]`).value; const sale = document.querySelector(`.m-price-sale[data-idx="${idx}"][data-col="${i}"]`).value; col.prices[safeKey] = { off, sale }; }); 
        });
    }
    function moveMECol(i, dir) { syncME(); let target = i + dir; if(target>=0 && target<editingMatrix.cols.length) { [editingMatrix.cols[i], editingMatrix.cols[target]] = [editingMatrix.cols[target], editingMatrix.cols[i]]; updateMatrixEditorUI(); } }
    function saveMatrixToMemory() { syncME(); if(!editingMatrix.brand) return alert("ë¸Œëœë“œ í•„ìˆ˜"); if(editingMatrix.originalIndex!==undefined) matrices[editingMatrix.originalIndex] = editingMatrix; else matrices.push(editingMatrix); hideMatrixEditor(); renderSavedMatrices(); renderApp(); }
    function processExcel() {
        const input = document.getElementById('excel-input').value.trim(); if(!input) return; if(!confirm("ê¸°ì¡´ ë Œì¦ˆ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš°ê³  ë®ì–´ì“¸ê¹Œìš”?")) return;
        const newBrands = [];
        input.split('\n').forEach(line => {
            const cols = line.includes('\t') ? line.split('\t') : line.split(','); if(cols.length < 6 || cols[0].includes('ë¸Œëœë“œ')) return;
            const [bN, lN, idx, spec, pO, pS, sMn, sMx, cMn] = cols.map(c => c.trim().replace(/"/g, ''));
            let b = newBrands.find(x => x.name === bN); if(!b) { b = { name: bN, lenses: [], brandColor: '#2c3e50' }; newBrands.push(b); }
            let l = b.lenses.find(x => x.name === lN); if(!l) { l = { name: lN, tabId: 't1', bgColor: '#2c3e50', order: b.lenses.length+1, isSale: false, targetAges:['adult'], targetIssues:['none'], desc: '', items: [] }; b.lenses.push(l); }
            l.items.push({ idx: idx, spec: spec, pOff: pO||'0', pSale: pS||'0', sMin: parseFloat(sMn)||-10, sMax: parseFloat(sMx)||6, cMin: parseFloat(cMn)||-4 });
        });
        if(newBrands.length > 0) { brands = newBrands; renderApp(); renderAdmin(); closeExcelModal(); alert("ë°ì´í„° ì ìš© ì™„ë£Œ!"); }
    }
    function moveOrderItem(type, mi_bi, li, dir) { if(type === 'matrix') { let target = mi_bi + dir; if(target >=0 && target < matrices.length) { [matrices[mi_bi].order, matrices[target].order] = [matrices[target].order || 99, matrices[mi_bi].order || 99]; [matrices[mi_bi], matrices[target]] = [matrices[target], matrices[mi_bi]]; } } else { moveItem(brands[mi_bi].lenses, li, dir); } renderAdmin(); renderApp(); }
    function moveItem(arr, idx, dir) { let target = idx + dir; if(target >= 0 && target < arr.length) { [arr[idx].order, arr[target].order] = [arr[target].order||99, arr[idx].order||99]; [arr[idx], arr[target]] = [arr[target], arr[idx]]; } renderAdmin(); }
    function toggleF(bi, li, type, val) { let l = brands[bi].lenses[li]; let arr = type === 'age' ? (l.targetAges = l.targetAges || []) : (l.targetIssues = l.targetIssues || []); let idx = arr.indexOf(val); if(idx !== -1) arr.splice(idx, 1); else arr.push(val); renderApp(); }
    function addNewBrand() { brands.push({ name: 'ìƒˆ ë¸Œëœë“œ', lenses: [], brandColor: '#2c3e50' }); openBrandIndex = brands.length - 1; renderAdmin(); }
    function addNewLens(bi) { brands[bi].lenses.push({ name: 'ìƒˆ ì œí’ˆ', tabId: adminSelectedTabId, bgColor: '#2c3e50', targetAges:['adult'], targetIssues:['none'], items: [], order: brands[bi].lenses.length + 1 }); renderAdmin(); }
    function addCategory() { const name = document.getElementById('new-cat-name').value; if(name){ categories.push({id: 't'+Date.now(), name: name, order: categories.length, img:''}); renderAdmin(); renderApp();} }
    function addIssue() { const name = document.getElementById('new-issue-name').value; if(name){ issues.push({id: 'is'+Date.now(), name}); renderAdmin(); renderIssueSelect();} }
    function delCategory(id) { categories = categories.filter(c => c.id !== id); renderAdmin(); renderApp(); }
    function delIssue(id) { issues = issues.filter(is => is.id !== id); renderAdmin(); renderIssueSelect(); }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = (p.style.display==='block'?'none':'block'); if(p.style.display==='block') renderAdmin(); }
    function saveData() { if(!confirm("ì„œë²„ì— ì €ì¥?")) return; const btn = document.getElementById('saveBtn'); btn.innerText = "â³ ì €ì¥ ì¤‘..."; db.ref('lensData').set({ categories, brands, issues, matrices }, (err) => { btn.innerText = "ğŸ’¾ ì„œë²„ì— ìµœì¢…ì €ì¥"; if(err) alert("ì‹¤íŒ¨: " + err.message); else alert("âœ… ì™„ë£Œ!"); }); }
    function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({categories, brands, issues, matrices}, null, 2)], { type: 'application/json' })); a.download = `ë°±ì—….json`; a.click(); }
    init();
</script>
</body>
</html>
