<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>아이젠트리 충남도청점 V1.1 MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; --sale: #d63031; }
        body { font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; overflow-x: hidden; }
        
        .app-container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); overflow: hidden; min-height: 95vh; }
        
        header { background: #2c3e50; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid var(--accent); }
        .logo-area h2 { margin: 0; font-size: 1.6em; letter-spacing: -1px; }
        .top-controls { display: flex; gap: 12px; align-items: center; }
        
        .btn-ui { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 0.95em; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 6px; }
        .btn-ui:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); filter: brightness(1.1); }
        
        .btn-admin-gear { background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1.4em; transition: 0.3s; }
        .btn-admin-gear:hover { transform: rotate(90deg); background: var(--accent); }

        .filter-off .disabled-row { opacity: 1 !important; filter: none !important; pointer-events: auto !important; }
        .disabled-row { opacity: 0.15; filter: grayscale(1); pointer-events: none; transition: 0.3s; }
        
        .power-box-btn { background: white; color: #2c3e50; padding: 8px 15px; border-radius: 8px; font-weight: 900; font-size: 1.1em; cursor: pointer; min-width: 80px; text-align: center; border: 2px solid #ddd; }
        .label-text { font-size: 0.75em; color: rgba(255,255,255,0.8); margin-bottom: 3px; text-align: center; font-weight: bold; }
        .control-group { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 12px; }

        #picker-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9000; justify-content:center; align-items:center; }
        .picker-container { background:white; padding:35px; border-radius:30px; width:92%; max-width:1100px; max-height:85vh; overflow-y:auto; }
        .picker-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap:12px; }
        .pick-btn { padding:22px 10px; border:1px solid #eee; border-radius:15px; font-weight:900; font-size:1.1em; cursor:pointer; background:#f8f9fa; transition:0.2s; text-align:center; color:#333; }
        .pick-btn:hover { background: #eef2f7; }
        .pick-btn.selected { background:var(--accent) !important; color:white !important; border-color:var(--accent); }
        .pick-btn.plus { color: #d63031; background: #fff5f5; }
        .pick-btn.minus { color: #0984e3; background: #f0f7ff; }

        .tabs-bar { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; overflow-x: auto; padding: 0 10px; }
        .tab { padding: 22px 30px; cursor: pointer; font-weight: 800; color: #888; white-space: nowrap; transition: 0.3s; position: relative; font-size: 1.05em; }
        .tab.active { color: var(--accent); }
        .tab.active::after { content:''; position:absolute; bottom:0; left:20%; right:20%; height:5px; background:var(--accent); border-radius:10px 10px 0 0; }
        .content-body { padding: 30px; min-height: 700px; }

        /* 매트릭스 & 카드 */
        .matrix-container {
        grid-column: 1 / -1;   /* 이 줄을 추가하면 좌우로 꽉 차게 됩니다 */
        margin-bottom: 40px;   /* 40에서 10으로 줄여서 아래 간격을 좁힙니다 */
        border-radius: 15px; 
        border: 1px solid #e0e0e0; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .matrix-title { padding: 10px 25px; font-size: 1.2em; font-weight: bold; color: white; }
        .matrix-table { width: 100%; border-collapse: collapse; text-align: center; }
        .matrix-table th { padding: 10px 15px; background: #fdfdfd; border-bottom: 2px solid #eee; }
        .idx-col { background: #f8f9fa; font-weight: bold; width: 85px; color: #666; font-size: 1.05em; border-right: 1px solid #eee; }
        .card-grid {
            display: grid !important; 
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); 
            row-gap: 5px !important;    /* ★ 위아래 간격 (원하는 만큼 숫자를 바꾸세요) */
            column-gap: 25px !important; /* 좌우 간격 */
            align-items: start;          /* 카드 높이가 달라도 위쪽 기준으로 정렬 */
        }
        .lens-card, .matrix-container {
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        
        .content-body {
            padding-top: 10px !important;    /* 30px에서 5px로 강제 축소 */
            padding-bottom: 30px !important; /* 하단 여백도 함께 조절 */
        }

        /* 2. 카드 그리드 자체의 상단 마진 제거 */
        .card-grid {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* 3. (기존 코드 확인) 카드들의 상하 마진 완전 제거 */
        .lens-card, .matrix-container {
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }

        .lens-card { border-radius: 15px; background: white; border: 1px solid #eee; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .card-head { padding: 12px 18px; color: white; font-weight: 900; font-size: 1.15em; display: flex; justify-content: space-between; align-items: center; }
        .sale-badge { background: #fff; color: var(--sale); font-size: 0.75em; padding: 3px 8px; border-radius: 5px; font-weight: 900; }
        .lens-one-liner { padding: 8px 15px; background: #f0f7ff; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; color: #2c3e50; border-left: 5px solid var(--accent); margin: 5px 10px 8px 10px; border-radius: 4px; font-weight: 700; }

        /* --- 단초점 가격표 정렬 및 폭 조절 --- */
        .card-table { width: 100%; border-collapse: collapse; }

        /* 굴절률과 설계 칸은 중앙 정렬 */
        .card-table th, .card-table td { 
            padding: 10px 5px !important; 
            text-align: center !important; 
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }

        /* 제목(헤더) 부분만 따로 글자 크기와 배경색 유지 */
        .card-table th { background: #f8f9fa; font-size: 0.75em; color: #888; }

        /* 마지막 '가격' 칸만 오른쪽 정렬 */
        .card-table th:last-child, .card-table td:last-child { 
            text-align: right !important; 
            padding-right: 15px !important; 
        }

        /* 첫 번째 '굴절률' 칸 폭을 좁게 조절 */
        .card-table th:nth-child(1), .card-table td:nth-child(1) { 
            width: 85px !important; 
        }
        /* 관리자 패널 */
        .admin-panel { display: none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:98%; height:94%; background:#f1f3f5; z-index:2000; padding:30px; border-radius:15px; overflow-y:auto; box-sizing:border-box; }
        .admin-section { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #dee2e6; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tag-row { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        .btn-small { padding: 6px 12px; font-size: 0.8em; cursor: pointer; border-radius: 6px; border: none; background: #95a5a6; color: white; font-weight: bold; }
        
        /* 매트릭스 에디터 */
        .matrix-editor-table { width:100%; border-collapse: collapse; background:white; }
        .matrix-editor-table th, .matrix-editor-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .me-input-group { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .me-input { width: 90%; padding: 6px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; text-align: center; }
        /* 매트릭스 아코디언 전용 스타일 */
        .matrix-list-item { background: #f8f9fa; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; overflow: hidden; transition: 0.2s; }
        .matrix-list-item:hover { border-color: var(--accent); }
        .matrix-item-header { padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: white; }
        .matrix-item-header:hover { background: #f0f7ff; }
        .matrix-item-body { padding: 20px; background: #fff; border-top: 1px solid #eee; display: none; }
        .matrix-item-header b { font-size: 1.1em; color: var(--primary); }
        .matrix-badge { font-size: 0.75em; padding: 2px 8px; border-radius: 4px; background: #eee; color: #666; font-weight: bold; }
        @keyframes badge-blink {
            0% { background-color: #d63031; transform: scale(1); }
            50% { background-color: #ff0000; transform: scale(1.1); }
            100% { background-color: #d63031; transform: scale(1); }
        }
        @keyframes card-vibrate {
        0% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-5px) scale(1.01); box-shadow: 0 15px 45px rgba(214, 48, 49, 0.2); }
        100% { transform: translateY(0) scale(1); }
        }
        /* 세일 상태인 카드 전용 스타일 */
        .lens-card.sale-active {
            border: 1px solid #eee !important;
            animation: none !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05) !important;
        }
        .sale-badge.animate {
            color: #ffff00 !important;        /* ★ 글자색: 노란색 */
            background-color: #ff0000 !important; /* ★ 배경색: 빨간색 */
            animation: badge-blink 0.5s infinite; /* 더 빠르게 번쩍임 */
            padding: 4px 10px !important;
            border-radius: 5px;
            font-weight: 900;
            display: inline-block;
        }
        /* 가격 색상 기본값: 검정색 */
        .price-text {
            color: #333; /* 기본 검정 */
        }
        /* 세일 중일 때만 빨간색으로 변경 */
        .sale-active .price-text {
            color: var(--sale) !important; /* 세일 시 빨간색 */
        }

        #sim-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            z-index: 9500;
            width: 1200px;
            height: 850px; /* 세로 높이를 살짝 줄여 안정감 확보 */
            max-width: 95vw;
            max-height: 95vh;
            background: white;
            border-radius: 25px;
            transform: translate(-50%, -50%) scale(1);
            transform-origin: center center;
            transition: transform 0.2s ease-out;
        }

        /* [아이패드 및 태블릿 상하좌우 완벽 대응 스케일링] */

        /* 1. 화면이 1300px보다 좁거나, 높이가 950px보다 낮을 때 (일반 노트북/아이패드 대형) */
        @media screen and (max-width: 1300px), screen and (max-height: 950px) {
            #sim-modal {
                transform: translate(-50%, -50%) scale(0.85) !important;
            }
        }

        /* 2. 화면이 1100px보다 좁거나, 높이가 850px보다 낮을 때 (아이패드 10세대/에어 가로) */
        @media screen and (max-width: 1100px), screen and (max-height: 850px) {
            #sim-modal {
                transform: translate(-50%, -50%) scale(0.75) !important;
            }
        }

        /* 3. 화면이 900px보다 좁거나, 높이가 750px보다 낮을 때 (아이패드 미니/태블릿 세로) */
        @media screen and (max-width: 900px), screen and (max-height: 750px) {
            #sim-modal {
                transform: translate(-50%, -50%) scale(0.65) !important;
            }
        }

        /* 4. 화면이 아주 낮거나 좁을 때 (모바일/작은 화면) */
        @media screen and (max-width: 768px), screen and (max-height: 600px) {
            #sim-modal {
                transform: translate(-50%, -50%) scale(0.55) !important;
            }
        }

        #sim-modal .viewport { 
            position: relative; width: 100%; height: 380px; /* 550에서 380으로 축소 */
            background: #fff; border-radius: 15px; border: 1px solid #eee; margin: 15px 0; overflow: hidden; 
        }
        #sim-modal .eye-bg { position: absolute; top: 50%; left: 70%; transform: translate(-50%, -50%); width: 550px; z-index: 1; } /* 눈 크기 700에서 550으로 축소 */
        .biconcave { 
            width: 40px; 
            height: 170px; 
            background: rgba(52, 152, 219, 0.4); /* 렌즈 배경색 농도 강화 */
            border: 3px solid var(--accent);    /* 변수명을 --accent로 통일 */
            clip-path: polygon(0% 0%, 100% 0%, 70% 50%, 100% 100%, 0% 100%, 30% 50%);
            display: block !important;
        }

        .biconvex { 
            width: 45px; 
            height: 160px; 
            background: rgba(52, 152, 219, 0.4); 
            border: 3px solid var(--accent);
            clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
            display: block !important;
        }

        /* 렌즈 컨테이너 위치 강제 고정 */
        #lens-container {
            position: absolute;
            left: 400px; /* 광선이 꺾이는 지점 근처로 조정 */
            top: 50%;
            transform: translateY(-50%);
            z-index: 100;
            transition: 0.3s;
        }
        #sim-modal .source-object { position: absolute; left: 60px; top: 48%; transform: translateY(-50%); font-size: 80px; z-index: 2; }
        #sim-modal #target { position: absolute; font-size: 45px; z-index: 5; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center; }
        #sim-modal #ray-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        #sim-modal polyline { fill: none; stroke: rgba(52, 152, 219, 0.4); stroke-width: 3.5; transition: all 0.5s ease-in-out; }
        #sim-modal .btn-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        #sim-modal .btn-base { background: #e9ecef; color: #333; padding: 15px 25px; font-size: 1.4em !important; border-radius: 8px; font-weight: bold; border:none; cursor:pointer; }
        #sim-modal .btn-base.active { background: #1a2a3a; color: white; }
        /* [난시 추가 버튼 - 좌우 분할 및 텍스트 2단 정렬] */
        #sim-modal .btn-astig-add { 
            background: #ddeeff; 
            color: #333; 
            padding: 8px 18px;         /* 두 줄 높이에 맞춰 상하 여백 조절 */
            border-radius: 10px; 
            font-weight: bold; 
            border: 2px solid #ced4da; 
            cursor: pointer; 
            transition: all 0.3s ease;
            display: inline-flex;      /* 가로로 기호와 글씨 배치 */
            align-items: center;       /* 세로 중앙 맞춤 */
            gap: 12px;                 /* 플러스와 글씨 사이 간격 */
        }
        /* 왼쪽 플러스(+) 기호 스타일 */
        #sim-modal .btn-astig-add .plus-icon {
            font-size: 1.8em;          /* 플러스 기호를 크게 강조 */
            font-weight: 900;
        }
        /* 오른쪽 두 줄 글씨 스타일 */
        #sim-modal .btn-astig-add .text-group {
            display: flex;
            flex-direction: column;    /* 글씨를 위아래 2단으로 쌓기 */
            align-items: flex-start;   /* 왼쪽 정렬 */
            line-height: 1.1;          /* 줄 간격을 좁게 */
            font-size: 1.4em;          /* 두 줄이므로 크기를 살짝 줄임 */
        }
        /* 마우스 올렸을 때 */
        #sim-modal .btn-astig-add:hover {
            background: #dee2e6;
        }
        /* ★ 난시 활성화 시 (주황색 변신) */
        #sim-modal .btn-astig-add.active { 
            background: #8b1ab8 !important; 
            color: white !important; 
            border-color: #d35400;
            box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
        }
        /* [난시 추가 버튼 - 비활성화 상태 스타일] */
        #sim-modal .btn-astig-add.disabled {
            opacity: 0.3;              /* 아주 연하게 만듦 */
            filter: grayscale(1) blur(1px); /* 흑백 + 약간의 흐림 효과 */
            cursor: not-allowed;       /* 마우스 커서를 '금지' 모양으로 변경 */
            pointer-events: none;      /* 클릭 아예 안 먹히게 차단 */
            box-shadow: none !important;
        }
        #sim-modal .btn-lens { background: #27ae60; color: white; width: 100%; max-width: 500px; font-size: 1.2em; height: 60px; border-radius: 10px; cursor:pointer; border:none; font-weight:bold; }
        #sim-modal #description { padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left; border-left: 6px solid #1a2a3a; font-size: 18px; line-height: 1.6; }
        .sim-menu-item:hover {
            background: #f0f7ff !important;
            color: #8e44ad !important;
        }

        .sim-tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: bold;
            color: #888;
            border-bottom: 4px solid transparent;
            transition: 0.2s;
        }
        .sim-tab.active {
            color: #8e44ad;
            border-bottom-color: #8e44ad;
            background: white;
        }
        .sim-tab:hover:not(.active) {
            background: #eee;
        }
        .sim-panel { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .sim-close-touch-btn {
            background: #8e44ad;
            color: white;
            border: none;
            font-size: 24px;
            font-weight: 900;
            padding: 0 40px;
            cursor: pointer;
            border-radius: 0 25px 0 15px; /* 모달 오른쪽 위 모서리에 딱 맞춤 */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease; /* 부드러운 변화 효과 */
            height: 100%; /* 상단 바 높이에 꽉 차게 */
        }
        /* 마우스 올렸을 때 (Hover) */
        .sim-close-touch-btn:hover {
            background: #732d91b; /* 조금 더 진한 빨간색으로 변경 */
            filter: brightness(1.1); /* 살짝 밝게 광택 효과 */
            padding: 0 45px; /* 옆으로 살짝 넓어지면서 강조됨 */
        }

        /* 실제로 눌렀을 때 (Active) */
        .sim-close-touch-btn:active {
            transform: scale(0.95); /* 버튼이 쑥 눌리는 느낌 추가 */
            background: #5e2475;
        }

        /* 시뮬레이터 전용 탭 스타일 보완 */
        .sim-tab {
            padding: 0 35px;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: #888;
            border-bottom: 5px solid transparent;
            transition: 0.2s;
            font-size: 1.1em;
        }
        .sim-tab.active { color: #8e44ad; border-bottom-color: #8e44ad; background: white; }

        /* [1. 기본 설정: 넓은 화면일 때 - 한 줄로 쫙] */
        .top-controls {
            display: flex;
            flex-direction: row; /* 기본은 가로 한 줄 */
            align-items: center;
            gap: 12px;
        }

        .action-row, .selection-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inputs-row, .icons-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* [아이패드 및 좁은 화면: 2단 정렬 최적화] */
        @media screen and (max-width: 1450px) {
            .top-controls {
                flex-direction: column !important; /* 세로 2단으로 쌓기 */
                align-items: flex-start !important; /* ★ 핵심: 두 줄의 왼쪽 끝 라인을 맞춤 */
                gap: 12px !important;
                margin-left: 20px; /* 로고와의 최소 간격 확보 */
            }

            /* 상단 버튼줄과 하단 선택창줄의 정렬 통일 */
            .action-row, .selection-container {
                display: flex;
                justify-content: flex-start !important; /* 왼쪽부터 채우기 */
                width: 100%;
                gap: 10px;
            }

            .inputs-row {
                display: flex;
                gap: 10px;
                flex: 1; /* 가용 공간을 꽉 채우도록 설정 */
            }

            /* 하단 선택창들도 위 버튼들과 같은 느낌으로 폭 조절 */
            .control-group {
                display: flex;
                gap: 8px;
                padding: 5px 12px !important;
                background: rgba(255,255,255,0.1) !important;
                border-radius: 12px;
                flex: 1; /* 내부 박스들이 유연하게 늘어나도록 함 */
                max-width: fit-content;
            }

            .power-box-btn {
                min-width: 75px !important; /* 위 버튼(시뮬레이션 등)과 비슷한 폭 유지 */
                padding: 6px 12px !important;
                font-size: 1.05em !important;
            }

            /* 로고 크기 미세 조정 */
            .logo-area h2 { font-size: 1.3em !important; }
        }

        /* [프리미엄 설계] 전용 레이아웃 */
        .premium-content { display: flex; gap: 25px; align-items: stretch; justify-content: center; height: 100%; }
        .premium-lens-grid { display: flex; gap: 15px; flex: 1; }
        .premium-card { background: #fff; padding: 20px; border-radius: 25px; flex: 1; border: 1px solid #eee; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .premium-card canvas { border-radius: 50%; width: 100%; max-width: 280px; aspect-ratio: 1/1; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #fff; margin-bottom: 15px; }

        /* [프리미엄 전용] 세로 슬라이더 & 눈금 */
        .premium-side { background: #fff; width: 120px; border-radius: 25px; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; padding: 20px 10px; }
        .p-slider-box { height: 400px; position: relative; display: flex; align-items: center; justify-content: center; width: 100%; margin: 15px 0; }

        .p-range { 
            -webkit-appearance: none; width: 12px; height: 400px; background: #eee; border-radius: 10px; outline: none;
            writing-mode: vertical-lr; direction: rtl; cursor: pointer;
        }
        .p-range::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 30px; height: 30px; background: #fff; border: 4px solid #1a73e8; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }

        /* 눈금 표시 레이어 */
        .p-markers { position: absolute; height: 400px; right: 10px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .p-mark { display: flex; align-items: center; font-size: 11px; font-weight: 800; color: #ccc; }
        .p-tick { width: 8px; border-top: 1px solid #ddd; margin-right: 5px; }
        .p-mark.zero { color: #555; }
        .p-mark.zero .p-tick { width: 15px; border-top: 2px solid #555; }
        
        /* [근시 진행 시뮬레이터] 전용 스타일 */
        #panel-myopia .myo-viewport { 
            position: relative; width: 100%; height: 450px; 
            background: #fff; border-radius: 15px; border: 1px solid #eee;
            margin: 20px 0; overflow: hidden;
        }

        #panel-myopia .eye-container {
            position: absolute; 
            top: 50%; 
            left: 450px; /* 창 크기에 맞춰 좌측 여백 조정 */
            transform-origin: 0% 50%; 
            transform: translateY(-50%) scale(1);
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        #panel-myopia .myo-eye-bg { width: 620px; display: block; }
        #panel-myopia .source-object { position: absolute; left: 140px; top: 48%; transform: translateY(-50%); font-size: 80px; z-index: 2; }

        #panel-myopia #myo-target { 
            position: absolute; 
            left: 760px; /* 초점이 맺히는 위치 고정 */
            top: 195px; 
            font-size: 45px; z-index: 5;
            transform: rotate(180deg);
            transition: filter 0.6s ease;
        }

        #panel-myopia #myo-ray-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        #panel-myopia .myo-btn-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        #panel-myopia .myo-btn { padding: 15px 25px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 15px; background: #e9ecef; color: #555; }
        #panel-myopia .myo-btn.active { background: #8e44ad; color: white; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        #panel-myopia .info-panel { padding: 20px; background: #f8f9fa; border-radius: 15px; border: 1px solid #eee; text-align: left; }
        #panel-myopia .status-badge { display: inline-block; padding: 6px 18px; border-radius: 5px; color: white; font-weight: bold; margin-bottom: 10px; }

        /* [근시 억제 원리] 전용 스타일 */
        #panel-control .ctrl-viewport { 
            position: relative; width: 100%; height: 430px; 
            background: #fff; border-radius: 15px; border: 1px solid #eee;
            margin: 15px 0; overflow: hidden;
        }

        #panel-control .ctrl-eye-container {
            position: absolute; top: 50%; left: 350px;
            transform: translateY(-50%); z-index: 1;
        }

        #panel-control #focal-curve {
            fill: none; stroke-width: 6; stroke-linecap: round;
            transition: all 0.9s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            filter: drop-shadow(0 0 8px rgba(0,0,0,0.3));
        }

        #panel-control .point-marker { transition: all 0.9s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; }
        #panel-control .point-marker.visible { opacity: 1; }

        #panel-control .ctrl-ray { fill: none; stroke-width: 2; opacity: 0.4; transition: all 0.9s ease; }

        #panel-control .ctrl-btn-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        #panel-control .ctrl-btn { padding: 18px 35px; border: none; border-radius: 40px; cursor: pointer; font-weight: 800; transition: 0.3s; background: #e9ecef; font-size: 16px; }
        #panel-control .ctrl-btn.active { background: #1a2a3a; color: white; transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }

        /* [아이패드/태블릿용 헤더 최적화] */
        @media screen and (max-width: 1250px) {
            header {
                padding: 10px 15px !important; /* 양옆 여백 축소 */
            }
            
            .logo-area h2 {
                font-size: 1.2em !important; /* 제목 크기 축소 */
            }

            .top-controls {
                gap: 8px !important; /* 버튼 사이 간격 축소 */
            }

            .btn-ui {
                padding: 8px 12px !important; /* 버튼 크기 축소 */
                font-size: 0.85em !important;
            }

            .control-group {
                padding: 5px 10px !important; /* 대상/도수 선택창 크기 축소 */
            }
            
            .power-box-btn {
                min-width: 60px !important; /* 도수 버튼 폭 축소 */
                padding: 5px 10px !important;
            }
        }

        /* 상단 컨트롤 기본 설정 */
        .top-controls {
            display: flex;
            flex-wrap: wrap; /* 내용이 많으면 다음 줄로 넘어가게 설정 */
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
        }

        /* [아이패드 및 좁은 화면용] */
        @media screen and (max-width: 1250px) {
            .action-row {
                width: 100%; /* 한 줄을 다 차지해서 선택창들을 아래로 밀어냄 */
                display: flex;
                justify-content: flex-end; /* 오른쪽 정렬 */
                gap: 8px;
                margin-bottom: 5px; /* 아래 줄과의 간격 */
            }

            /* 아래 줄 항목들의 정렬 */
            .top-controls > .control-group, 
            .top-controls > .btn-admin-gear {
                display: flex;
            }
        }

    </style>
</head>
<body class="filter-off">

<div class="app-container">
    <header>
        <div class="logo-area"><h2>아이젠트리 충남도청점</h2><span style="font-size:0.8em; opacity:0.7; margin-left:10px;">V1.1 MASTER</span></div>
            <div class="top-controls">
                <div class="action-row">
                    <button id="sim-main-btn" class="btn-ui" style="background:#8e44ad; font-weight:bold;" onclick="toggleSimDropdown()">🎮 시뮬레이션</button>
                    <button id="filter-toggle-btn" class="btn-ui" style="background:#95a5a6;" onclick="togglePowerFilter()">🔍 필터 OFF</button>
                    <button class="btn-ui" style="background:#e67e22; margin-left:5px;" onclick="resetAllFilters()">🔄 </button>
                </div>

                <div class="selection-container">
                    <div class="inputs-row">
                        <div class="control-group">
                            <div onclick="openGeneralPicker('age')"><div class="label-text">대상 선택</div><div id="disp-age" class="power-box-btn">나이</div></div>
                            <div onclick="openGeneralPicker('issue')"><div class="label-text">불편함 선택</div><div id="disp-issue" class="power-box-btn">없음</div></div>
                        </div>
                        <div class="control-group">
                            <div onclick="openPowerPicker('s')">
                                <div class="label-text">S (구면)</div>
                                <div id="disp-s" class="power-box-btn">0.00</div>
                            </div>
                            <div onclick="openPowerPicker('c')">
                                <div class="label-text">C (난시)</div>
                                <div id="disp-c" class="power-box-btn">0.00</div>
                            </div>
                        </div>
                    </div>
                    <div class="icons-row">
                        <button class="btn-admin-gear" onclick="secureAdminOpen()">⚙️</button>
                        <button id="fullscreen-btn" class="btn-admin-gear" 
                            style="margin-left: 5px; border-radius: 50% !important; background: rgba(255,255,255,0.1);" 
                            onclick="toggleFullScreen()">📺</button>
                    </div>
                </div>
            </div>
    </header>

    <div id="ui-overlay" onclick="closeAllModals()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1998;"></div>
    
    <div id="picker-overlay" onclick="this.style.display='none'">
        <div class="picker-container" onclick="event.stopPropagation()">
            <div id="picker-title" style="font-size:1.7em; font-weight:900; margin-bottom:25px; text-align:center; color:var(--primary); border-bottom:4px solid var(--accent); padding-bottom:15px;">선택</div>
            <div class="picker-grid" id="picker-grid-content"></div>
            <div style="margin-top:35px; text-align:center;"><button class="btn-ui" style="background:var(--primary); padding:20px 100px; font-size:1.2em;" onclick="document.getElementById('picker-overlay').style.display='none'">닫기</button></div>
        </div>
    </div>

    <div class="tabs-bar" id="tab-nav"></div>
    <div id="main-display" class="content-body"></div>
</div>

<div id="sim-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:1200px; height:900px; background:white; z-index:9500; border-radius:25px; box-shadow:0 0 100px rgba(0,0,0,0.6); overflow:hidden; flex-direction:column;">
    <div style="background:#f8f9fa; display:flex; border-bottom:1px solid #ddd; height: 80px; align-items: stretch; padding-left: 20px;">
        <div class="sim-tab active" onclick="switchSimTab('refractive')">🔍 굴절 이상 교정</div>
        <div class="sim-tab" onclick="switchSimTab('myopia')">📉 성장기 근시 진행</div>
        <div class="sim-tab" onclick="switchSimTab('control')">🛡️ 근시 억제 원리</div>
        <div class="sim-tab" onclick="switchSimTab('premium')">💎 프리미엄 설계 비교</div>
        <div style="flex:1;"></div>
        <button class="sim-close-touch-btn" onclick="closeSimulator()">닫기 ×</button>
    </div>

    <div id="sim-content-area" style="flex:1; padding:40px; overflow-y:auto;">
        <div id="panel-refractive" class="sim-panel">
            <h2 style="margin:0 0 20px 0; color:#1a2a3a;">🔍 전문 굴절 이상 시뮬레이터</h2>
            <div class="viewport">
                <div class="source-object">🌳</div>
                <img src="https://github.com/eyegentry1007-tech/glass/blob/main/eyeball.png?raw=true" class="eye-bg">
                <svg id="ray-svg">
                    <polyline id="ray-top" points="115,150 430,150 780,210" />
                    <polyline id="ray-bottom" points="115,230 430,230 780,170" />
                </svg>
                <div id="lens-container"><div id="lens-shape"></div></div>
                <div id="target">🌳</div>
            </div>
            <div class="btn-group">
                <button class="btn-base active" id="btn-normal" onclick="setSimBase('normal')">정시</button>
                <button class="btn-base" id="btn-myopia" onclick="setSimBase('myopia')">근시</button>
                <button class="btn-base" id="btn-hyperopia" onclick="setSimBase('hyperopia')">원시</button>
                <button class="btn-base" id="btn-astig" onclick="setSimBase('astigmatism')">난시</button>
                <button class="btn-astig-add" id="btn-astig-toggle" onclick="toggleSimAstigmatism()">
                    <span class="plus-icon">+</span>
                    <div class="text-group">
                        <span>난시</span>
                        <span>추가</span>
                    </div>
                </button>
            </div>
            <div style="text-align:center; margin:30px 0;">
                <button class="btn-lens" id="btn-lens-toggle" onclick="toggleSimLens()" style="width: 500px; height: 70px; font-size: 1.3em;">✨ 안경 렌즈 교정 시뮬레이션 작동</button>
            </div>
            <div id="description">상태를 선택하고 교정 버튼을 눌러보세요.</div>
        </div>

    <div id="panel-myopia" class="sim-panel" style="display:none;">
        <h2 style="color: #2c3e50; margin: 0;">👓 성장기 안구 성장 시뮬레이션</h2>
        <p style="color: #666; margin-top: 7px;">성장에 따라 안축장(눈의 길이)이 길어지는 과정을 확인하세요.</p>

        <div class="myo-viewport">
            <div class="source-object">🌳</div>
            
            <div id="myo-eye-container" class="eye-container">
                <img src="https://github.com/eyegentry1007-tech/glass/blob/main/eyeball.png?raw=true" class="myo-eye-bg">
            </div>

            <svg id="myo-ray-svg">
                <polyline points="200,180 465,180 780,235" style="fill:none; stroke:rgba(52, 152, 219, 0.4); stroke-width:3;" />
                <polyline points="200,270 465,270 780,215" style="fill:none; stroke:rgba(52, 152, 219, 0.4); stroke-width:3;" />
            </svg>

            <div id="myo-target">🌳</div>
        </div>

        <div class="myo-btn-group">
            <button id="btn-baby" class="myo-btn" onclick="updateMyopiaMode('baby')">👶 영유아 (초기 원시)</button>
            <button id="btn-infant" class="myo-btn" onclick="updateMyopiaMode('infant')">👦 취학 전 (정시)</button>
            <button id="btn-child" class="myo-btn" onclick="updateMyopiaMode('child')">🧑 초등학생 (근시 진행)</button>
            <button id="btn-teen" class="myo-btn" onclick="updateMyopiaMode('teen')">👨 중,고등생 (고도 근시 위험)</button>
        </div>

        <div class="info-panel">
            <div id="myo-status-tag" class="status-badge">상태 진단</div>
            <div id="myo-description" style="font-size:16px; line-height:1.6; color:#444;">연령대 버튼을 눌러보세요.</div>
        </div>
    </div>

    <div id="panel-premium" class="sim-panel" style="display:none;">
        <h2 style="color: #2c3e50; margin-top: 0; margin-bottom: 10;">👓 설계 차이에 따른 왜곡</h2>
        <div class="premium-content">
            <div class="premium-lens-grid">
                <div class="premium-card">
                    <div style="font-weight:900; margin-bottom:12px; font-size:1.2em;">일반 구면</div>
                    <canvas id="p-canvas-sph"></canvas>
                    <div style="font-size:0.9em; color:#666; line-height:1.5;">도수가 높을수록 주변부 <br><span style="color:#d63031; font-weight:bold;">왜곡과 파워 변화</span>가 큼</div>
                </div>
                <div class="premium-card">
                    <div style="font-weight:900; margin-bottom:12px; font-size:1.2em; color:#1a73e8;">비구면</div>
                    <canvas id="p-canvas-asph"></canvas>
                    <div style="font-size:0.9em; color:#666; line-height:1.5;">설계 보정을 통해 주변부 <br><span style="color:#1a73e8; font-weight:bold;">울렁임과 왜곡</span>을 감소</div>
                </div>
                <div class="premium-card">
                    <div style="font-weight:900; margin-bottom:12px; font-size:1.2em; color:#184888;">양면 비구면</div>
                    <canvas id="p-canvas-dasph"></canvas>
                    <div style="font-size:0.9em; color:#666; line-height:1.5;">왜곡을 극소화하여 <br><span style="color:#184888; font-weight:bold;">실제 눈 크기</span>와 가장 유사</div>
                </div>
            </div>

            <div class="premium-side">
                <div id="p-val-label" style="font-size:24px; font-weight:900; margin-bottom:5px;">0.00</div>
                <div style="font-size:13px; font-weight:bold; color:#d63031;">원시(+)</div>
                <div class="p-slider-box">
                    <input type="range" id="p-main-slider" class="p-range" min="-12" max="12" value="-6" step="0.25" oninput="updatePremiumSim()">
                    <div class="p-markers">
                        <div class="p-mark"><div class="p-tick"></div>+12</div>
                        <div class="p-mark"><div class="p-tick"></div>+6</div>
                        <div class="p-mark"><div class="p-tick"></div>+3</div>
                        <div class="p-mark zero"><div class="p-tick"></div>0</div>
                        <div class="p-mark"><div class="p-tick"></div>-3</div>
                        <div class="p-mark"><div class="p-tick"></div>-6</div>
                        <div class="p-mark"><div class="p-tick"></div>-12</div>
                    </div>
                </div>
                <div style="font-size:13px; font-weight:bold; color:#1a73e8;">근시(-)</div>
            </div>
        </div>
    </div>
    
    <div id="panel-control" class="sim-panel" style="display:none;">
        <h2 style="color: #1a2a3a; font-size: 28px; margin-top: 0; margin-bottom: 5px;">🛡️ 우리 아이 시력 보호 : 근시 억제 원리</h2>
        <p style="color: #666; margin-bottom: 20px;">주변부 초점이 <b>망막 안쪽</b>으로 오므려져야 눈의 성장이 멈춥니다.</p>

        <div class="ctrl-viewport">
            <div class="ctrl-eye-container">
                <img src="https://github.com/eyegentry1007-tech/glass/blob/main/eyeball.png?raw=true" style="width:620px; opacity:0.9;">
            </div>

            <svg id="ctrl-ray-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;">
                <defs>
                    <marker id="arrow-head" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="5" markerHeight="5" orient="auto">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#29054b" />
                    </marker>
                </defs>
                <path id="focal-curve" d="" />
                <path id="ctrl-ray-top" class="ctrl-ray" d="" />
                <path id="ctrl-ray-mid" class="ctrl-ray" d="" />
                <path id="ctrl-ray-bot" class="ctrl-ray" d="" />

                <g id="ctrl-normal-markers" class="point-marker">
                    <circle cx="720" cy="75" r="45" fill="none" stroke="#ff4757" stroke-width="4" stroke-dasharray="6 3" />
                    <circle cx="720" cy="355" r="45" fill="none" stroke="#ff4757" stroke-width="4" stroke-dasharray="6 3" />
                </g>
                <g id="ctrl-control-markers" class="point-marker">
                    <path d="M 750 35 L 700 85" stroke="#29054b" stroke-width="8" marker-end="url(#arrow-head)" />
                    <path d="M 750 395 L 700 345" stroke="#29054b" stroke-width="8" marker-end="url(#arrow-head)" />
                </g>
            </svg>
        </div>

        <div class="ctrl-btn-group">
            <button id="btn-ctrl-normal" class="ctrl-btn" onclick="updateCtrlMode('normal')">❌ 일반 안경</button>
            <button id="btn-ctrl-control" class="ctrl-btn" onclick="updateCtrlMode('control')">✅ 근시억제 렌즈</button>
        </div>

        <div id="info-panel" style="padding:25px; background:#fcfcfc; border-radius:15px; border:1px solid #eee; text-align:left;">
            <div id="ctrl-status-badge" class="status-badge" style="background:#666; color:white; padding:5px 15px; border-radius:8px; margin-bottom:10px; display:inline-block;">모드 선택</div>
            <div id="ctrl-description" style="font-size:17px; line-height:1.8; color:#333;">위 버튼을 눌러 주변부 상의 변화를 확인해보세요.</div>
        </div>
    </div>
</div>
</div>
<div id="admin-panel" class="admin-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:30px; align-items:center;">
        <div style="display:flex; gap:15px;">
            <button class="btn-ui" style="background:var(--accent); font-size:1.1em; padding:15px 30px;" onclick="openMatrix()">🔳 매트릭스 가격표 관리</button>
            <button class="btn-ui" style="background:var(--success);" onclick="document.getElementById('excel-modal').style.display='block';">📊 엑셀 일괄 업로드</button>
            <button class="btn-ui" style="background:#9b59b6;" onclick="exportData()">📤 백업저장</button>
            <button class="btn-ui" style="background:#8e44ad;" onclick="importData()">📥 백업 불러오기</button>
        </div>
        <div style="display:flex; gap:12px;">
            <button class="btn-ui" style="background:var(--success); border: 2px solid white;" onclick="saveData()">💾 서버에 최종저장</button>
            <button class="btn-ui" style="background:#666;" onclick="toggleAdmin()">❌ 닫기</button>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:30px;">
        <div>
            <div class="admin-section" style="background:#fff9f0;">
                <h4>🔢 탭 노출 순서 관리</h4>
                <div id="admin-tab-order-list" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
            </div>

            <div class="admin-section">
                <h4>📂 탭 명칭 및 하단 이미지 관리</h4>
                <div id="admin-tab-list" style="max-height: 300px; overflow-y: auto; margin-bottom:15px;"></div>
                <div style="display:flex; gap:5px;"><input type="text" id="new-cat-name" placeholder="새 탭 이름" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;"><button class="btn-ui" style="background:var(--success);" onclick="addCategory()">탭 추가</button></div>
            </div>

            <div class="admin-section">
                <h4>❓ 불편 증상 항목 관리</h4>
                <div id="admin-issue-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
                <div style="margin-top:15px; display:flex; gap:5px;"><input type="text" id="new-issue-name" placeholder="새 증상" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;"><button class="btn-ui" style="background:var(--success);" onclick="addIssue()">증상 추가</button></div>
            </div>
        </div>

        <div>
            <div class="admin-section" style="border: 2px solid var(--accent);">
                <h4>🔢 [통합] 해당 탭 내 제품 노출 순서 관리 
                    <select id="admin-order-tab-select" onchange="adminSelectedTabId = this.value; renderAdmin();" style="padding:10px; border-radius:8px; width:200px;"></select>
                </h4>
                <div id="admin-unified-order-list" style="max-height: 600px; overflow-y: auto;"></div>
            </div>
        
            <div class="admin-section" style="background:#f0f7ff; border: 2px solid var(--accent);">
                <h4>🖼️ 홍보 이미지 카드 관리 (이름/주소 수정)</h4>
                <div id="admin-image-list" style="max-height: 400px; overflow-y: auto; margin-bottom:15px;"></div>
                
                <button class="btn-ui" style="background:var(--accent); width:100%; padding:15px;" onclick="addNewImageCard()">+ 새 홍보 이미지 카드 추가</button>
            </div>

            <div class="admin-section">
                <h4>📦 일반 브랜드별 제품 상세 설정 (SALE 배지, 도수범위 등)</h4>
                <div id="admin-brands-list"></div>
                <button class="btn-ui" style="background:var(--accent); margin-top:20px; width:100%; padding:15px;" onclick="addNewBrand()">+ 새 브랜드 추가</button>
            </div>
        </div>
    </div>
</div>

<div id="matrix-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:96%; height:92%; background:white; z-index:5000; padding:25px; border-radius:20px; box-shadow:0 0 100px rgba(0,0,0,0.5); overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3>🔳 매트릭스 관리자</h3><button class="btn-ui" style="background:#666;" onclick="closeMatrix()">창 닫기</button></div>
    
    <div id="matrix-editor" style="display:none; background:#f8f9fa; padding:25px; border-radius:20px; border:3px solid var(--accent); margin-bottom:30px;">
        <div style="display:flex; gap:15px; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
            브랜드: <input type="text" id="m-brand" style="width:130px; padding:8px;"> 
            타이틀색: <input type="color" id="m-brand-color"> 
            시리즈명: <input type="text" id="m-name" style="width:200px; padding:8px;"> 
            소속 탭: <select id="m-tab" style="padding:8px; border-radius:5px;"></select>
        </div>
        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:20px; font-size:0.95em; border:1px solid #ddd;">
            AI 타겟 연령: <span id="m-ages-wrap"></span> | 증상: <span id="m-issues-wrap"></span>
        </div>
        <div style="overflow-x:auto;">
            <table class="matrix-editor-table">
                <thead id="m-header"></thead>
                <tbody id="m-body"></tbody>
            </table>
        </div>
        <div style="text-align:right; margin-top:25px;"><button class="btn-ui" style="background:var(--success); padding:15px 50px;" onclick="saveMatrixToMemory()">✅ 매트릭스 저장하기</button></div>
    </div>

    <h4>저장된 매트릭스 목록</h4>
    <div id="saved-matrices-list" style="margin-top:10px;"></div>
    <button class="btn-ui" style="background:var(--accent); margin-top:20px; padding:15px 40px;" onclick="showMatrixEditor()">+ 새 브랜드 매트릭스 추가</button>
</div>

<div id="excel-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:600px; height:500px; background:white; z-index:6000; padding:30px; border-radius:20px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
    <h3>📊 엑셀 일괄 업로드</h3>
    <textarea id="excel-input" style="width:100%; height:320px; margin-top:10px; padding:10px; border:1px solid #ddd; border-radius:10px; font-family:monospace;"></textarea>
    <div style="text-align:right; margin-top:20px;"><button class="btn-ui" style="background:var(--danger);" onclick="processExcel()">🚀 즉시 적용</button><button class="btn-ui" style="background:#666; margin-left:10px;" onclick="document.getElementById('excel-modal').style.display='none'">닫기</button></div>
</div>



<script>
    // [Firebase]
    const firebaseConfig = { apiKey: "AIzaSyBV128h-2uzJUjGsazgK0XXn6f0uVnMyV8", authDomain: "eyegentry-5c7de.firebaseapp.com", databaseURL: "https://eyegentry-5c7de-default-rtdb.firebaseio.com", projectId: "eyegentry-5c7de", storageBucket: "eyegentry-5c7de.firebasestorage.app", messagingSenderId: "772851251300", appId: "1:772851251300:web:330b44914302a6b0048771" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 배경색의 밝기를 계산하여 검정색(#333) 또는 흰색(#fff)을 반환하는 함수
    function getContrastColor(hexColor) {
        if (!hexColor || hexColor.indexOf('#') !== 0) return '#333';
        const r = parseInt(hexColor.slice(1, 3), 16);
        const g = parseInt(hexColor.slice(3, 5), 16);
        const b = parseInt(hexColor.slice(5, 7), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness > 128 ? '#333' : '#fff'; // 128보다 크면 밝은색이므로 검정글씨 반환
    }
    
    // 버튼을 누를 때마다 다음 굴절률을 결정하는 함수
    function getNextIndexValue(items) {
        const sequence = ['1.56', '1.60', '1.67', '1.74']; // 순서 정의
        if (!items || items.length === 0) return sequence[0]; // 아무것도 없으면 1.56 시작

        const lastIdx = items[items.length - 1].idx; // 마지막으로 추가된 굴절률 확인
        const currentIndex = sequence.indexOf(lastIdx);
        
        // 마지막이 1.74이거나 목록에 없으면 다시 1.56으로, 아니면 다음 순서로
        if (currentIndex === -1 || currentIndex === sequence.length - 1) {
            return sequence[0];
        }
        return sequence[currentIndex + 1];
    }

    // [전역 변수]
    let categories = [{id:'ai', name:'✨ AI 추천'}], 
        brands = [], 
        issues = [{id:'none', name:'없음'}], 
        matrices = [], 
        images = []; // 이미지 보관함 추가

    let openMatrixIndex = null; 
    let currentTabId = 'ai';
    let adminSelectedTabId = ''; // 에러의 원인이었던 변수를 위로 올렸습니다.
    let userPower = {rs:0, rc:0, ls:0, lc:0};
    let selectedAge = 'none', selectedIssue = 'none', isFilterActive = false, openBrandIndex = null, editingMatrix = null;
    const fixedIndices = ['1.56', '1.60', '1.67', '1.74'];

    // 2. 서버에서 데이터를 가져오는 함수
    function loadDataFromServer() {
        db.ref('lensData').on('value', (snap) => {
            const data = snap.val();
            if(data) {
            categories = data.categories || categories;
            brands = data.brands || [];
            issues = data.issues || issues;
            matrices = data.matrices || [];
            
            // [중요] images가 null이거나 객체면 빈 배열([])로 초기화
            images = Array.isArray(data.images) ? data.images : [];
            window.images = images; // 전역 참조 연결
                
                // [수정] 데이터를 불러올 때 관리자용 선택 탭을 실제 존재하는 첫 번째 탭 ID로 자동 설정
                const firstRealTab = categories.find(c => c.id !== 'ai');
                if (firstRealTab && (!adminSelectedTabId || !categories.find(c => c.id === adminSelectedTabId))) {
                    adminSelectedTabId = firstRealTab.id;
                }

                renderApp(); 
                if(document.getElementById('admin-panel').style.display === 'block') renderAdmin();
            }
        });
    }

    // [순서 제어 핵심 함수]
    function moveItem(arr, idx, dir) {
        if (idx + dir < 0 || idx + dir >= arr.length) return;
        const temp = arr[idx];
        arr[idx] = arr[idx + dir];
        arr[idx + dir] = temp;
        // order 값을 물리적 인덱스 기반으로 재설정 (꼬임 방지)
        arr.forEach((item, i) => item.order = (i + 1) * 10);
        renderAdmin(); renderApp();
    }

    // 1. 초기화 버튼 눌렀을 때 실행되는 함수 (우리가 만든 큰 창을 띄웁니다)
    function resetAllFilters() {
        // HTML에 있는 id와 똑같이 맞춰야 창이 뜹니다.
        document.getElementById('reset-confirm-modal').style.display = 'flex';
    }

    // 2. [아니오] 버튼 클릭 시 창 닫기
    function closeResetModal() {
        document.getElementById('reset-confirm-modal').style.display = 'none';
    }

    // 3. [예] 버튼 클릭 시 실제 초기화 작업
    function executeReset() {
        selectedAge = 'none';
        selectedIssue = 'none';
        userPower = {rs:0, rc:0, ls:0, lc:0};
        
        document.getElementById('disp-age').innerText = "나이";
        document.getElementById('disp-issue').innerText = "없음";
        
        // 이 두 줄을 새 ID에 맞게 수정하세요
        document.getElementById('disp-s').innerText = "0.00";
        document.getElementById('disp-c').innerText = "0.00";

        renderApp();
        closeResetModal();
    }

    function moveUnified(idx, dir) {
        let pool = [];
        brands.forEach(b => b.lenses.forEach(l => { if(l.tabId === adminSelectedTabId) pool.push(l); }));
        matrices.forEach(m => { if(m.tabId === adminSelectedTabId) pool.push(m); });
        pool.sort((a,b) => (a.order || 0) - (b.order || 0));
        
        if (idx + dir < 0 || idx + dir >= pool.length) return;
        
        const temp = pool[idx];
        pool[idx] = pool[idx + dir];
        pool[idx + dir] = temp;

        pool.forEach((item, i) => item.order = (i + 1) * 10);
        renderAdmin(); renderApp();
    }

    // [메인 화면 렌더링]
    function renderApp() {
        const sortedCats = [...categories];
        // 상단 탭 메뉴 그리기
        document.getElementById('tab-nav').innerHTML = sortedCats.map(c => `<div class="tab ${currentTabId===c.id?'active':''}" onclick="currentTabId='${c.id}'; renderApp();">${c.name}</div>`).join('');
        
        let pool = [];
        // 1. 일반 렌즈 데이터를 모음
        brands.forEach(b => b.lenses.forEach(l => {
            if(currentTabId === l.tabId || (currentTabId === 'ai' && l.targetIssues?.includes(selectedIssue) && l.targetAges?.includes(selectedAge))) {
                pool.push({...l, type:'normal', brandName: b.name});
            }
        }));

        // 2. 매트릭스 데이터를 모음
        matrices.forEach(m => {
            if(currentTabId === m.tabId || (currentTabId === 'ai' && m.targetIssues?.includes(selectedIssue) && m.targetAges?.includes(selectedAge))) {
                pool.push({...m, type:'matrix'});
            }
        });

        if (Array.isArray(images)) {
            images.forEach(img => {
                // 현재 보고 있는 탭과 이미지에 설정된 탭이 같을 때만 pool에 넣음
                if(currentTabId === img.tabId) {
                    pool.push({...img, type:'imageCard'}); // type을 imageCard로 명시
                }
            });
        }

        // 3. 홍보 이미지 데이터를 모음
        images.forEach(img => { 
            // 이미지의 tabId와 현재 관리자 창에서 선택한 탭Id가 같을 때만 목록에 추가합니다.
            if(img && img.tabId === adminSelectedTabId) {
                pool.push({
                    id: img, 
                    name: img.name || '새 홍보 이미지', 
                    b: '[이미지]', 
                    type: '광고'
                }); 
            }
        });
        
        // 정해진 순서(order)대로 정렬
        pool.sort((a,b) => (a.order || 999) - (b.order || 999));

        // 화면에 카드들을 그림
        let html = '<div class="card-grid">';
        pool.forEach(item => {
            if(item.type === 'matrix') html += renderMatrixHtml(item);
            else if(item.type === 'imageCard') html += renderImageCardHtml(item); // 이미지 전용
            else html += renderNormalHtml(item);
        });
        
        // 탭 하단 배너 처리
        const curCat = categories.find(c => c.id === currentTabId);
        let banner = (curCat && curCat.img) ? `<img src="${curCat.img}" style="width:100%; max-width:100%; display:block; margin:5px 0; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">` : '';
        document.getElementById('main-display').innerHTML = html + '</div>' + banner;
    }

    function renderImageCardHtml(img) {
        return `
        <div class="image-card" style="grid-column: span 1; border-radius:15px; overflow:hidden; box-shadow:0 5px 20px rgba(0,0,0,0.05); background:white;">
            <img src="${img.url}" style="width:100%; display:block; object-fit:contain;">
        </div>`;
    }

    /* --- 2번 단계 최종 교체 코드 --- */
    function renderNormalHtml(l) {
        if (!l.items || !Array.isArray(l.items)) return '';

        let rows = ''; 
        let match = false;
        
        // 1. 세일 상태(l.isSale)에 따라 카드에 'sale-active'라는 이름을 붙여줍니다.
        const saleClass = l.isSale ? 'sale-active' : ''; 

        /* --- 1. 도수 및 합도수 필터링 핵심 로직 --- */
                l.items.forEach(it => {
                    // 합도수(원시) 계산: S와 S+C 중 더 큰 값이 렌즈 두께의 기준이 됩니다.
                    const rMaxP = Math.max(userPower.rs, userPower.rs + userPower.rc);
                    const lMaxP = Math.max(userPower.ls, userPower.ls + userPower.lc);

                    // 개별 도수 체크 (S구면 범위, C난시 범위 확인)
                    const isOutIndividual = (userPower.rs > it.sMax || userPower.rs < it.sMin || userPower.rc < it.cMin || userPower.ls > it.sMax || userPower.ls < it.sMin || userPower.lc < it.cMin);
                    
                    // 합도수 체크 (∑합 칸에 값이 입력되어 있을 때만 작동)
                    const isOutSum = (it.sumMax > 0 && (rMaxP > it.sumMax || lMaxP > it.sumMax));

                    // 개별 범위나 합도수 중 하나라도 벗어나면 'out' 처리하여 가립니다.
                    const out = isOutIndividual || isOutSum;
                    
                    if(!out) match = true;
            
            // 가격 출력 (NaN 방지 처리 포함)
            const cleanOff = Number(String(it.pOff || 0).replace(/[^0-9]/g, ''));
            const cleanSale = Number(String(it.pSale || 0).replace(/[^0-9]/g, ''));

            rows += `<tr class="${out?'disabled-row':''}">
                <td>${it.idx}</td>
                <td>${it.spec}</td>
                <td style="text-align:right;">
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <span style="text-decoration:line-through; font-size:0.75em; color:#bbb;">
                            ${cleanOff > 0 ? cleanOff.toLocaleString() + '원' : ''}
                        </span>
                        <span class="price-text" style="font-weight:900; font-size:1.1em;">
                            ${cleanSale.toLocaleString()}원
                        </span>
                    </div>
                </td>
            </tr>`;
        });

        if(isFilterActive && !match && (userPower.rs !== 0 || userPower.ls !== 0)) return '';

        const bgColor = l.bgColor || '#2c3e50';
        const textColor = getContrastColor(bgColor);

        // 2. 카드 전체 상자(lens-card)에 위에서 만든 saleClass를 적용합니다.
        return `<div class="lens-card ${saleClass}">
            <div class="card-head" style="background:${bgColor}; color:${textColor}">
                <span>${l.brandName} ${l.name}</span>
                ${l.isSale ? `<span class="sale-badge animate" style="background:${textColor}; color:${bgColor};">SALE</span>` : ''}
            </div>
            ${l.desc ? `<div class="lens-one-liner">💡 ${l.desc}</div>` : ''}
            <table class="card-table">
                <thead><tr><th>굴절률</th><th>설계</th><th style="text-align:right;">가격</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>`;
    }

    function renderMatrixHtml(m) {
        // 1. 전체 제목 배경색에 맞는 글씨색 계산
        const titleBg = m.brandColor || '#2c3e50';
        const titleTextColor = getContrastColor(titleBg);

        let h = `<div class="matrix-container">
                    <div class="matrix-title" style="background:${titleBg}; color:${titleTextColor}">
                        ${m.brand} - ${m.name}
                    </div>
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="idx-col">굴절률</th>`;

        m.cols.forEach(c => {
                const colBg = c.bgColor || '#fdfdfd';
                const colTextColor = getContrastColor(colBg);
                
                // 하이라이트 색상 설정 (글씨가 흰색이면 연한 흰색 투명, 검정이면 연한 검정 투명 박스)
                const highlightBg = colTextColor === '#fff' ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.08)';
                
                h += `<th style="background:${colBg}; color:${colTextColor}; vertical-align: middle; padding: 15px 5px;">
                        <div style="font-size:1.15em; font-weight:900; margin-bottom: 4px;">${c.name}</div>
                        
                        ${c.desc ? `<div style="font-size:0.82em; font-weight:700; background:${highlightBg}; display:inline-block; padding:3px 12px; border-radius:15px; margin-bottom: 6px;">${c.desc}</div>` : ''}
                        
                        ${(c.addInfo || c.corridor) ? `<div style="font-size:0.75em; opacity:0.85; letter-spacing: -0.5px;">ADD:${c.addInfo||'-'} / 누진:${c.corridor||'-'}</div>` : ''}
                        
                        ${c.isSale ? `<div class="sale-badge" style="margin-top:8px; display:inline-block; background:${colTextColor}; color:${colBg};">SALE</div>` : ''}
                    </th>`;
            });

        h += `</tr></thead><tbody>`;
        fixedIndices.forEach(idx => {
            const sk = 'idx_'+idx.replace('.','');
            const out = (userPower.rs > (idx==='1.56'?4:6) || userPower.rs < (idx==='1.56'?-6:-10));
            h += `<tr class="${out?'disabled-row':''}"><td class="idx-col">${idx}</td>`;
            m.cols.forEach(c => {
                const p = (c.prices && c.prices[sk]) || {off:'', sale:''};
                const cleanOff = Number(String(p.off || 0).replace(/[^0-9]/g, ''));
                const cleanSale = Number(String(p.sale || 0).replace(/[^0-9]/g, ''));

                h += `<td>
                        <div style="font-size:0.8em; color:#bbb; text-decoration:line-through;">
                            ${cleanOff > 0 ? cleanOff.toLocaleString() + '원' : ''}
                        </div>
                        <div style="font-weight:900; font-size:1.2em;">
                            ${cleanSale > 0 ? cleanSale.toLocaleString() + '원' : '-'}
                        </div>
                    </td>`;
            });
            h += `</tr>`;
        });
        return h + `</tbody></table></div>`;
    }

    // [관리자 설정 렌더링]
    function renderAdmin() {
            if (!Array.isArray(images)) {
            images = [];
            }

            // 1. 📂 탭 명칭 및 하단 이미지 관리
            document.getElementById('admin-tab-list').innerHTML = categories.map((c, idx) => `
                <div class="tag-row" style="flex-direction:column; align-items:stretch;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="text" value="${c.name}" onchange="categories[${idx}].name=this.value; renderApp();" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; font-weight:bold;">
                        <button class="btn-small" style="background:var(--danger); padding:10px 15px;" onclick="if(confirm('이 탭을 삭제하시겠습니까?')){categories.splice(${idx},1); renderAdmin(); renderApp();}">삭제</button>
                    </div>
                    <input type="text" placeholder="하단 이미지 URL" value="${c.img||''}" onchange="categories[${idx}].img=this.value; renderApp();" style="margin-top:8px; padding:10px; border-radius:8px; border:1px solid #ddd;">
                </div>`).join('');

            // 2. 🔢 탭 노출 순서 관리
            document.getElementById('admin-tab-order-list').innerHTML = categories.map((c, idx) => `
                <div class="tag-row" style="background:white; border:1px solid #ddd;">
                    <button class="btn-small" onclick="moveItem(categories, ${idx}, -1)">◀</button>
                    <b style="font-size:0.9em;">${c.name}</b>
                    <button class="btn-small" onclick="moveItem(categories, ${idx}, 1)">▶</button>
                </div>`).join('');

            // 3. ❓ 불편 증상 항목 관리
            document.getElementById('admin-issue-list').innerHTML = issues.map((is, idx) => `
                <div class="tag-row"><span>${is.name}</span><button class="btn-small" onclick="issues.splice(${idx},1); renderAdmin();">×</button></div>`).join('');

            // 4. 🔢 [통합] 해당 탭 내 제품 노출 순서 관리 (버그 수정: 중복 제거 및 이름 연동)
            let pool = [];
            brands.forEach(b => b.lenses.forEach(l => { if(l.tabId === adminSelectedTabId) pool.push({id:l, name:l.name, b:b.name, type:'일반'}); }));
            matrices.forEach(m => { if(m.tabId === adminSelectedTabId) pool.push({id:m, name:m.name, b:m.brand, type:'매트릭스'}); });
            // 사장님이 지으신 이름(img.name)이 목록에 바로 나오도록 수정했습니다.
            
            if (Array.isArray(images)) {
                images.forEach(img => {
                    if(img.tabId === adminSelectedTabId) pool.push({id:img, name:img.name, b:'[이미지]', type:'홍보광고'});
                });
            }

            pool.sort((a,b) => (a.id.order || 999) - (b.id.order || 999));
            document.getElementById('admin-unified-order-list').innerHTML = pool.map((item, idx) => `
                <div class="tag-row">
                    <button class="btn-small" onclick="moveUnified(${idx}, -1)">▲</button>
                    <button class="btn-small" onclick="moveUnified(${idx}, 1)">▼</button>
                    <span style="font-size:0.85em;">[${item.type}] <b>${item.b}</b> ${item.name}</span>
                </div>`).join('');

            // 6. 🖼️ 홍보 이미지 카드 관리 (window 참조 방식으로 에러 완벽 차단)
            document.getElementById('admin-image-list').innerHTML = (window.images && window.images.length) ? window.images.map((img) => {
                if (!img.id) img.id = 'img_' + Date.now() + Math.random();
                
                return `
                <div class="tag-row" style="flex-direction:column; align-items:stretch; background:white; border:1px solid #d1e3f8; margin-bottom:15px; padding:15px; border-radius:12px;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <span style="font-size:1.2em;">🖼️</span>
                        <input type="text" value="${img.name || ''}" 
                            oninput="const target = window.images.find(x => x.id === '${img.id}'); if(target) target.name = this.value;" 
                            style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; font-weight:bold;" placeholder="이미지 이름">
                        
                        <button class="btn-small" style="background:var(--danger); padding:10px 15px;" 
                                onclick="if(confirm('삭제하시겠습니까?')){ const dIdx = window.images.findIndex(x => x.id === '${img.id}'); if(dIdx > -1) window.images.splice(dIdx, 1); renderAdmin(); renderApp(); }">삭제</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <div style="font-size:0.75em; color:#888; margin-bottom:3px;">출력될 탭 선택</div>
                            <select onchange="const target = window.images.find(x => x.id === '${img.id}'); if(target) target.tabId = this.value; renderAdmin(); renderApp();" 
                                    style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; background:#f9f9f9;">
                                <option value="">탭 미지정</option>
                                ${categories.map(c => `<option value="${c.id}" ${img.tabId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div style="font-size:0.75em; color:#888; margin-bottom:3px;">이미지 주소(URL)</div>
                            <input type="text" value="${img.url || ''}" 
                                oninput="const target = window.images.find(x => x.id === '${img.id}'); if(target) target.url = this.value;" 
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="https://...">
                        </div>
                    </div>
                </div>`;
            }).join('') : '<p style="text-align:center; color:#999; padding:20px;">등록된 이미지가 없습니다.</p>';

            // 5. 📦 일반 브랜드별 제품 상세 설정
            let bHtml = '';
            brands.forEach((b, bi) => {
                const active = openBrandIndex === bi;
                // 안전한 배경색 처리
                const safeBrandColor = (b.bgColor && String(b.bgColor).startsWith('#')) ? b.bgColor : '#2c3e50';

                bHtml += `<div class="admin-section" style="padding:15px; background:${active?'#fff':'#f8f9fa'}">
                    <div style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;" onclick="openBrandIndex=${active?null:bi}; renderAdmin();">
                        <b style="font-size:1.1em;">${b.name} (${b.lenses ? b.lenses.length : 0})</b>
                        <span>${active?'▼':'▶'}</span>
                    </div>
                    <div style="display:${active?'block':'none'}; margin-top:15px; border-top:1px solid #ddd; padding-top:15px;">
                        브랜드명: <input type="text" value="${b.name}" onchange="brands[${bi}].name=this.value;" style="padding:8px;">
                        <button class="btn-small" style="background:var(--danger); float:right;" onclick="if(confirm('브랜드를 삭제하시겠습니까?')){brands.splice(${bi},1); renderAdmin();}">브랜드 삭제</button>
                        
            ${b.lenses ? b.lenses.map((l, li) => {
                // 1. 여기서 색상 에러를 미리 방지합니다.
                const safeLensColor = (l.bgColor && String(l.bgColor).startsWith('#')) ? l.bgColor : '#2c3e50';
                
                return `
                <div style="background:white; padding:15px; border-radius:12px; margin-top:15px; border:1px solid #eee;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                        <button class="btn-small" onclick="moveItem(brands[${bi}].lenses, ${li}, -1);">▲</button>
                        <button class="btn-small" onclick="moveItem(brands[${bi}].lenses, ${li}, 1);">▼</button>
                        
                        🛡️ <input type="text" value="${l.name}" oninput="brands[${bi}].lenses[${li}].name=this.value;" style="flex:1; padding:8px;">
                        
                        <input type="color" value="${safeLensColor}" onchange="brands[${bi}].lenses[${li}].bgColor=this.value; renderApp();">
                        
                        <label style="font-size:0.8em; color:var(--danger); font-weight:bold;">
                            <input type="checkbox" ${l.isSale?'checked':''} onchange="brands[${bi}].lenses[${li}].isSale=this.checked; renderApp();"> SALE
                        </label>
                        
                        <select onchange="brands[${bi}].lenses[${li}].tabId=this.value; renderAdmin();">
                            <option value="">탭 미지정</option>
                            ${categories.filter(c=>c.id!=='ai').map(c => `<option value="${c.id}" ${l.tabId===c.id?'selected':''}>${c.name}</option>`).join('')}
                        </select>
                        <button onclick="if(confirm('삭제하시겠습니까?')){brands[${bi}].lenses.splice(${li},1); renderAdmin();}">×</button>
                    </div>
                    
                    <input type="text" value="${l.desc||''}" oninput="brands[${bi}].lenses[${li}].desc=this.value;" placeholder="한줄 설명" style="width:100%; margin-bottom:10px; padding:8px;">
                    
                    <div style="background:#fcfcfc; padding:10px; border-radius:8px; margin-bottom:12px; font-size:0.85em; border:1px solid #eee;">
                        <div style="margin-bottom:8px; font-weight:bold; color:var(--primary);">🎯 AI 추천 타겟 설정 (체크 시 AI 탭에 노출)</div>
                        <div style="display:flex; flex-wrap:wrap; gap:15px;">
                            <div>
                                <span style="color:#888; font-weight:bold;">[연령대]</span>
                                ${['adult', 'student', 'senior'].map(age => {
                                    const kor = {adult:'성인', student:'학생', senior:'시니어'}[age];
                                    return `<label style="margin-left:8px; cursor:pointer;"><input type="checkbox" ${(l.targetAges||[]).includes(age)?'checked':''} onchange="toggleT(${bi}, ${li}, 'age', '${age}')"> ${kor}</label>`;
                                }).join('')}
                            </div>
                            <div style="border-left:1px solid #eee; padding-left:15px;">
                                <span style="color:#888; font-weight:bold;">[불편증상]</span>
                                ${issues.map(is => `
                                    <label style="margin-left:8px; cursor:pointer;"><input type="checkbox" ${(l.targetIssues||[]).includes(is.id)?'checked':''} onchange="toggleT(${bi}, ${li}, 'issue', '${is.id}')"> ${is.name}</label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    ${l.items ? l.items.map((it, ii) => `
                        <div style="display:grid; grid-template-columns: 60px 150px 80px 80px 245px 40px; gap:8px; margin-bottom:8px; align-items:center;">
                            <input type="text" value="${it.idx}" oninput="brands[${bi}].lenses[${li}].items[${ii}].idx=this.value;" style="width:100%; padding:5px;">
                            <input type="text" value="${it.spec}" oninput="brands[${bi}].lenses[${li}].items[${ii}].spec=this.value;" style="width:100%; padding:5px;" placeholder="설계">
                            <input type="text" value="${Number(it.pOff||0).toLocaleString()}" oninput="inputPriceFormat(this, (v) => brands[${bi}].lenses[${li}].items[${ii}].pOff = v)" style="width:100%; padding:5px;">
                            <input type="text" value="${Number(it.pSale||0).toLocaleString()}" oninput="inputPriceFormat(this, (v) => brands[${bi}].lenses[${li}].items[${ii}].pSale = v)" style="width:100%; padding:5px;">
                            
                            <div style="font-size:0.72em; background:#f0f7ff; padding:5px; border-radius:8px; display:flex; align-items:center; gap:4px; border:1px solid #d1e3f8;">
                                <b style="color:#d63031;">S+</b><input type="number" step="0.25" value="${it.sMax}" style="width:38px; font-weight:bold;" oninput="brands[${bi}].lenses[${li}].items[${ii}].sMax=parseFloat(this.value)">
                                ~<input type="number" step="0.25" value="${it.sMin}" style="width:38px;" oninput="brands[${bi}].lenses[${li}].items[${ii}].sMin=parseFloat(this.value)">
                                <b style="color:#0984e3;">C</b><input type="number" step="0.25" value="${it.cMin||0}" style="width:38px;" oninput="brands[${bi}].lenses[${li}].items[${ii}].cMin=parseFloat(this.value)">
                                <span style="color:#ccc;">|</span>
                                <b style="color:#f39c12;">∑</b><input type="number" step="0.25" value="${it.sumMax||0}" style="width:38px; background:#fffbe6; border:1px solid #ffe066;" oninput="brands[${bi}].lenses[${li}].items[${ii}].sumMax=parseFloat(this.value)">
                            </div>
                            <button class="btn-small" style="background:#95a5a6;" onclick="brands[${bi}].lenses[${li}].items.splice(${ii},1); renderAdmin();">×</button>
                        </div>`).join('') : ''}
                    <button class="btn-small" style="background:var(--accent); padding:10px 20px;" onclick="const nextIdx = getNextIndexValue(brands[${bi}].lenses[${li}].items); brands[${bi}].lenses[${li}].items.push({idx: nextIdx, spec:'', pOff:'0', pSale:'0', sMin:-10, sMax:6, cMin:-4, sumMax:0}); renderAdmin();">+ 사양 추가</button>
                </div>`;
            }).join('') : ''}

                        <button class="btn-ui" style="background:var(--success); width:100%; margin-top:15px; padding:15px;" onclick="addNewLens(${bi})">+ 새 제품 카드 추가</button>
                    </div>
                </div>`;
            });
            document.getElementById('admin-brands-list').innerHTML = bHtml;
            const validTabs = categories.filter(c => c.id !== 'ai');
            document.getElementById('admin-order-tab-select').innerHTML = validTabs.map(c => `<option value="${c.id}" ${adminSelectedTabId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
        } // renderAdmin 함수 끝

    // [피커 및 도수 제어]
    function openPowerPicker(type) {
        const overlay = document.getElementById('picker-overlay');
        const grid = document.getElementById('picker-grid-content');
        const title = document.getElementById('picker-title');
        overlay.style.display = 'flex'; 
        grid.innerHTML = '';
        
        let min, max;
        // 's'는 구면, 'c'는 난시
        if(type === 's') { 
            title.innerText = "구면 도수(SPH) 선택 (+8.00 ~ -15.00)"; 
            min = -15; max = 8; 
        } else { 
            title.innerText = "난시 도수(CYL) 선택 (0.00 ~ -7.00)"; 
            min = -7; max = 0; 
        }
        
        // 현재 값 확인 (rs 기준으로 체크)
        const currentVal = (type === 's') ? userPower.rs : userPower.rc;

        for(let i = max; i >= min; i -= 0.25) {
            const val = i.toFixed(2);
            const btn = document.createElement('div');
            btn.className = `pick-btn ${i > 0 ? 'plus' : (i < 0 ? 'minus' : '')} ${currentVal.toFixed(2) === val ? 'selected' : ''}`;
            btn.innerText = (i > 0 ? "+" : "") + val;
            
            btn.onclick = () => { 
                const numVal = parseFloat(val);
                if(type === 's') {
                    // S 선택 시 우S, 좌S 모두 변경
                    userPower.rs = numVal; 
                    userPower.ls = numVal;
                } else {
                    // C 선택 시 우C, 좌C 모두 변경
                    userPower.rc = numVal; 
                    userPower.lc = numVal;
                }
                document.getElementById('disp-'+type).innerText = (i>0?"+":"")+val; 
                overlay.style.display='none'; 
                renderApp(); 
            };
            grid.appendChild(btn);
        }
    }

    function openGeneralPicker(mode) {
        const overlay = document.getElementById('picker-overlay');
        const grid = document.getElementById('picker-grid-content');
        const title = document.getElementById('picker-title');
        overlay.style.display = 'flex'; grid.innerHTML = '';
        const opts = (mode === 'age') 
            ? [{id:'none', n:'없음'}, {id:'student', n:'학생'}, {id:'adult', n:'성인'}, {id:'senior', n:'시니어'}] 
            : issues;
        title.innerText = (mode === 'age') ? "상담 대상 연령 선택" : "불편 증상 선택";
        opts.forEach(o => {
            const btn = document.createElement('div'); btn.className = `pick-btn ${ (mode==='age' ? selectedAge===o.id : selectedIssue===o.id) ? 'selected' : '' }`; 
            btn.innerText = o.name || o.n;
        btn.onclick = () => {
                if(mode==='age') {
                    selectedAge = o.id;
                    // '없음'을 누르면 버튼에 '나이'라고 표시, 그 외엔 선택한 이름 표시
                    document.getElementById('disp-age').innerText = (o.id === 'none') ? "나이" : o.n;
                } else {
                    selectedIssue = o.id;
                    document.getElementById('disp-issue').innerText = o.name;
                }
                overlay.style.display='none'; 
                renderApp();
            };
            grid.appendChild(btn);
        });
    }

    // [매트릭스 로직]
    function openMatrix() { 
            document.getElementById('ui-overlay').style.display='block'; 
            document.getElementById('matrix-modal').style.display='block'; 
            openMatrixIndex = null; // 켤 때 모두 닫힌 상태로 시작
            renderSavedMatrices(); 
        }
    function closeMatrix() { document.getElementById('matrix-modal').style.display='none'; document.getElementById('ui-overlay').style.display='none'; }
    function renderSavedMatrices() { 
        const container = document.getElementById('saved-matrices-list');
        container.style.display = 'block'; // 한 줄로 나오게 변경
        
        container.innerHTML = matrices.map((m, i) => {
            const active = (openMatrixIndex === i);
            const tabName = categories.find(c => c.id === m.tabId)?.name || '미지정';
            
            return `
            <div class="matrix-list-item">
                <div class="matrix-item-header" onclick="openMatrixIndex = ${active ? 'null' : i}; renderSavedMatrices();">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="matrix-badge">${tabName}</span>
                        <b style="font-size:1.1em;">${m.brand} - ${m.name}</b>
                    </div>
                    <span style="color:#999;">${active ? '▲ 접기' : '▼ 클릭하여 관리'}</span>
                </div>
                
                <div class="matrix-item-body" style="display:${active ? 'block' : 'none'}">
                    <div style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:10px; border-radius:8px;">
                        <div style="display:flex; gap:8px;">
                            <button class="btn-small" onclick="moveItem(matrices, ${i}, -1); renderSavedMatrices();">▲ 위로</button>
                            <button class="btn-small" onclick="moveItem(matrices, ${i}, 1); renderSavedMatrices();">▼ 아래로</button>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-ui" style="background:var(--accent); font-size:0.85em; padding:8px 15px;" onclick="editMatrix(${i})">⚙️ 데이터 수정</button>
                            <button class="btn-ui" style="background:var(--danger); font-size:0.85em; padding:8px 15px;" onclick="if(confirm('삭제하시겠습니까?')){matrices.splice(${i},1); renderSavedMatrices();}">🗑️ 삭제</button>
                        </div>
                    </div>
                    <div style="margin-top:15px; font-size:0.9em; color:#666;">
                        • 타겟: ${m.targetAges?.join(', ') || '전체'} / ${m.targetIssues?.map(id => issues.find(is=>is.id===id)?.name).join(', ') || '증상없음'}
                    </div>
                </div>
            </div>`;
        }).join(''); 
    }
    function showMatrixEditor() { editingMatrix = {brand:'', name:'', brandColor:'#2c3e50', tabId:'', targetAges:['adult'], targetIssues:['none'], cols:[{name:'', desc:'', addInfo:'', corridor:'', bgColor:'#fdfdfd', prices:{}}]}; updateMEUI(); }
    function editMatrix(i) { editingMatrix = JSON.parse(JSON.stringify(matrices[i])); editingMatrix.originalIndex = i; updateMEUI(); }

    function updateMEUI() {
        document.getElementById('matrix-editor').style.display = 'block';
        document.getElementById('m-tab').innerHTML = categories.filter(c=>c.id!=='ai').map(c => `<option value="${c.id}" ${editingMatrix.tabId===c.id?'selected':''}>${c.name}</option>`).join('');
        document.getElementById('m-brand').value = editingMatrix.brand; document.getElementById('m-brand-color').value = (editingMatrix.brandColor && editingMatrix.brandColor !== 'undefined') ? editingMatrix.brandColor : '#2c3e50';
        document.getElementById('m-ages-wrap').innerHTML = ['student','adult','senior'].map(a => `<label style="margin-right:12px;"><input type="checkbox" class="m-age-chk" value="${a}" ${editingMatrix.targetAges?.includes(a)?'checked':''}> ${a}</label>`).join('');
        document.getElementById('m-issues-wrap').innerHTML = issues.map(is => `<label style="margin-right:12px;"><input type="checkbox" class="m-issue-chk" value="${is.id}" ${editingMatrix.targetIssues?.includes(is.id)?'checked':''}> ${is.name}</label>`).join('');
        
        let h = `<tr><th>굴절률</th>`;
        editingMatrix.cols.forEach((c, i) => {
            h += `<th>
                <div style="background:#eee; padding:5px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:center; gap:5px;">
                    <button class="btn-small" onclick="moveMECol(${i}, -1)">◀</button>
                    <button class="btn-small" onclick="moveMECol(${i}, 1)">▶</button>
                    <button class="btn-small" style="background:var(--danger)" onclick="editingMatrix.cols.splice(${i},1); updateMEUI();">×</button>
                </div>
                <input class="me-input" id="col-n-${i}" value="${c.name}" placeholder="등급명">
                <input class="me-input" id="col-d-${i}" value="${c.desc||''}" placeholder="한줄설명">
                <div style="display:flex; gap:3px;"><input class="me-input" id="col-add-${i}" value="${c.addInfo||''}" placeholder="ADD"><input class="me-input" id="col-cor-${i}" value="${c.corridor||''}" placeholder="누진대"></div>
                <input type="color" id="col-c-${i}" value="${(c.bgColor && String(c.bgColor).startsWith('#')) ? c.bgColor : '#fdfdfd'}">
                <label style="font-size:0.8em; font-weight:bold;"><input type="checkbox" id="col-s-${i}" ${c.isSale?'checked':''}> SALE</label>
            </th>`;
        });
        document.getElementById('m-header').innerHTML = h + `<th onclick="saveMEState(); editingMatrix.cols.push({name:'', desc:'', addInfo:'', corridor:'', bgColor:'#fdfdfd', prices:{}}); updateMEUI();" style="cursor:pointer; background:var(--accent); color:white;">+ 추가</th></tr>`;
        
        let b = '';

        fixedIndices.forEach(idx => {
            b += `<tr><td class="idx-col">${idx}</td>`;
            editingMatrix.cols.forEach((c, i) => {
                const sk = 'idx_' + idx.replace('.', '');
                const p = (c.prices && c.prices[sk]) || { off: '', sale: '' };
                
                // 데이터에 혹시 쉼표가 섞여있어도 숫자로만 깔끔하게 정리합니다.
                const displayOff = String(p.off || "").replace(/[^0-9]/g, "");
                const displaySale = String(p.sale || "").replace(/[^0-9]/g, "");

                b += `<td>
                    <input id="p-o-${idx}-${i}" 
                        value="${displayOff ? Number(displayOff).toLocaleString() : ''}" 
                        placeholder="정가" 
                        oninput="inputPriceFormat(this, (v) => { if(!editingMatrix.cols[${i}].prices) editingMatrix.cols[${i}].prices={}; if(!editingMatrix.cols[${i}].prices['${sk}']) editingMatrix.cols[${i}].prices['${sk}']={}; editingMatrix.cols[${i}].prices['${sk}'].off = v; })" 
                        style="width:85%; margin-bottom:4px; padding:6px; border-radius:4px; border:1px solid #eee; text-align:right;">
                    <br>
                    <input id="p-s-${idx}-${i}" 
                        value="${displaySale ? Number(displaySale).toLocaleString() : ''}" 
                        placeholder="판매가" 
                        oninput="inputPriceFormat(this, (v) => { if(!editingMatrix.cols[${i}].prices) editingMatrix.cols[${i}].prices={}; if(!editingMatrix.cols[${i}].prices['${sk}']) editingMatrix.cols[${i}].prices['${sk}']={}; editingMatrix.cols[${i}].prices['${sk}'].sale = v; })" 
                        style="width:85%; padding:6px; border-radius:4px; border:1px solid #eee; text-align:right; font-weight:bold; color:var(--sale);">
                </td>`;
            });
            b += `<td></td></tr>`;
        });
        document.getElementById('m-body').innerHTML = b;
    }

    function saveMEState() {
        editingMatrix.brand = document.getElementById('m-brand').value;
        editingMatrix.brandColor = document.getElementById('m-brand-color').value;
        editingMatrix.name = document.getElementById('m-name').value;
        editingMatrix.tabId = document.getElementById('m-tab').value;
        editingMatrix.targetAges = Array.from(document.querySelectorAll('.m-age-chk:checked')).map(x=>x.value);
        editingMatrix.targetIssues = Array.from(document.querySelectorAll('.m-issue-chk:checked')).map(x=>x.value);
        editingMatrix.cols.forEach((c, i) => {
            c.name = document.getElementById(`col-n-${i}`).value;
            c.desc = document.getElementById(`col-d-${i}`).value;
            c.addInfo = document.getElementById(`col-add-${i}`).value;
            c.corridor = document.getElementById(`col-cor-${i}`).value;
            c.bgColor = document.getElementById(`col-c-${i}`).value;
            c.isSale = document.getElementById(`col-s-${i}`).checked;
            fixedIndices.forEach(idx => {
                const sk = 'idx_'+idx.replace('.','');
                const rawOff = document.getElementById(`p-o-${idx}-${i}`).value.replace(/,/g, "");
                const rawSale = document.getElementById(`p-s-${idx}-${i}`).value.replace(/,/g, "");
            if(!c.prices) c.prices = {};
            c.prices[sk] = { off: rawOff, sale: rawSale };
            });
        });
    }

    function moveMECol(idx, dir) { saveMEState(); if (idx + dir < 0 || idx + dir >= editingMatrix.cols.length) return; const temp = editingMatrix.cols[idx]; editingMatrix.cols[idx] = editingMatrix.cols[idx + dir]; editingMatrix.cols[idx + dir] = temp; updateMEUI(); }
    function saveMatrixToMemory() {
        saveMEState();
        if(editingMatrix.originalIndex !== undefined) matrices[editingMatrix.originalIndex] = editingMatrix;
        else matrices.push(editingMatrix);
        document.getElementById('matrix-editor').style.display = 'none'; 
        renderSavedMatrices();
        renderApp();
    }

    // 숫자를 입력하면 실시간으로 쉼표를 찍어주는 함수
    function inputPriceFormat(input, callback) {
        let val = input.value.replace(/,/g, ""); // 기존 쉼표 제거
        if (isNaN(val)) val = ""; // 숫자가 아니면 삭제
        
        // 데이터 저장용 (숫자만)
        callback(val); 
        
        // 화면 표시용 (쉼표 추가)
        input.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ","); 
    }

    // [기타 기능들]
    function togglePowerFilter() { isFilterActive = !isFilterActive; const btn = document.getElementById('filter-toggle-btn'); if(isFilterActive) { document.body.classList.remove('filter-off'); btn.innerText = "⚡ 필터 작동중"; btn.style.background = "var(--danger)"; } else { document.body.classList.add('filter-off'); btn.innerText = "🔍 도수 적용 안함"; btn.style.background = "#95a5a6"; } }
    function secureAdminOpen() { const pw = prompt("비밀번호 입력"); if(pw === "1111") toggleAdmin(); }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = (p.style.display==='block'?'none':'block'); if(p.style.display==='block') renderAdmin(); }
    function closeAllModals() { document.querySelectorAll('.admin-panel, #matrix-modal, #picker-overlay, #excel-modal').forEach(el=>el.style.display='none'); document.getElementById('ui-overlay').style.display='none'; }
    function saveData() {
        if(confirm("서버에 최종 저장하시겠습니까?")) {
            // 저장 시 images 배열을 반드시 포함해야 합니다.
            db.ref('lensData').set({
                categories, 
                brands, 
                issues, 
                matrices,
                images  // 이미지 데이터 추가
            })
            .then(() => alert("✅ 저장 완료!"))
            .catch((error) => alert("저장 실패: " + error.message));
        }
    }
    function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({categories, brands, issues, matrices})], {type:'application/json'})); a.download='eyegentry_backup.json'; a.click(); }
    function importData() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = event => { const imported = JSON.parse(event.target.result); if(confirm("데이터를 복구하시겠습니까?")) { categories = imported.categories || categories; brands = imported.brands || []; issues = imported.issues || issues; matrices = imported.matrices || []; renderAdmin(); renderApp(); alert("복구 완료!"); } }; reader.readAsText(file); }; input.click(); }

    function addCategory() { const n = document.getElementById('new-cat-name').value; if(n) { categories.push({id:'t'+Date.now(), name:n, img:'', order: categories.length * 10}); renderAdmin(); }}
    function addIssue() { const n = document.getElementById('new-issue-name').value; if(n) { issues.push({id:'is'+Date.now(), name:n}); renderAdmin(); }}
    function addNewBrand() { brands.push({name: '새 브랜드', lenses: []}); openBrandIndex = brands.length - 1; renderAdmin(); }
    function addNewLens(bi) {
        if (!brands[bi].lenses) brands[bi].lenses = [];
        brands[bi].lenses.push({
            name: '새 제품', 
            tabId: '', 
            bgColor: '#2c3e50', // 명시적 기본색 지정
            items: [], 
            targetAges:['adult'], 
            targetIssues:['none'], 
            isSale:false, 
            order: (brands[bi].lenses.length + 1) * 10
        });
        renderAdmin();
    }
    function toggleT(bi, li, type, val) {
        let l = brands[bi].lenses[li];
        if(type === 'age') {
            l.targetAges = l.targetAges || [];
            let idx = l.targetAges.indexOf(val);
            if(idx > -1) l.targetAges.splice(idx, 1);
            else l.targetAges.push(val);
        } else {
            l.targetIssues = l.targetIssues || [];
            let idx = l.targetIssues.indexOf(val);
            if(idx > -1) l.targetIssues.splice(idx, 1);
            else l.targetIssues.push(val);
        }
        renderAdmin(); // 관리자 화면 갱신
        renderApp();   // 메인 화면 갱신
    }
    function processExcel() { const input = document.getElementById('excel-input').value.trim(); if(!input) return; input.split('\n').forEach(line => { const cols = line.split('\t'); if(cols.length < 6) return; const [bN, lN, idx, spec, pOff, pSale, sMin, sMax, cMin] = cols.map(c => c.trim()); let b = brands.find(x => x.name === bN); if(!b) { b = {name: bN, lenses: []}; brands.push(b); } let l = b.lenses.find(x => x.name === lN); if(!l) { l = {name: lN, tabId: '', items: [], targetAges:['adult'], targetIssues:['none'], order: b.lenses.length * 10}; b.lenses.push(l); } l.items.push({idx, spec, pOff, pSale, sMin: parseFloat(sMin)||-10, sMax: parseFloat(sMax)||6, cMin: parseFloat(cMin)||-4}); }); renderAdmin(); renderApp(); alert("업로드 완료"); }
    // [초기화 함수] - 앱을 처음 실행할 때 호출됩니다.
    function init() {
        console.log("아이젠트리 충남도청점 시스템 시작...");
        
        // 1. 서버에서 데이터를 가져옵니다. (기존에 정의된 함수 호출)
        if (typeof loadDataFromServer === "function") {
            loadDataFromServer();
        } else {
            // 서버 연결 함수가 없을 경우를 대비한 기본 렌더링
            renderApp();
        }
    }
    init();
    
    // 전체화면 토글 함수
    function toggleFullScreen() {
        const btn = document.getElementById('fullscreen-btn');
        
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().then(() => {
                // 글자 대신 아이콘만 유지 (또는 끄기 아이콘으로 변경 가능)
                btn.innerHTML = "📺"; 
                btn.style.background = "rgba(230, 126, 34, 0.3)"; // 활성화 시 살짝 주황빛
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
                btn.innerHTML = "📺";
                btn.style.background = "rgba(255,255,255,0.05)"; // 원래 색으로 복구
            }
        }
    }

    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('fullscreen-btn');
        if (!document.fullscreenElement) {
            btn.innerHTML = "📺";
            btn.style.background = "rgba(255,255,255,0.05)";
        }
    });

// [이미지 카드 추가 기능 - 하나로 통합 및 개선]
    function addNewImageCard() {
        images.push({
            id: 'img_' + Date.now(),
            name: '새 홍보 이미지 카드',
            url: '', 
            tabId: adminSelectedTabId || (categories[1] ? categories[1].id : ''), 
            order: (images.length + 1) * 10,
            targetAges: ['adult', 'student', 'senior'],
            targetIssues: ['none']
        });
        
        renderAdmin(); 
        renderApp();
        alert("이미지 카드가 추가되었습니다. 목록에서 '출력될 탭'을 정하고 이름과 주소를 입력하세요.");
    }

    // [비밀번호 확인 및 관리자창 열기]
    function secureAdminOpen() { 
        const pw = prompt("관리자 비밀번호를 입력하세요."); 
        if(pw === "1111") {
            toggleAdmin(); 
        } else {
            alert("비밀번호가 틀렸습니다.");
        }
    }

    // [시스템 시작]
    init();''

    const pImg = new Image();
    pImg.crossOrigin = "anonymous";
    pImg.src = 'https://images.unsplash.com/photo-1541123437800-1bb1317badc2?q=80&w=1200';

    const pConfigs = [
        { id: 'p-canvas-sph', factor: 1.0 },
        { id: 'p-canvas-asph', factor: 0.4 },
        { id: 'p-canvas-dasph', factor: 0.15 }
    ];

    /* 3. 시뮬레이터 전용 로직 통합 (스크립트 최하단에 추가) */
let sBase = 'normal', sAstig = false, sLens = false;
const sConf = {
    normal: { x: 855, blur: 0, text: "정시" },
    myopia: { x: 750, blur: 1.5, text: "근시" },
    hyperopia: { x: 950, blur: 1.5, text: "원시" },
    astigmatism: { x: 850, blur: 2, text: "단순 난시" }
};

// 1. 시뮬레이션 세부 메뉴 토글 (열고 닫기)
function toggleSimDropdown() {
    const menu = document.getElementById('sim-menu-list');
    const isVisible = menu.style.display === 'block';
    menu.style.display = isVisible ? 'none' : 'block';
}

// 2. 세부 메뉴에서 기능을 선택했을 때 실행 (통교체용 코드)
function openSimulator(type) {
    // 1. 드롭다운 메뉴 닫기
    const menu = document.getElementById('sim-menu-list');
    if(menu) menu.style.display = 'none';
    
    // 2. 창 열기 (탭 구조를 위해 block 대신 flex 사용)
    document.getElementById('sim-modal').style.display = 'flex';
    document.getElementById('ui-overlay').style.display = 'block';
    
    // 3. 타이밍 버그 해결: 0.1초 뒤에 첫 번째 탭(굴절 이상) 활성화
    // 창이 완전히 화면에 그려진 뒤에 그림을 그려야 좌표가 안 틀립니다.
    setTimeout(() => {
        switchSimTab('refractive'); 
    }, 100);
}

// 3. 메뉴 바깥쪽 클릭 시 메뉴 자동으로 닫기 (편의 기능)
window.addEventListener('click', function(e) {
    const container = document.querySelector('.sim-dropdown-container');
    if (container && !container.contains(e.target)) {
        document.getElementById('sim-menu-list').style.display = 'none';
    }
});

function closeSimulator() {
    document.getElementById('sim-modal').style.display = 'none';
    document.getElementById('ui-overlay').style.display = 'none';
}

function setSimBase(state) {
    sBase = state; 
    sLens = false;
    
    // ★ 추가: 정시를 누르면 난시 추가 상태를 무조건 해제함
    if (state === 'normal') {
        sAstig = false;
    }
    
    if (state === 'astigmatism') sAstig = false;
    renderSim();
}

function toggleSimAstigmatism() {
    // ★ 추가: 현재 정시 상태라면 버튼이 눌리지 않게 리턴
    if (sBase === 'normal') return; 

    sAstig = !sAstig; 
    sLens = false;
    if (sAstig && sBase === 'astigmatism') sBase = 'normal';
    renderSim();
}

function toggleSimLens() {
    // 정시이면서 난시도 추가되지 않은 완벽한 정시 상태면 아예 실행 안 함
    if (sBase === 'normal' && !sAstig) return; 

    sLens = !sLens;
    renderSim();
}

function renderSim() {
    // 1. 요소 찾기
    const astigBtn = document.getElementById('btn-astig-toggle');
    const target = document.getElementById('target');
    const rayTop = document.getElementById('ray-top');
    const rayBottom = document.getElementById('ray-bottom');
    const lensCont = document.getElementById('lens-container');
    const lensShape = document.getElementById('lens-shape');
    const desc = document.getElementById('description');

    // 2. 버튼 UI 상태 제어 (정시일 때 난시버튼 비활성화)
    if (sBase === 'normal') {
        astigBtn.classList.add('disabled'); // 흐리게 만들기
    } else {
        astigBtn.classList.remove('disabled'); // 다시 선명하게
    }
    if (sBase === 'normal' || sBase === 'astigmatism') {
        astigBtn.classList.add('disabled'); 
    } else {
        astigBtn.classList.remove('disabled'); 
    }
    // 3. 버튼 활성화(색상) 표시 제어
    document.querySelectorAll('#sim-modal .btn-base').forEach(b => b.classList.remove('active'));
    const activeBtnId = (sBase === 'astigmatism') ? 'btn-astig' : 'btn-' + sBase;
    const activeBtn = document.getElementById(activeBtnId);
    if(activeBtn) activeBtn.classList.add('active');
    
    astigBtn.classList.toggle('active', sAstig);
    document.getElementById('btn-lens-toggle').classList.toggle('active', sLens);

    // 4. 시각 효과(초점 위치, 흐림, 그림자) 계산
    const base = sConf[sBase === 'astigmatism' ? 'normal' : sBase];
    let fX = sLens ? 850 : base.x;
    let fBlur = sLens ? 0 : base.blur;
    let shadow = "none";

    // 난시 효과 적용 (3방향 그림자)
    if ((sAstig || sBase === 'astigmatism') && !sLens) {
        fBlur += 2;
        shadow = [
            "0 0 15px rgba(0,0,0,0.3)",          
            "30px 5px 4px rgba(0,0,0,0.15)",     
            "-25px 12px 5px rgba(0,0,0,0.12)",   
            "5px -22px 6px rgba(0,0,0,0.1)"      
        ].join(", ");
    }

    // 5. 진단 텍스트 작성
    let name = (sBase === 'astigmatism') ? "단순 난시" : base.text;
    if (sAstig && sBase !== 'astigmatism' && sBase !== 'normal') name += "성 난시";
    else if (sAstig && sBase === 'normal') name = "단순 난시";

    desc.innerHTML = `<b>상태:</b> ${name}<br>` + (sLens ? 
        "<span style='color:#27ae60;'><b>[교정]</b> 아이젠트리의 정밀 검안 렌즈로 초점을 망막에 맺히게 했습니다.</span>" : 
        "초점이 정확하지 않아 시야가 흐려 보입니다.");

    // 6. 실제 화면(DOM)에 적용
    target.style.left = (fX - 22) + "px";
    target.style.top = "160px"; 
    target.style.filter = `blur(${fBlur}px)`;
    target.style.textShadow = shadow;
    target.style.transform = "rotate(180deg)";

    rayTop.setAttribute("points", `115,150 500,150 ${fX},210`);
    rayBottom.setAttribute("points", `115,230 500,230 ${fX},170`);

    // 렌즈 나타나기/사라지기
    if (sLens) {
        lensCont.style.opacity = "1";
        lensShape.className = (sBase === 'hyperopia') ? "biconvex" : "biconcave";
        lensCont.style.zIndex = "10";
    } else {
        lensCont.style.opacity = "0";
    }
}

function setSimBase(state) {
    sBase = state; 
    sLens = false;
    
    // ★ 수정: 정시(normal) 혹은 난시(astigmatism)를 누르면 난시 추가 상태를 무조건 해제함
    if (state === 'normal' || state === 'astigmatism') {
        sAstig = false;
    }
    
    renderSim();
}

function updatePremiumSim() {
    const s = document.getElementById('p-main-slider');
    const label = document.getElementById('p-val-label');
    if (!s || !label) return;

    const val = parseFloat(s.value);
    const percent = ((val - (-12)) / 24) * 100;

    if (val >= 0) {
        s.style.background = `linear-gradient(to top, #eee 50%, #d63031 50%, #d63031 ${percent}%, #eee ${percent}%)`;
        label.style.color = "#d63031";
    } else {
        s.style.background = `linear-gradient(to top, #eee ${percent}%, #1a73e8 ${percent}%, #1a73e8 50%, #eee 50%)`;
        label.style.color = "#1a73e8";
    }
    label.innerText = (val > 0 ? "+" : "") + val.toFixed(2);

    pConfigs.forEach(conf => {
        const cvs = document.getElementById(conf.id);
        if(!cvs) return;
        const ctx = cvs.getContext('2d');
        const size = 300; cvs.width = size; cvs.height = size;
        
        const k = val * 0.0000025 * conf.factor;
        const mag = 1 + (val * 0.005 * conf.factor);
        const sourceSize = size * 2.8; 
        
        const off = document.createElement('canvas');
        off.width = sourceSize; off.height = sourceSize;
        const oCtx = off.getContext('2d');
        oCtx.drawImage(pImg, 0, 0, sourceSize, sourceSize);
        oCtx.strokeStyle = "rgba(255,255,255,0.7)"; 
        oCtx.lineWidth = 2;
        for(let i=0; i<=sourceSize; i+=40) {
            oCtx.beginPath(); oCtx.moveTo(i,0); oCtx.lineTo(i,sourceSize); oCtx.stroke();
            oCtx.beginPath(); oCtx.moveTo(0,i); oCtx.lineTo(sourceSize,i); oCtx.stroke();
        }

        const imgD = oCtx.getImageData(0,0,sourceSize,sourceSize);
        const outD = ctx.createImageData(size,size);

        for (let y=0; y<size; y++) {
            for (let x=0; x<size; x++) {
                const dx = x - 150, dy = y - 150;
                const r2 = dx*dx + dy*dy;
                const f = 1 + k * r2;
                const sx = (sourceSize/2) + dx / (f * mag), sy = (sourceSize/2) + dy / (f * mag);
                if (sx>=0 && sx<sourceSize && sy>=0 && sy<sourceSize) {
                    const sIdx = (Math.floor(sy)*sourceSize + Math.floor(sx))*4, dIdx = (y*size + x)*4;
                    outD.data[dIdx] = imgD.data[sIdx];
                    outD.data[dIdx+1] = imgD.data[sIdx+1];
                    outD.data[dIdx+2] = imgD.data[sIdx+2];
                    outD.data[dIdx+3] = 255;
                }
            }
        }
        ctx.putImageData(outD, 0, 0);
    });
}

/* [근시 진행] 시뮬레이션 데이터 설정 */
const myopiaModes = {
    baby: { scale: 0.60, blur: 4, status: "영유아 (초기 원시안)", color: "#e67e22", desc: "아이들은 원래 안구가 작아 원시 상태로 태어납니다. 성장에 따라 자연스럽게 정시가 됩니다." },
    infant: { scale: 0.82, blur: 0, status: "취학 전 (건강한 정시)", color: "#27ae60", desc: "안구 길이와 시력이 조화를 이루는 가장 건강한 상태입니다. 스마트폰 사용 시 주의가 필요합니다." },
    child: { scale: 1.05, blur: 2, status: "초등학생 (근시 진행)", color: "#3498db", desc: "안구가 급격히 길어지며 <b>축성 근시</b>가 시작되는 시기입니다. 억제 관리가 반드시 필요합니다." },
    teen: { scale: 1.25, blur: 6, status: "중고등생 (고도 근시 위험)", color: "#e74c3c", desc: "안구가 과도하게 길어져 고도 근시로 진행된 상태입니다. 시력 보정뿐 아니라 망막 관리도 중요합니다." }
};

function updateMyopiaMode(modeKey) {
    // 버튼 활성화 클래스 제어
    document.querySelectorAll('.myo-btn').forEach(btn => btn.classList.remove('active'));
    const targetBtn = document.getElementById(`btn-${modeKey}`);
    if(targetBtn) targetBtn.classList.add('active');

    const data = myopiaModes[modeKey];
    
    // 안구 크기 조절 (translateY 유지하면서 scale만 변경)
    const eyeCont = document.getElementById('myo-eye-container');
    eyeCont.style.transform = `translateY(-50%) scale(${data.scale})`;

    // 나무(상) 흐림 정도 조절
    const myoTarget = document.getElementById('myo-target');
    myoTarget.style.filter = `blur(${data.blur}px)`;

    // 텍스트 업데이트
    document.getElementById('myo-status-tag').innerText = data.status;
    document.getElementById('myo-status-tag').style.background = data.color;
    document.getElementById('myo-description').innerHTML = data.desc;
}

/* [근시 억제] 시뮬레이션 데이터 */
const ctrlConfigs = {
    normal: {
        curve: "M 720 45 Q 800 215 720 385", 
        color: "#ff4757",
        rays: { 
            top: "M 150 265 L 720 45", 
            mid: "M 150 215 L 760 215", 
            bot: "M 150 165 L 720 385" 
        },
        status: "원시성 탈초점 발생 (위험)",
        desc: "일반 안경은 주변부 상이 <b>망막 뒤편</b>에 맺힙니다. 뇌는 이 상을 잡기 위해 <b>안구를 뒤로 더 성장</b>시키려 하며, 이것이 근시가 심해지는 주요 원인입니다."
    },
    control: {
        curve: "M 630 75 Q 890 215 630 355", 
        color: "#2ed573",
        rays: { 
            top: "M 150 265 L 630 75", 
            mid: "M 150 215 L 760 215", 
            bot: "M 150 165 L 630 355" 
        },
        status: "근시성 탈초점 유도 (억제)",
        desc: "특수 설계된 렌즈는 주변부 상을 <b>망막 앞쪽(눈 안쪽)</b>으로 강하게 오므려줍니다. 이 상이 <b>'성장 중지 신호'</b> 역할을 하여 안구가 길어지는 것을 효과적으로 억제합니다."
    }
};

function updateCtrlMode(mode) {
    document.querySelectorAll('.ctrl-btn').forEach(b => b.classList.remove('active'));
    const targetBtn = document.getElementById(`btn-ctrl-${mode}`);
    if(targetBtn) targetBtn.classList.add('active');

    const conf = ctrlConfigs[mode];
    const curve = document.getElementById('focal-curve');
    curve.setAttribute('d', conf.curve);
    curve.style.stroke = conf.color;

    document.getElementById('ctrl-ray-top').setAttribute('d', conf.rays.top);
    document.getElementById('ctrl-ray-mid').setAttribute('d', conf.rays.mid);
    document.getElementById('ctrl-ray-bot').setAttribute('d', conf.rays.bot);
    
    const rayElements = ['ctrl-ray-top', 'ctrl-ray-mid', 'ctrl-ray-bot'];
    rayElements.forEach(id => document.getElementById(id).style.stroke = conf.color);

    document.getElementById('ctrl-normal-markers').classList.toggle('visible', mode === 'normal');
    document.getElementById('ctrl-control-markers').classList.toggle('visible', mode === 'control');

    const badge = document.getElementById('ctrl-status-badge');
    badge.innerText = conf.status;
    badge.style.background = conf.color;
    document.getElementById('ctrl-description').innerHTML = conf.desc;
}

// 1. 메인 시뮬레이션 버튼 로직 (드롭다운 없이 바로 창 띄우기)
function toggleSimDropdown() {
    document.getElementById('sim-modal').style.display = 'flex'; // flex로 열어야 레이아웃이 잡힘
    document.getElementById('ui-overlay').style.display = 'block';
    switchSimTab('refractive'); // 기본 첫 번째 탭 활성화
}

// 2. 창 내부 탭 전환 로직
function switchSimTab(tabId) {
    document.querySelectorAll('.sim-panel').forEach(p => p.style.display = 'none');
    document.querySelectorAll('.sim-tab').forEach(t => t.classList.remove('active'));
    
    document.getElementById('panel-' + tabId).style.display = 'block';
    
    // [중요!] 이 부분이 추가되어야 합니다.
    if(event && event.currentTarget) event.currentTarget.classList.add('active');

    // 탭별 시뮬레이션 초기화 실행
    if(tabId === 'refractive') {
        renderSim();
    } 
    /* --- 프리미엄 탭 초기화 코드 추가 --- */
    else if(tabId === 'premium') {
        setTimeout(updatePremiumSim, 150); // 창이 뜨는 시간을 고려해 0.15초 뒤에 실행
    }
    else if(tabId === 'myopia') {
        updateMyopiaMode('infant'); // 탭 열 때 유아기(정시)를 기본으로 보여줌
    }
    else if(tabId === 'control') {
        setTimeout(() => updateCtrlMode('normal'), 100); // 탭 열 때 일반 안경 모드 기본값
    }
}

// 3. 기존의 toggleSimLens 수정 (정시일 때 반응 없음)
function toggleSimLens() {
    if (sBase === 'normal' && !sAstig) return; 
    sLens = !sLens;
    renderSim();
}

// 4. closeSimulator 수정
function closeSimulator() {
    document.getElementById('sim-modal').style.display = 'none';
    document.getElementById('ui-overlay').style.display = 'none';
}

/* 프리미엄 렌즈 시뮬레이션 로직 */
const premiumImg = new Image();
premiumImg.crossOrigin = "anonymous";
premiumImg.src = 'https://images.unsplash.com/photo-1541123437800-1bb1317badc2?q=80&w=1200&auto=format&fit=crop';

const premiumConfigs = [
    { id: 'canvas-sph', factor: 1.0 },
    { id: 'canvas-asph', factor: 0.4 },
    { id: 'canvas-dasph', factor: 0.15 }
];

function updatePremiumLens() {
    const slider = document.getElementById('p-slider');
    const label = document.getElementById('p-label');
    const power = parseFloat(slider.value);
    
    label.innerText = (power > 0 ? "+" : "") + power.toFixed(2);
    label.style.color = power < 0 ? "#1a73e8" : "#d93025";

    premiumConfigs.forEach(item => {
        const canvas = document.getElementById(item.id);
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const size = 300; 
        canvas.width = size; canvas.height = size;
        
        const k = power * 0.0000025 * item.factor;
        const mag = 1 + (power * 0.005 * item.factor);

        // 격자 무늬가 포함된 배경 그리기
        const sourceSize = size * 2.8; 
        const offCanvas = document.createElement('canvas');
        offCanvas.width = sourceSize; offCanvas.height = sourceSize;
        const oCtx = offCanvas.getContext('2d');
        oCtx.drawImage(premiumImg, 0, 0, sourceSize, sourceSize);
        oCtx.strokeStyle = "rgba(255, 255, 255, 0.5)"; 
        for(let i=0; i<=sourceSize; i+=40) {
            oCtx.beginPath(); oCtx.moveTo(i, 0); oCtx.lineTo(i, sourceSize); oCtx.stroke();
            oCtx.beginPath(); oCtx.moveTo(0, i); oCtx.lineTo(sourceSize, i); oCtx.stroke();
        }

        const imgData = oCtx.getImageData(0, 0, sourceSize, sourceSize);
        const outData = ctx.createImageData(size, size);

        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const dx = x - 150; const dy = y - 150;
                const r2 = dx*dx + dy*dy;
                const f = 1 + k * r2;
                const sx = (sourceSize/2) + dx / (f * mag);
                const sy = (sourceSize/2) + dy / (f * mag);
                if (sx >= 0 && sx < sourceSize && sy >= 0 && sy < sourceSize) {
                    const sIdx = (Math.floor(sy) * sourceSize + Math.floor(sx)) * 4;
                    const dIdx = (y * size + x) * 4;
                    outData.data[dIdx] = imgData.data[sIdx];
                    outData.data[dIdx+1] = imgData.data[sIdx+1];
                    outData.data[dIdx+2] = imgData.data[sIdx+2];
                    outData.data[dIdx+3] = 255;
                }
            }
        }
        ctx.putImageData(outData, 0, 0);
    });
}

// 탭 전환 함수(switchSimTab) 안에 아래 내용을 추가하세요
// if(tabId === 'premium') setTimeout(updatePremiumLens, 100);

</script>

<div id="reset-confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:11000; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:450px; border-radius:30px; padding:40px 30px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <div style="font-size:50px; margin-bottom:20px;">🔄</div>
        <h3 style="font-size:24px; color:#2c3e50; margin-bottom:15px; font-weight:900;">전체 초기화</h3>
        <p style="font-size:18px; color:#666; line-height:1.6; margin-bottom:35px;">
            모든 선택 항목(대상, 증상, 도수)을<br>처음 상태로 되돌릴까요?
        </p>
        
        <div style="display:flex; gap:15px;">
            <button onclick="closeResetModal()" style="flex:1; padding:25px; border-radius:20px; border:none; background:#eee; color:#666; font-size:20px; font-weight:900; cursor:pointer;">아니오</button>
            <button onclick="executeReset()" style="flex:1; padding:25px; border-radius:20px; border:none; background:#e67e22; color:white; font-size:20px; font-weight:900; cursor:pointer;">예</button>
        </div>
    </div>
</div>
</body>
</html>
